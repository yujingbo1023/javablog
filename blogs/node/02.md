---
title: 02-koa
date: 2028-12-15
sticky: 1
sidebar: 'auto'
tags:
 - node
categories:
 - node
---

## 一，koa框架

### 1，koa框架介绍

官方文档：https://koa.bootcss.com/

![1708330620056](./assets/1708330620056.png)

Koa 是一个新的 web 框架，由 Express 幕后的原班人马打造， 致力于成为 web 应用和 API 开发领域中的一个更小、更富有表现力、更健壮的基石。 通过利用 async 函数，Koa 帮你丢弃回调函数，并有力地增强错误处理。 Koa 并没有捆绑任何中间件， 而是提供了一套优雅的方法，帮助您快速而愉快地编写服务端应用程序。



使用步骤：

- 创建文件夹 studyKoa
- 进入文件夹，生成项目配置文件 npm init -y
- 安装koa: npm i koa@2.13.4 -S
- 在studyKoa文件夹下，创建 01-搭建koa服务器.js



操作如下：

![1708330848967](./assets/1708330848967.png)

创建一台服务器：

```js
const Koa = require('koa');
const app = new Koa();

// app.use表示使用中间件
app.use(async ctx => {
  ctx.body = 'Hello World';
});

app.listen(3000);
```



测试之：

![1708331068668](./assets/1708331068668.png)





### 2，中间件



写代码演示两个中间件，如下：

```js
const Koa = require('koa');
const app = new Koa();

app.use(async (ctx,next) => {
    console.log(1)
    // 上一个中间件不调用next,不会走下一个中间件
    next();
});

app.use(async (ctx,next) => {
  ctx.body = 'Hello World';
});

app.listen(3000);
```



![1708331314767](./assets/1708331314767.png)





看如下代码，为什么结果是 1 2 3，如下：

![1708331452504](./assets/1708331452504.png)



在koa中，中间的执行流程是遵循洋葱模型，如下：

![1708331495510](./assets/1708331495510.png)



看一下，官方代码：

```js
const Koa = require('koa');
const app = new Koa();

// logger  日志中间件
app.use(async (ctx, next) => {
  console.log(1)
  await next();
  console.log(5)
  const rt = ctx.response.get('X-Response-Time');
  console.log(`${ctx.method} ${ctx.url} - ${rt}`);
});

// x-response-time  计算当前请求所消耗的时间
app.use(async (ctx, next) => {
  const start = Date.now();
  console.log(2)
  await next();
  console.log(4)
  const ms = Date.now() - start;
  ctx.set('X-Response-Time', `${ms}ms`);
});

// response
app.use(async ctx => {
  console.log(3)
  ctx.body = 'Hello World';
});

app.listen(3000);
```

![1708331996713](./assets/1708331996713.png)



### 3，错误监听



 每次修改了服务器代码，都需要重新启动服务器，为了方便，可以全局安装nodemon。安装之：

```shell
npm i nodemon -g
```

![1708332259712](./assets/1708332259712.png)



后面再启动服务器，通过nodemon这个工具来启动，如下：

![1708332398566](./assets/1708332398566.png)





添加error全局事件侦听器，如下：

```js
const Koa = require('koa');
const app = new Koa();

app.use(async ctx => {
    throw new Error("未知错误~~~~")
});

// 全局错误处理  目前的处理仅仅是后台打印
app.on("error",err=>{
    console.log('全局错误处理', err.message)
})

app.listen(3000);
```



![1708332565854](./assets/1708332565854.png)





### 4，手写错误处理中间件（给客户端提示）



现在没有提示：

![1708332684841](./assets/1708332684841.png)

写一个中间件，给出提示：

```js
const Koa = require('koa');
const app = new Koa();

// 错误处理中间件
app.use(async (ctx,next) => {
    try{
        await next();
    }catch(error){
        // console.log(error.statusCode)
        // console.log(error.status)
        // 给⽤户显示状态码
        ctx.status = error.statusCode || error.status || 500;
        // 如果是ajax请求,返回的是json错误数据
        ctx.type = "json"
        ctx.body = {
            ok:0,
            message:error.message
        }
    }
})

app.use(async ctx => {
    throw new Error("未知错误~~~~")
});

// 全局错误处理 后台打印
app.on("error",err=>{
    console.log('全局错误处理', err.message)
})

app.listen(3000);
```

![1708333137427](./assets/1708333137427.png)



### 5，日志中间件之koa-logger

**安装：** npm i koa-logger@3.2.1

![1708333243009](./assets/1708333243009.png)

上代码演示：

```js
const Koa = require('koa');
const logger = require('koa-logger')

const app = new Koa();

// 使用中间件
app.use(logger())

app.use(async ctx => {
    ctx.body = "hello koa~"
});

// 全局错误处理 后台打印
app.on("error",err=>{
    console.log('全局错误处理', err.message)
})

app.listen(3000);
```

![1708333482636](./assets/1708333482636.png)



### 6，第三方错误处理中间件

**安装：** npm i koa-onerror@4.2.0

![1708333593507](./assets/1708333593507.png)



使用之：

```js
const Koa = require('koa');
const logger = require('koa-logger')
const onerror = require('koa-onerror')

const app = new Koa();

// 使用中间件
app.use(logger())
onerror(app)

app.use(async ctx => {
    // const err = new Error("未授权");
    // err.status = 401;
    // throw err;
    ctx.throw(401,"未授权")
});

// 全局错误处理 后台打印
app.on("error",err=>{
    console.log('全局错误处理', err.message)
})

app.listen(3000);
```



![1708333866041](./assets/1708333866041.png)









