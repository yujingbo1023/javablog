---
title: 26-Ant Design Pro
date: 2028-12-15
sticky: 1
sidebar: 'auto'
tags:
 - js
categories:
 - base
---

## 一，antd design pro介绍



### 1，相关链接

#### 1）学习antd pro相关的链接

umi Max : https://umijs.org/docs/max/introduce

![1712645249726](./assets/1712645249726.png)



antdesing pro : https://pro.ant.design/zh-CN/

![1712645316517](./assets/1712645316517.png)



点击预览：https://preview.pro.ant.design/dashboard/analysis

![1712645438550](./assets/1712645438550.png)



还可以参考：https://preview.pro.antdv.com/dashboard/workplace

![1712645706373](./assets/1712645706373.png)



点击开始试用： https://pro.ant.design/zh-CN/docs/overview

![1712645494733](./assets/1712645494733.png)



ProComponents : https://procomponents.ant.design/

![1712645816195](./assets/1712645816195.png)



antd : https://ant-design.antgroup.com/docs/react/introduce-cn?from=msidevs.net

![1712646034337](./assets/1712646034337.png)



#### 2）开源项目相关的链接

作者的github地址：https://github.com/newbee-ltd

![1712646130948](./assets/1712646130948.png)



APP： https://github.com/newbee-ltd/newbee-mall-vue3-app?tab=readme-ov-file

预览：http://47.99.134.126:5008/#/home

![1712646178549](./assets/1712646178549.png)



后台：https://github.com/newbee-ltd/vue3-admin

预览：http://vue3-admin.newbee.ltd/#/introduce    admin  123456

![1712646257716](./assets/1712646257716.png)





### 2，通过umi脚手架创建antd pro项目

创建项目：

![1712646445080](./assets/1712646445080.png)

![1712646547667](./assets/1712646547667.png)



启动项目：

![1712646667339](./assets/1712646667339.png)

![1712646718240](./assets/1712646718240.png)



使用vscode打开项目：

![1712646680905](./assets/1712646680905.png)

![1712646843643](./assets/1712646843643.png)



### 3，通过antd pro脚手架创建项目

![1712646969096](./assets/1712646969096.png)



安装脚手架：

![1712647031848](./assets/1712647031848.png)



创建项目：

![1712647177439](./assets/1712647177439.png)



安装依赖：

![1712647247550](./assets/1712647247550.png)



运行项目：

![1712647481424](./assets/1712647481424.png)

![1712647750320](./assets/1712647750320.png)

![1712647534321](./assets/1712647534321.png)

![1712647704955](./assets/1712647704955.png)









## 二，解读 antd pro源码



### 1，webpack配置

对于pro中的配置两块，一块是webpack的配置，一块是运行时配置

![1712649074634](./assets/1712649074634.png)



先研究webpack的配置：

```ts
import { defineConfig } from '@umijs/max';
import { join } from 'path';
import defaultSettings from './defaultSettings';
import routes from './routes';

const { REACT_APP_ENV = 'dev', NODE_ENV } = process.env;

export default defineConfig({
  //============== 在umi中作的一些配置  ===============
  // 打包后的文件会带个hash,处理浏览器缓存问题
  hash: true,
  // 配置浏览器的兼容性 
  targets: {
    ie: 11,
  },
  // 配置路由表 
  routes,
  // 问号传参时，可以通过query传参
  historyWithQuery: {},
  // 配置网站的标题
  title: 'XXX后台系统',
  // 配置路由模式
  history: {
    type: 'hash'
  },
  // 开发环境生成sourceMap，生成环境不生成sourceMap
  devtool: NODE_ENV === 'development' ? 'eval' : false,
  // 配置图片的打包方式,大于10KB,单独打包成一个图片,如果小于10KB,打包Base64
  inlineLimit: 10000,
  // 配置js的压缩方式
  jsMinifier: 'terser',
  jsMinifierOptions: {},
  // 配置打包后资源的导入路径 默认是/
  publicPath: NODE_ENV === 'development' ? "/" : "/abc/",
  // 配置代理解决跨域
  proxy: {
    '/api': {
      'target': 'http://jsonplaceholder.typicode.com/',
      'changeOrigin': true,
      'pathRewrite': { '^/api': '' },
    }
  },

  //============== 以下都是max的插件配置 ===============
  // {} 表示开始model
  model: {},
  initialState: {},
  layout: {
    locale: true,
    ...defaultSettings,
  },
  moment2dayjs: {
    preset: 'antd',
    plugins: ['duration'],
  },
  locale: {
    // default zh-CN
    default: 'zh-CN',
    antd: true,
    // default true, when it is true, will use `navigator.language` overwrite default
    baseNavigator: true,
  },
  antd: {},
  request: {},
  access: {},
  headScripts: [
    // 解决首次加载时白屏的问题
    { src: '/scripts/loading.js', async: true },
  ],

  //================ pro 插件配置 =================
  presets: ['umi-presets-pro'],
  openAPI: [
    {
      requestLibPath: "import { request } from '@umijs/max'",
      schemaPath: join(__dirname, 'oneapi.json'),
      mock: false,
    },
    {
      requestLibPath: "import { request } from '@umijs/max'",
      schemaPath: 'https://gw.alipayobjects.com/os/antfincdn/CA1dOm%2631B/openapi.json',
      projectName: 'swagger',
    },
  ],
  mfsu: {
    strategy: 'normal',
  },
  esbuildMinifyIIFE: true,
  requestRecord: {},



  //================ 其它配置 =================
  theme: {
    'root-entry-name': 'variable',
  },
  ignoreMomentLocale: true,
  fastRefresh: true,
});
```



defaultSettings.ts  默认的设置：

![1712651034837](./assets/1712651034837.png)



### 2，请求的二次封装

如果关闭mock，如下：

![1712652363455](./assets/1712652363455.png)

![1712652390312](./assets/1712652390312.png)



测试登录：

![1712652426198](./assets/1712652426198.png)



想把mock关闭，/weblcome就访问不了了。又想要访问后台首页面，操作：

![1712652992529](./assets/1712652992529.png)

![1712653331771](./assets/1712653331771.png)



测试之：

![1712653432556](./assets/1712653432556.png)

![1712653452019](./assets/1712653452019.png)



默认情况下，请求的二次封装，位置如下：

![1712653515182](./assets/1712653515182.png)

看一下，它里面封装的内容，我们不使用它的封装，我们自己写。

```ts
export const errorConfig: RequestConfig = {
  // 错误处理： umi@3 的错误处理方案。
  errorConfig: {
    // 错误抛出
    errorThrower: (res) => {
      const { success, data, errorCode, errorMessage, showType } =
        res as unknown as ResponseStructure;
      if (!success) {
        const error: any = new Error(errorMessage);
        error.name = 'BizError';
        error.info = { errorCode, errorMessage, showType, data };
        throw error; // 抛出自制的错误
      }
    },
    // 错误接收及处理
    errorHandler: (error: any, opts: any) => {
      if (opts?.skipErrorHandler) throw error;
      // 我们的 errorThrower 抛出的错误。
      if (error.name === 'BizError') {
        const errorInfo: ResponseStructure | undefined = error.info;
        if (errorInfo) {
          const { errorMessage, errorCode } = errorInfo;
          switch (errorInfo.showType) {
            case ErrorShowType.SILENT:
              // do nothing
              break;
            case ErrorShowType.WARN_MESSAGE:
              message.warning(errorMessage);
              break;
            case ErrorShowType.ERROR_MESSAGE:
              message.error(errorMessage);
              break;
            case ErrorShowType.NOTIFICATION:
              notification.open({
                description: errorMessage,
                message: errorCode,
              });
              break;
            case ErrorShowType.REDIRECT:
              // TODO: redirect
              break;
            default:
              message.error(errorMessage);
          }
        }
      } else if (error.response) {
        // Axios 的错误
        // 请求成功发出且服务器也响应了状态码，但状态代码超出了 2xx 的范围
        message.error(`Response status:${error.response.status}`);
      } else if (error.request) {
        // 请求已经成功发起，但没有收到响应
        // \`error.request\` 在浏览器中是 XMLHttpRequest 的实例，
        // 而在node.js中是 http.ClientRequest 的实例
        message.error('None response! Please retry.');
      } else {
        // 发送请求时出了点问题
        message.error('Request error, please retry.');
      }
    },
  },

  // 请求拦截器
  requestInterceptors: [
    (config: RequestOptions) => {
      // 拦截请求配置，进行个性化处理。
      const url = config?.url?.concat('?token = 123');
      return { ...config, url };
    },
  ],

  // 响应拦截器
  responseInterceptors: [
    (response) => {
      // 拦截响应数据，进行个性化处理
      const { data } = response as unknown as ResponseStructure;

      if (data?.success === false) {
        message.error('请求失败！');
      }
      return response;
    },
  ],
};
```





在app.tsx中使用到了上面的二次封装，如下：

![1712653600950](./assets/1712653600950.png)



直接在app.tsx中封装：

![1712654289307](./assets/1712654289307.png)



```tsx
export const request = {
  timeout:60000, // 超时处理，请求超过1分钟，就取消请求
  // 错误统一处理
  errorConfig:{
    // 错误接收及处理
    errorHandler(){
      message.error("网络繁忙，请稍后再试~")
    }
  },
  // 请求拦截器
  requestInterceptors:[
    (config) => {
      // 在请求拦截器中带个token(除了登录接口)
      const token = "xxx"
      if(token && config.url !== "/api/adminUser/login"){
        config.headers['token'] = token;
      }
      return config;
    },
  ],
  // 响应拦截器
  responseInterceptors:[
    // 不对响应的数据作数据
     (response) => {
        return response;
     }
  ]
};
```



可以把它的二次封装删除了：

![1712654435996](./assets/1712654435996.png)

![1712654545176](./assets/1712654545176.png)



### 3，分析运行时配置



运行时配置都在app.tsx中，如下：

```tsx
import { Footer, Question, SelectLang, AvatarDropdown, AvatarName } from '@/components';
import { LinkOutlined } from '@ant-design/icons';
import type { Settings as LayoutSettings } from '@ant-design/pro-components';
import { SettingDrawer } from '@ant-design/pro-components';
import type { RunTimeLayoutConfig } from '@umijs/max';
import { message, notification } from 'antd';
import { history, Link } from '@umijs/max';
import defaultSettings from '../config/defaultSettings';
import { currentUser as queryCurrentUser } from '@/services/ant-design-pro/api';
import React from 'react';
const isDev = process.env.NODE_ENV === 'development';
const loginPath = '/user/login';

// getInitialState 获取初始化状态
// 调用完getInitialState 得到一个对象
//   不是登录页面的路由:  { fetchUserInfo currentUser settings: defaultSettings, }
//   是登录页面的路由:  { fetchUserInfo settings: defaultSettings, }
// getInitialState这个方法,只有页面加载时(第一次访问)才会执行, 
// 如果你跳转的不是登录页面,就去调接口获取登录者的用户信息,存放到了initialState.currentUser
// 如果访问的是登录页,得到  { fetchUserInfo   settings: defaultSettings, }
export async function getInitialState() {
  console.log("66666666666666666666666666666666")
  // fetchUserInfo
  const fetchUserInfo = async () => {
    // 调用接口去获取用户信息（现在的接口是mock出来的，已经把mock关闭了）
    // try {
    //   const msg = await queryCurrentUser({
    //     skipErrorHandler: true,
    //   });
    //   return msg.data;  // msg.data 就是表示用户信息  {username:"malu",age:18,avatar:"xxxx",address:"xxx"}
    // } catch (error) {
    //   history.push(loginPath);
    // }
    // return undefined;
    return {
      username:"malu",age:18,avatar:"xxxx"
    }
  };
  // 如果不是登录页面，执行
  const { location } = history;
  // 访问的路径是 /welcome  /goods  /list   如果不是登录页面
  if (location.pathname !== loginPath) {
    // currentUser 用户信息  {username:"malu",age:18,avatar:"xxxx"}
    const currentUser = await fetchUserInfo();  // 调接口获取用户信息
    return {
      fetchUserInfo,  // 方法 
      currentUser,   //  {username:"malu",age:18,avatar:"xxxx"}
      settings: defaultSettings, 
    };
  }
  // 访问的是登录页面
  return {
    fetchUserInfo,
    settings: defaultSettings,
  };
}


// layout 
export const layout = ({ initialState, setInitialState }) => {
  return {
    // render是渲染的意思  Question问题的意思  SelectLang选择语言（国际化）
    // actionsRender 渲染的是顶部header 右边那一块的内容  先不要去看 Question 和 SelectLang
    actionsRender: () => [<Question key="doc" />, <SelectLang key="SelectLang" />],
    // avatar 头像的意思
    // initialState?.currentUser?.avatar  当前登录者的头像
    // <AvatarName /> 名字组件
    // AvatarDropdown  下拉菜单
    avatarProps: {
      src: initialState?.currentUser?.avatar,
      title: <AvatarName />,
      render: (_, avatarChildren) => {
        return <AvatarDropdown>{avatarChildren}</AvatarDropdown>;
      },
    },
    // 水印 把当前登录者的名字当成水印
    waterMarkProps: {
      content: initialState?.currentUser?.name,
    },
    // 渲染底部
    footerRender: () => <Footer />,
    // 路由变化时调用 onPageChange
    onPageChange: () => {
      const { location } = history;
      // 如果没有登录，重定向到 login
      // initialState 是初始化状态  currentUser是当前登录的用户信息
      // 当登录成功后，把当前登录者的用户信息存储到了initialState
      //  currentUser: {username:"malu",age:18,avatar:"xxxx",address:"xxx"}
      // 点击登录，调用了两个接口
      //     1）登录接口  
      //     2）获取用户信息  currentUser
      // const loginPath = '/user/login';
      // initialState里面没有用户信息 并且 你访问的不是/user/login(/welcome)
      if (!initialState?.currentUser && location.pathname !== loginPath) {
        // 跳转到 '/user/login'
        // history.push(loginPath);
      }
    },
    // 整个layout组件的背景图片
    bgLayoutImgList: [
      {
        src: 'https://mdn.alipayobjects.com/yuyan_qk0oxh/afts/img/D2LWSqNny4sAAAAAAAAAAAAAFl94AQBr',
        left: 85,
        bottom: 100,
        height: '303px',
      },
      {
        src: 'https://mdn.alipayobjects.com/yuyan_qk0oxh/afts/img/C2TWRpJpiC0AAAAAAAAAAAAAFl94AQBr',
        bottom: -68,
        right: -45,
        height: '303px',
      },
      {
        src: 'https://mdn.alipayobjects.com/yuyan_qk0oxh/afts/img/F6vSTbj8KpYAAAAAAAAAAAAAFl94AQBr',
        bottom: 0,
        left: 0,
        width: '331px',
      },
    ],
    // 如果是开发模式,就会在左下角显示一个连接
    links: isDev
      ? [
          <Link key="openapi" to="/umi/plugin/openapi" target="_blank">
            <LinkOutlined />
            <span>OpenAPI 文档</span>
          </Link>,
        ]
      : [],
    // 
    menuHeaderRender: undefined,
    // 自定义 403 页面
    // unAccessible   Accessible有权限的     unAccessible没有权限 
    // unAccessible: <div>unAccessible</div>,
    // 增加一个 loading 的状态   Drawer是抽屉的意思  SettingDrawer
    childrenRender: (children) => {
      // if (initialState?.loading) return <PageLoading />;
      return (
        <>
          {children}
          {isDev && (
            <SettingDrawer
              disableUrlParams
              enableDarkTheme
              settings={initialState?.settings}
              onSettingChange={(settings) => {
                setInitialState((preInitialState) => ({
                  ...preInitialState,
                  settings,
                }));
              }}
            />
          )}
        </>
      );
    },
    ...initialState?.settings,
  };
};


export const request = {
  timeout:60000, // 超时处理，请求超过1分钟，就取消请求
  // 错误统一处理
  errorConfig:{
    // 错误接收及处理
    errorHandler(){
      message.error("网络繁忙，请稍后再试~")
    }
  },
  // 请求拦截器
  requestInterceptors:[
    (config) => {
      // 在请求拦截器中带个token(除了登录接口)
      const token = "xxx"
      if(token && config.url !== "/api/adminUser/login"){
        config.headers['token'] = token;
      }
      return config;
    },
  ],
  // 响应拦截器
  responseInterceptors:[
    // 不对响应的数据作数据
     (response) => {
        return response;
     }
  ]
};
```



### 4，分析compoents中的组件

再删除一些内容：

![1712656398423](./assets/1712656398423.png)



分析access.ts，如下：

![1712656729558](./assets/1712656729558.png)

```ts
// export default function access(initialState: { currentUser?: API.CurrentUser } | undefined) {
//   const { currentUser } = initialState ?? {};
//   return {
//     canAdmin: currentUser && currentUser.access === 'admin',
//   };
// }

export default function access(initialState){
  const currentUser = initialState?.currentUser
  return {
    // { username:"malu",age:18,...  access: 'admin'}
    // canAdmin:true, 

    // { username:"malu",age:18,...  access: 'baoan'}
    // canAdmin:false
  }
}
```



components中封装了一些通用级别的组件：

![1712657035122](./assets/1712657035122.png)

![1712657116852](./assets/1712657116852.png)



components里面的组件，大家自行研究一下。



## 三，配置路由



### 1，分析路由

基于下面的模板进行配置：

![1712662139585](./assets/1712662139585.png)



把源码中的组件备份一下：

![1712662298077](./assets/1712662298077.png)



分析：

![1712662544426](./assets/1712662544426.png)





规划路由：

```
Dashboard   /dashboard
    /dashboard ===>  /dashboard/sysinfo
    系统介绍   /dashboard/sysinfo
    Dashboard   /dashboard/dashboard
    添加商品   /dashboard/addgoods
首页配置   /home
    /home ===>  /home/banner
    轮播图配置   /home/banner
    热销商品配置   /home/hotsale
    新品上线配置   /home/new
    为你推荐配置   /home/recommend
模块管理   /module
    /module ===>  /module/classify
    分类管理   /module/classify
    商品管理   /module/goods
    会员管理   /module/member
    订单管理   /module/order
系统管理   /sys
    /sys ===>  /sys/changepwd
    修改密码   /sys/changepwd
```



规划组件：

```
dashboard 
     SysInfo.jsx
     Dashboard.jsx
     AddGoods.jsx
home 
     Banner.jsx
     HotSale.jsx
     New.jsx
     Recommend.jsx
module 
     Classify.jsx
     Goods.jsx
     Member.jsx
     Order.jsx
sys
	 ChangePwd.jsx
```



组件的样子：

```jsx
import React from 'react';
import { PageContainer } from '@ant-design/pro-components';

const HotSale = () => {
  return (
    <PageContainer>
      <div>
        热销商品
      </div>
    </PageContainer>
  );
};

export default HotSale;
```



到此项目中的组件就创建完毕了：

![1712663697895](./assets/1712663697895.png)



### 2，配置路由



要使用图标，还需要安装图标：

```
pnpm install @ant-design/icons --save
```



就是配置路由表：

![1712665574512](./assets/1712665574512.png)

```ts
export default [
  {
    path: '/',
    redirect: '/dashboard/sysinfo'
  },
  {
    path: '/dashboard',
    name: 'Dashboard',
    icon: '',
    routes: [
      {
        path: '/dashboard',
        redirect: '/dashboard/sysinfo'
      },
      {
        path: '/dashboard/sysinfo',
        name: '系统介绍',
        icon: '',
        component: './dashboard/SysInfo'
      },
      {
        path: '/dashboard/dashboard',
        name: 'Dashboard',
        icon: '',
        component: './dashboard/Dashboard'
      },
      {
        path: '/dashboard/addgoods',
        name: '添加商品',
        icon: '',
        component: './dashboard/AddGoods'
      }
    ]
  }, {
    path: '/home',
    name: '首页配置',
    icon: '',
    routes: [
      {
        path: '/home',
        redirect: '/home/banner'
      },
      {
        path: '/home/banner',
        name: '轮播图配置',
        icon: '',
        component: './home/Banner'
      },
      {
        path: '/home/hotsale',
        name: '热销商品配置',
        icon: '',
        component: './home/HotSale'
      },
      {
        path: '/home/new',
        name: '新品上线配置',
        icon: '',
        component: './home/New'
      },
      {
        path: '/home/recommend',
        name: '为你推荐配置',
        icon: '',
        component: './home/Recommend'
      }
    ]
  }, {
    path: '/module',
    name: '模块管理',
    icon: '',
    routes: [
      {
        path: '/module',
        redirect: '/module/classify'
      },
      {
        path: '/module/classify',
        name: '分类管理',
        icon: '',
        component: './module/Classify'
      },
      {
        path: '/module/goods',
        name: '商品管理',
        icon: '',
        component: './module/Goods'
      },
      {
        path: '/module/member',
        name: '会员管理',
        icon: '',
        component: './module/Member'
      },
      {
        path: '/module/order',
        name: '订单管理',
        icon: '',
        component: './module/Order'
      }
    ]
  }, {
    path: '/sys',
    name: '系统管理',
    icon: '',
    routes: [
      {
        path: '/sys',
        redirect: '/sys/changepwd'
      },
      {
        path: '/sys/changepwd',
        name: '修改密码',
        icon: '',
        component: './sys/ChangePwd'
      }
    ]
  },
  {
    path: '/login',
    layout: false,
    component: 'Login',
  },
  {
    path: '*',
    layout: false,
    component: './404',
  },
];
```



效果如下：

![1712665652162](./assets/1712665652162.png)





















### 

