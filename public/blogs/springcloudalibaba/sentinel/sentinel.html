<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>04-sentinel | 码路全栈开发</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/javablog/public/favicon.ico">
    <meta name="description" content="快来玩java全栈呀">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/javablog/public/assets/css/0.styles.0bd56f36.css" as="style"><link rel="preload" href="/javablog/public/assets/js/app.9fb012c5.js" as="script"><link rel="preload" href="/javablog/public/assets/js/70.472f0f06.js" as="script"><link rel="preload" href="/javablog/public/assets/js/1.3c422ec2.js" as="script"><link rel="preload" href="/javablog/public/assets/js/30.768b62af.js" as="script"><link rel="prefetch" href="/javablog/public/assets/js/10.54ac7615.js"><link rel="prefetch" href="/javablog/public/assets/js/100.1b375586.js"><link rel="prefetch" href="/javablog/public/assets/js/101.5801941d.js"><link rel="prefetch" href="/javablog/public/assets/js/102.04da7766.js"><link rel="prefetch" href="/javablog/public/assets/js/103.42ea9feb.js"><link rel="prefetch" href="/javablog/public/assets/js/104.2be99fc4.js"><link rel="prefetch" href="/javablog/public/assets/js/105.533c3b17.js"><link rel="prefetch" href="/javablog/public/assets/js/106.871c50a5.js"><link rel="prefetch" href="/javablog/public/assets/js/107.bbc3ca37.js"><link rel="prefetch" href="/javablog/public/assets/js/108.b4730447.js"><link rel="prefetch" href="/javablog/public/assets/js/109.5c3f3917.js"><link rel="prefetch" href="/javablog/public/assets/js/11.0d269e2e.js"><link rel="prefetch" href="/javablog/public/assets/js/12.62b36cc7.js"><link rel="prefetch" href="/javablog/public/assets/js/13.807285bb.js"><link rel="prefetch" href="/javablog/public/assets/js/14.6e695de0.js"><link rel="prefetch" href="/javablog/public/assets/js/15.e472207a.js"><link rel="prefetch" href="/javablog/public/assets/js/16.5914c3ff.js"><link rel="prefetch" href="/javablog/public/assets/js/17.61701b2f.js"><link rel="prefetch" href="/javablog/public/assets/js/18.0654b84b.js"><link rel="prefetch" href="/javablog/public/assets/js/19.fb154731.js"><link rel="prefetch" href="/javablog/public/assets/js/20.f2bbb77b.js"><link rel="prefetch" href="/javablog/public/assets/js/21.727acbbf.js"><link rel="prefetch" href="/javablog/public/assets/js/22.41b8767c.js"><link rel="prefetch" href="/javablog/public/assets/js/23.95ca2ae1.js"><link rel="prefetch" href="/javablog/public/assets/js/24.bc61d966.js"><link rel="prefetch" href="/javablog/public/assets/js/25.c41bbc16.js"><link rel="prefetch" href="/javablog/public/assets/js/26.658794b6.js"><link rel="prefetch" href="/javablog/public/assets/js/27.5f816b42.js"><link rel="prefetch" href="/javablog/public/assets/js/28.e0b44b59.js"><link rel="prefetch" href="/javablog/public/assets/js/29.8ba02c6c.js"><link rel="prefetch" href="/javablog/public/assets/js/3.0532de61.js"><link rel="prefetch" href="/javablog/public/assets/js/31.a29a02ba.js"><link rel="prefetch" href="/javablog/public/assets/js/32.41b1ecb7.js"><link rel="prefetch" href="/javablog/public/assets/js/33.138810b2.js"><link rel="prefetch" href="/javablog/public/assets/js/34.0eef4899.js"><link rel="prefetch" href="/javablog/public/assets/js/35.77cfb81a.js"><link rel="prefetch" href="/javablog/public/assets/js/36.ebfe78e3.js"><link rel="prefetch" href="/javablog/public/assets/js/37.9aea0502.js"><link rel="prefetch" href="/javablog/public/assets/js/38.a8b0735a.js"><link rel="prefetch" href="/javablog/public/assets/js/39.c8c393bc.js"><link rel="prefetch" href="/javablog/public/assets/js/4.0f2e9aec.js"><link rel="prefetch" href="/javablog/public/assets/js/40.0b709423.js"><link rel="prefetch" href="/javablog/public/assets/js/41.dca9d34b.js"><link rel="prefetch" href="/javablog/public/assets/js/42.46760993.js"><link rel="prefetch" href="/javablog/public/assets/js/43.acf947b6.js"><link rel="prefetch" href="/javablog/public/assets/js/44.a1bd109d.js"><link rel="prefetch" href="/javablog/public/assets/js/45.9e6b8267.js"><link rel="prefetch" href="/javablog/public/assets/js/46.150fca67.js"><link rel="prefetch" href="/javablog/public/assets/js/47.dbb940af.js"><link rel="prefetch" href="/javablog/public/assets/js/48.4b4e9f93.js"><link rel="prefetch" href="/javablog/public/assets/js/49.328a5749.js"><link rel="prefetch" href="/javablog/public/assets/js/5.105b16f9.js"><link rel="prefetch" href="/javablog/public/assets/js/50.fe060963.js"><link rel="prefetch" href="/javablog/public/assets/js/51.42c36c9f.js"><link rel="prefetch" href="/javablog/public/assets/js/52.2919362b.js"><link rel="prefetch" href="/javablog/public/assets/js/53.252eba82.js"><link rel="prefetch" href="/javablog/public/assets/js/54.3bb1defd.js"><link rel="prefetch" href="/javablog/public/assets/js/55.ae41956a.js"><link rel="prefetch" href="/javablog/public/assets/js/56.553273ad.js"><link rel="prefetch" href="/javablog/public/assets/js/57.eae6bdd3.js"><link rel="prefetch" href="/javablog/public/assets/js/58.0ead9687.js"><link rel="prefetch" href="/javablog/public/assets/js/59.cfa19a58.js"><link rel="prefetch" href="/javablog/public/assets/js/6.98351776.js"><link rel="prefetch" href="/javablog/public/assets/js/60.fd773d8e.js"><link rel="prefetch" href="/javablog/public/assets/js/61.e57adf13.js"><link rel="prefetch" href="/javablog/public/assets/js/62.24564fdf.js"><link rel="prefetch" href="/javablog/public/assets/js/63.b69e1cab.js"><link rel="prefetch" href="/javablog/public/assets/js/64.0df39b80.js"><link rel="prefetch" href="/javablog/public/assets/js/65.a76dde7c.js"><link rel="prefetch" href="/javablog/public/assets/js/66.f7ef5947.js"><link rel="prefetch" href="/javablog/public/assets/js/67.5b794c64.js"><link rel="prefetch" href="/javablog/public/assets/js/68.1b392520.js"><link rel="prefetch" href="/javablog/public/assets/js/69.e84adcee.js"><link rel="prefetch" href="/javablog/public/assets/js/7.f0a80cc4.js"><link rel="prefetch" href="/javablog/public/assets/js/71.17cb7a4d.js"><link rel="prefetch" href="/javablog/public/assets/js/72.850d132d.js"><link rel="prefetch" href="/javablog/public/assets/js/73.654c1dc8.js"><link rel="prefetch" href="/javablog/public/assets/js/74.406b84e8.js"><link rel="prefetch" href="/javablog/public/assets/js/75.1de36245.js"><link rel="prefetch" href="/javablog/public/assets/js/76.03308e0e.js"><link rel="prefetch" href="/javablog/public/assets/js/77.45e9bca5.js"><link rel="prefetch" href="/javablog/public/assets/js/78.4f82ebe6.js"><link rel="prefetch" href="/javablog/public/assets/js/79.4a1d8233.js"><link rel="prefetch" href="/javablog/public/assets/js/8.23078fe4.js"><link rel="prefetch" href="/javablog/public/assets/js/80.f3012e3a.js"><link rel="prefetch" href="/javablog/public/assets/js/81.62255b8c.js"><link rel="prefetch" href="/javablog/public/assets/js/82.8724d8e1.js"><link rel="prefetch" href="/javablog/public/assets/js/83.dd1f8ff4.js"><link rel="prefetch" href="/javablog/public/assets/js/84.5abee652.js"><link rel="prefetch" href="/javablog/public/assets/js/85.ba97bd18.js"><link rel="prefetch" href="/javablog/public/assets/js/86.ebbbbde9.js"><link rel="prefetch" href="/javablog/public/assets/js/87.fe41be9a.js"><link rel="prefetch" href="/javablog/public/assets/js/88.cccd8e26.js"><link rel="prefetch" href="/javablog/public/assets/js/89.bd82ccd7.js"><link rel="prefetch" href="/javablog/public/assets/js/9.a62af30c.js"><link rel="prefetch" href="/javablog/public/assets/js/90.62348127.js"><link rel="prefetch" href="/javablog/public/assets/js/91.2d17adfb.js"><link rel="prefetch" href="/javablog/public/assets/js/92.7ef384b5.js"><link rel="prefetch" href="/javablog/public/assets/js/93.623e05a1.js"><link rel="prefetch" href="/javablog/public/assets/js/94.f7b0d0cf.js"><link rel="prefetch" href="/javablog/public/assets/js/95.6da713c9.js"><link rel="prefetch" href="/javablog/public/assets/js/96.32c6cbd6.js"><link rel="prefetch" href="/javablog/public/assets/js/97.8048ff56.js"><link rel="prefetch" href="/javablog/public/assets/js/98.c58d83f3.js"><link rel="prefetch" href="/javablog/public/assets/js/99.2c4e4670.js">
    <link rel="stylesheet" href="/javablog/public/assets/css/0.styles.0bd56f36.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>码路全栈开发</h3> <p class="description" data-v-59e6cb88>快来玩java全栈呀</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>码路</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/javablog/public/" class="home-link router-link-active"><img src="/javablog/public/logo.png" alt="码路全栈开发" class="logo"> <span class="site-name">码路全栈开发</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/javablog/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      全栈开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javase/" class="nav-link"><i class="undefined"></i>
  javase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/javablog/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/javablog/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/javablog/public/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    码路
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>99</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>26</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/javablog/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      全栈开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javase/" class="nav-link"><i class="undefined"></i>
  javase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/javablog/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/javablog/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>04-sentinel</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>码路</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">04-sentinel</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>码路</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2028</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>sentinel</span></i></div></div> <div class="theme-reco-content content__default"><h3 id="_1-认识分布式流量防护"><a href="#_1-认识分布式流量防护" class="header-anchor">#</a> 1, 认识分布式流量防护</h3> <p><img src="/javablog/public/assets/img/1717038176870.d8e1b347.png" alt="1717038176870"></p> <p>在分布式系统中，服务之间的相互调用会生成分布式流量。如何通过组件进行流量防护，并有效控制流量，是分布式系统的技术挑战之一。</p> <p><img src="/javablog/public/assets/img/1717038345718.bc01fb90.png" alt="1717038345718"></p> <p><strong>什么是服务雪崩：</strong></p> <p>假设我有一个微服务系统，这个系统内包含了 ABCD 四个微服务，这四个服务都是以集群模式构建的。</p> <p><img src="/javablog/public/assets/img/1717038022938.3068e92f.png" alt="1717038022938"></p> <p><strong>雪崩问题：</strong></p> <p>微服务之间相互调用，因为调用链中的一个服务故障，引起整个链路都无法访问的情况。</p> <p><strong>解决方案：</strong></p> <ul><li><p>超时机制</p></li> <li><p>舱壁模式</p></li> <li><p>熔断器</p></li> <li><p>流量控制</p></li></ul> <p><strong>服务保护技术：</strong></p> <ul><li>Hystrix</li> <li>Sentinel</li> <li>Resilience4J</li></ul> <p><strong>Sentinel 服务容错的思路：</strong></p> <p>Sentinel 是 Spring Cloud Alibaba 的⼀款服务容错组件，我们也经常把它叫做“防流量哨兵”。它是阿里巴巴双十一促核心场景的保护神，内置了丰富的服务容错应用场景。它以流 量作为切入点，通过各种内外防控手段达到维持服务稳定性的目的。</p> <p><strong>内部异常治理：</strong></p> <p>在 Sentinel 中，我们可以采用降级和熔断的方式处理内部的异常。 所谓降级，是指当服务调用发生了响应超时、服务异常等情况时，我们在服务内部可以执行一段“降级逻辑”。</p> <p><img src="/javablog/public/assets/img/1717038210022.70305b6d.png" alt="1717038210022"></p> <p>而所谓熔断，是指当异常调用量达到一定的判定条件，比如在异常降级和慢调用请求的比例达到⼀个阈值、窗口时间内降级请求达到⼀定数量的情况下，微服务在一段时间内停止对⽬标服务发起调用，所有来访请求直接执行降级逻辑。所以，熔断是“多次服务调用异常”累积的结果。</p> <p><img src="/javablog/public/assets/img/1717038246854.75fe4eb6.png" alt="1717038246854"></p> <p><strong>外部流量控制：</strong></p> <p>限流是流量整形流控方案的一种。在 Sentinel 中我们可以根据集群的处理能力，为每个服务设置⼀个限流规则，从 QPS 维度或者并发线程数的维度控制外部的访问流量。⼀旦访问量超过阈值，后续的请求就会被 “fast fail”，这是最为常用的⼀种限流手段。</p> <p><img src="/javablog/public/assets/img/1717038320081.295d03fe.png" alt="1717038320081"></p> <h3 id="_2-认识sentinel"><a href="#_2-认识sentinel" class="header-anchor">#</a> 2, 认识Sentinel</h3> <p>官网：https://sentinelguard.io/zh-cn/</p> <p><img src="/javablog/public/assets/img/1717038384151.0924af35.png" alt="1717038384151"></p> <p>Sentinel是阿里开源的项目，提供了流量控制、熔断降级、系统负载保护等多个维度来保障服务之间的稳定性。</p> <p><strong>Sentinel 的历史：</strong></p> <ul><li>2012 年，Sentinel 诞生，主要功能为入口流量控制。</li> <li>2013-2017 年，Sentinel 在阿里巴巴集团内部迅速发展，成为基础技术模块，覆盖了所有的核心场景。</li> <li>2018 年，Sentinel 开源，并持续演进。</li> <li>2019 年，Sentinel 朝着多语言扩展的方向不断探索，推出 <a href="https://github.com/alibaba/sentinel-cpp" target="_blank" rel="noopener noreferrer">C++ 原生版本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，同时针对 Service Mesh 场景也推出了 <a href="https://github.com/alibaba/Sentinel/tree/master/sentinel-cluster/sentinel-cluster-server-envoy-rls" target="_blank" rel="noopener noreferrer">Envoy 集群流量控制支持<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，以解决 Service Mesh 架构下多语言限流的问题。</li> <li>2020 年，推出 <a href="https://github.com/alibaba/sentinel-golang" target="_blank" rel="noopener noreferrer">Sentinel Go 版本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，继续朝着云原生方向演进。</li> <li>2021 年，Sentinel 正在朝着 2.0 云原生高可用决策中心组件进行演进；同时推出了 <a href="https://github.com/sentinel-group/sentinel-rust" target="_blank" rel="noopener noreferrer">Sentinel Rust 原生版本<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。同时我们也在 Rust 社区进行了 Envoy WASM extension 及 eBPF extension 等场景探索。</li> <li>2022 年，Sentinel 品牌升级为流量治理，领域涵盖流量路由/调度、流量染色、流控降级、过载保护/实例摘除等；同时社区将流量治理相关标准抽出到 <a href="https://opensergo.io/zh-cn/" target="_blank" rel="noopener noreferrer">OpenSergo 标准<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>中，Sentinel 作为流量治理标准实现。</li></ul> <p><strong>Sentinel 基本概念之资源：</strong></p> <p>资源是 Sentinel 的关键概念。它可以是 Java 应用程序中的任何内容，例如，由应用程序提供的服务，或由应用程序调用的其它应用提供的服务，甚至可以是一段代码。只要通过 Sentinel API 定义的代码，就是资源，能够被 Sentinel 保护起来。大部分情况下，可以使用方法签名，URL，甚至服务名称作为资源名来标示资源。</p> <p><strong>Sentinel 基本概念之规则：</strong></p> <p>围绕资源的实时状态设定的规则，可以包括流量控制规则、熔断降级规则以及系统保护规则。所有规则可以动态实时调整。</p> <p><strong>Sentinel 的主要特性：</strong></p> <p><img src="/javablog/public/assets/img/1717038652667.fae0a780.png" alt="1717038652667"></p> <p><strong>特性：</strong></p> <ul><li>丰富的应用场景：Sentinel 承接了阿里巴巴近 10 年的双十一大促流量的核心场景，例如秒杀(即突发流量控制在系统容量可以承受的范围)、消息削峰填谷、集群流量控制、实时熔断下游不可用应用等。</li> <li>完备的实时监控：Sentinel 同时提供实时的监控功能。您可以在控制台中看到接入应用的单台机器秒级数据，甚至 500 台以下规模的集群的汇总运行情况。</li> <li>广泛的开源生态：Sentinel 提供开箱即用的与其它开源框架/库的整合模块，例如与 Spring Cloud、Dubbo、gRPC 的整合。您只需要引入相应的依赖并进行简单的配置即可快速地接入 Sentinel。</li> <li>完善的 SPI 扩展点：Sentinel 提供简单易用、完善的 SPI 扩展接口。您可以通过实现扩展接口来快速地定制逻辑。例如定制规则管理、适配动态数据源等。</li></ul> <p><strong>Sentinel 分为两个部分：</strong></p> <ul><li>控制台（Dashboard）：Dashboard 主要负责管理推送规则、监控、管理机器信息等。</li> <li>核心库（Java 客户端）：不依赖任何框架/库，能够运行于 Java 8 及以上的版本的运行时环境，同时对 Dubbo / Spring Cloud 等框架也有较好的支持。</li></ul> <p>Sentinel 可以简单的分为 Sentinel 核心库和 Dashboard。核心库不依赖 Dashboard，但是结合 Dashboard 可以取得最好的效果。</p> <p><strong>Sentinel 的主要工作机制如下：</strong></p> <ul><li>对主流框架提供适配或者显示的 API，来定义需要保护的资源，并提供设施对资源进行实时统计和调用链路分析。</li> <li>根据预设的规则，结合对资源的实时统计信息，对流量进行控制。同时，Sentinel 提供开放的接口，方便您定义及改变规则。</li> <li>Sentinel 提供实时的监控系统，方便您快速了解目前系统的状态。</li></ul> <p><strong>Sentinel 与 Hystrix、resilience4j 的对比：</strong></p> <table><thead><tr><th>Sentinel</th> <th>Hystrix</th> <th>resilience4j</th> <th></th></tr></thead> <tbody><tr><td>隔离策略</td> <td>信号量隔离（并发线程数限流）</td> <td>线程池隔离/信号量隔离</td> <td>线程池隔离/信号量隔离</td></tr> <tr><td>熔断降级策略</td> <td>基于响应时间、异常比率、异常数</td> <td>基于异常比率</td> <td>基于异常比率、响应时间</td></tr> <tr><td>实时统计实现</td> <td>滑动窗口（LeapArray）</td> <td>滑动窗口（基于 RxJava）</td> <td>Ring Bit Buffer</td></tr> <tr><td>动态规则配置</td> <td>支持多种数据源</td> <td>支持多种数据源</td> <td>有限支持</td></tr> <tr><td>扩展性</td> <td>多个扩展点</td> <td>插件的形式</td> <td>接口的形式</td></tr> <tr><td>基于注解的支持</td> <td>支持</td> <td>支持</td> <td>支持</td></tr> <tr><td>限流</td> <td>基于 QPS，支持基于调用关系的限流</td> <td>有限的支持</td> <td>Rate Limiter</td></tr> <tr><td>流量整形</td> <td>支持预热模式、匀速器模式、预热排队模式</td> <td>不支持</td> <td>简单的 Rate Limiter 模式</td></tr> <tr><td>系统自适应保护</td> <td>支持</td> <td>不支持</td> <td>不支持</td></tr> <tr><td>控制台</td> <td>提供开箱即用的控制台，可配置规则、查看秒级监控、机器发现等</td> <td>简单的监控查看</td> <td>不提供控制台，可对接其它监控系统</td></tr></tbody></table> <h3 id="_3-安装sentinel控制台"><a href="#_3-安装sentinel控制台" class="header-anchor">#</a> 3, 安装Sentinel控制台</h3> <p>Sentinel 提供一个轻量级的开源控制台，它提供机器发现以及健康情况管理、监控（单机和集群），规则管理和推送的功能。</p> <p><strong>Sentinel 控制台包含如下功能：</strong></p> <ul><li><p>查看机器列表以及健康情况：收集 Sentinel 客户端发送的心跳包，用于判断机器是否在线。</p></li> <li><p>监控 (单机和集群聚合**)**：通过 Sentinel 客户端暴露的监控 API，定期拉取并且聚合应用监控信息，最终可以实现秒级的实时监控。</p></li> <li><p>规则管理和推送：统一管理推送规则。</p></li> <li><p>鉴权：生产环境中鉴权非常重要。这里每个开发者需要根据自己的实际情况进行定制。</p></li></ul> <p>注意：Sentinel 控制台目前仅支持单机部署。Sentinel 控制台项目提供 Sentinel 功能全集示例，不作为开箱即用的生产环境控制台，若希望在生产环境使用请根据<a href="https://github.com/alibaba/Sentinel/wiki/%E5%9C%A8%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E4%BD%BF%E7%94%A8-Sentinel" target="_blank" rel="noopener noreferrer">文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>自行进行定制和改造。</p> <p><strong>获取 Sentinel 控制台：</strong></p> <p>您可以从<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/Sentinel/releases<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>下载最新版本的控制台 jar 包。</p> <p><img src="/javablog/public/assets/img/1717038967908.a1d8c731.png" alt="1717038967908"></p> <p>把jar包扔到服务器上：</p> <p><img src="/javablog/public/assets/img/1717039165624.748c294d.png" alt="1717039165624"></p> <p>关掉网关：</p> <p><img src="/javablog/public/assets/img/1717039266189.5d0e5437.png" alt="1717039266189"></p> <p>**启动 Sentinel 控制台：**启动 Sentinel 控制台需要 JDK 版本为 1.8 及以上版本。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>#前台运行
java -Dserver.port=8081 -Dcsp.sentinel.dashboard.server=103.38.81.223:8081 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.6.jar

#后台运行
nohup java  -Dserver.port=8480 -Dcsp.sentinel.dashboard.server=103.38.81.223:8480 -Dproject.name=sentinel-dashboard -jar sentinel-dashboard-1.8.6.jar &gt;&gt; /opt/sentinel.log 2&gt;&amp;1 &amp;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="/javablog/public/assets/img/1717040108390.72b178fe.png" alt="1717040108390"></p> <p><strong>访问 Sentinel 控制台:</strong></p> <p>在浏览器输入http://103.38.81.223:8480/即可，登录用户名密码都是sentinel。</p> <p><img src="/javablog/public/assets/img/1717040128143.3bf8b560.png" alt="1717040128143"></p> <h3 id="_4-将应用接入sentinel"><a href="#_4-将应用接入sentinel" class="header-anchor">#</a> 4, 将应用接入Sentinel</h3> <p>创建新模块：</p> <p><img src="/javablog/public/assets/img/1717040935169.d1d636b1.png" alt="1717040935169"></p> <p>依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- nacos依赖包  --&gt;</span>
        <span class="token comment">&lt;!--&lt;dependency&gt;--&gt;</span>
        <span class="token comment">&lt;!--    &lt;groupId&gt;com.alibaba.cloud&lt;/groupId&gt;--&gt;</span>
        <span class="token comment">&lt;!--    &lt;artifactId&gt;spring-cloud-starter-alibaba-nacos-discovery&lt;/artifactId&gt;--&gt;</span>
        <span class="token comment">&lt;!--&lt;/dependency&gt;--&gt;</span>
        <span class="token comment">&lt;!-- sentinel依赖--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-starter-alibaba-sentinel<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!--借用监控开放端口--&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-actuator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>编写YML配置文件:</p> <p><img src="/javablog/public/assets/img/1717040528415.df0a2b6e.png" alt="1717040528415"></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8787</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment">#应用名字</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> payment<span class="token punctuation">-</span>sentinel
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token comment"># Sentinel 控制台地址</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 103.38.81.223<span class="token punctuation">:</span><span class="token number">8480</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>启动类：</p> <p><img src="/javablog/public/assets/img/1717040629285.06a8482e.png" alt="1717040629285"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentSentinelApplication</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">PaymentSentinelApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************ PaymentSentinelApplication 启动成功 **********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>编写controller:</p> <p><img src="/javablog/public/assets/img/1717040762735.bc0dd1ca.png" alt="1717040762735"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>controller</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">GetMapping</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>bind<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">RestController</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testA&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------------testA&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717040950347.984e2329.png" alt="1717040950347"></p> <p><img src="/javablog/public/assets/img/1717041007683.e4c6ca5b.png" alt="1717041007683"></p> <p>打包，扔到服务器上：</p> <p><img src="/javablog/public/assets/img/1717047269951.edf91bbf.png" alt="1717047269951"></p> <p>再测试：</p> <p><img src="/javablog/public/assets/img/1717047724905.77cb9ae4.png" alt="1717047724905"></p> <h3 id="_5-流量控制概述"><a href="#_5-流量控制概述" class="header-anchor">#</a> 5, 流量控制概述</h3> <p>监控应用流量的 QPS 或并发线程数，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性。</p> <p><img src="/javablog/public/assets/img/1717046685390.49f6222e.png" alt="1717046685390"></p> <p>流量控制有以下几个角度:</p> <ul><li>资源的调用关系：例如资源的调用链路，资源和资源之间的关系；</li> <li>运行指标：例如 QPS、线程池、系统负载等；</li> <li>控制的效果：例如直接限流、冷启动、排队等。</li></ul> <p>注意：Sentinel 的设计理念是让您自由选择控制的角度，并进行灵活组合，从而达到想要的效果。</p> <p><strong>流控规则：</strong></p> <p><img src="/javablog/public/assets/img/1717048028857.973c9ea9.png" alt="1717048028857"></p> <p><strong>参数：</strong></p> <ul><li><p><strong>资源名</strong>：其实就是我们请求的资源路径</p></li> <li><p><strong>针对来源</strong>：这个是此流控规则对应那些微服务进行流控管理，一般填写调用方的微服务名称，多个用&quot;,&quot;分割</p></li> <li><p><strong>阈值类型</strong>：一般有2中类型，QPS（每秒的最大请求数2）和线程数（并发线程数）</p></li> <li><p><strong>单机阈值</strong>：单机状态下的最大限制值</p></li> <li><p><strong>是否集群</strong>：根据实际情况选择</p></li></ul> <p><strong>流控模式：</strong></p> <p><img src="/javablog/public/assets/img/1717048212202.e18709dc.png" alt="1717048212202"></p> <p><strong>参数：</strong></p> <ul><li><strong>直接</strong>：直接作用于当前资源，如果访问压力大于某个阈值，后续请求将被直接拦下来；</li> <li><strong>关联</strong>：统计与当前资源相关的另一个资源，触发阈值时，对当前资源限流</li> <li><strong>链路</strong>：当指定链路上的访问量⼤于某个阈值时，对当前资源进⾏限流，这⾥的“指定链 路”是细化到 API 级别的限流维度。</li></ul> <p><strong>流控效果：</strong></p> <p><img src="/javablog/public/assets/img/1717048282382.31758ae9.png" alt="1717048282382"></p> <p><strong>参数：</strong></p> <ul><li><p><strong>快速失败</strong>：默认的流量控制方式，当QPS超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出<code>FlowException</code>。</p></li> <li><p><strong>Warm Up</strong>：即预热/冷启动方式。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过&quot;冷启动&quot;，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压。</p></li> <li><p><strong>排队等待</strong>：匀速排队方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法 。这种方式主要用于处理间隔性突发的流量。</p></li></ul> <h3 id="_6-流控模式之直接模式"><a href="#_6-流控模式之直接模式" class="header-anchor">#</a> 6, 流控模式之直接模式</h3> <p>当 QPS 超过某个阈值的时候，则采取措施进行流量控制。若使用除了直接拒绝之外的流量控制效果，则调用关系限流策略（strategy）会被忽略。</p> <p><img src="/javablog/public/assets/img/1717049085818.cf32a7fa.png" alt="1717049085818"></p> <p><img src="/javablog/public/assets/img/1717049111242.e67f96af.png" alt="1717049111242"></p> <p>表示1秒钟内查询1次就ok，若超过1次，就直接快速失败，报默认错误。</p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717049173154.a0603145.png" alt="1717049173154"></p> <h3 id="_7-流控模式之关联模式"><a href="#_7-流控模式之关联模式" class="header-anchor">#</a> 7, 流控模式之关联模式</h3> <p>当关联的资源达到阈值时，就限流自己。比如有两个接口，是存在竞争关系的，当请求1个接口时，会影响另一个接口的性能。定义如下两个接口：</p> <p><img src="/javablog/public/assets/img/1717049510151.b64605be.png" alt="1717049510151"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">//  /query和/update就存在竞争关系   当大量请求/update时，就会影响/query</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/query&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;订单内容&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/update&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;更新订单&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>打包，传到服务器上，如下：</p> <p><img src="/javablog/public/assets/img/1717049659295.a23355c1.png" alt="1717049659295"></p> <p>查看：</p> <p><img src="/javablog/public/assets/img/1717049764257.fb698d35.png" alt="1717049764257"></p> <p><img src="/javablog/public/assets/img/1717049788021.e4b7c259.png" alt="1717049788021"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717049867592.c82e705f.png" alt="1717049867592"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717050021807.99004bce.png" alt="1717050021807"></p> <h3 id="_8-流控模式之链路模式"><a href="#_8-流控模式之链路模式" class="header-anchor">#</a> 8, 流控模式之链路模式</h3> <p>链路流控模式指的是，当从某个接口过来的资源达到限流条件时，开启限流。它的功能有点类似于针对来源配置项，区别在于：<strong>针对来源是针对上级微服务，而链路流控是针对上级接口，也就是说它的粒度更细。</strong></p> <p><strong>配置示例</strong>：</p> <p>例如有两条请求链路：</p> <ul><li>/test1 --&gt; /common</li> <li>/test2 --&gt; /common</li></ul> <p>如果只希望统计从/test2进入到/common的请求，则可以这样配置：</p> <p><img src="/javablog/public/assets/img/1717051831920.27648bd8.png" alt="1717051831920"></p> <p>需求：有查询订单和创建订单业务，两者都需要查询商品。针对从查询订单进入到查询商品的请求统计，并设置限流。</p> <p><img src="/javablog/public/assets/img/1717051904005.0b983721.png" alt="1717051904005"></p> <p>添加订单：</p> <p><img src="/javablog/public/assets/img/1717052010683.1e941bb8.png" alt="1717052010683"></p> <p><img src="/javablog/public/assets/img/1717052226543.f5977137.png" alt="1717052226543"></p> <p>如果想让service中的方法，出现在簇点链路中，只需要添加一个注解（表示它是一个资源）：</p> <p><img src="/javablog/public/assets/img/1717052341697.9ada1740.png" alt="1717052341697"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;/goods&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;商品信息&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>在controller中注入：</p> <p><img src="/javablog/public/assets/img/1717052471371.1a61c043.png" alt="1717052471371"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">GoodsService</span> goodsService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testA&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------------testA&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/query&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goodsService<span class="token punctuation">.</span><span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;订单内容&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/update&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;更新订单&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/save&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>goodsService<span class="token punctuation">.</span><span class="token function">queryGoods</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;添加订单&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p>还需要做一个配置：</p> <p><img src="/javablog/public/assets/img/1717052551565.a91fa1c4.png" alt="1717052551565"></p> <p>重新打包，上线，部署：</p> <p><img src="/javablog/public/assets/img/1717052700562.13106b86.png" alt="1717052700562"></p> <p>查看：</p> <p><img src="/javablog/public/assets/img/1717052925934.e15e1323.png" alt="1717052925934"></p> <p><img src="/javablog/public/assets/img/1717053027702.181fe289.png" alt="1717053027702"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717053084370.f64c663d.png" alt="1717053084370"></p> <h3 id="_9-流控效果之预热"><a href="#_9-流控效果之预热" class="header-anchor">#</a> 9, 流控效果之预热</h3> <p>warm up也叫预热模式**，**是应对服务冷启动的一种方案。</p> <p><img src="/javablog/public/assets/img/1717062000546.996d307d.png" alt="1717062000546"></p> <p>QPS为10.刚刚启动时，大部分请求失败，成功的只有3个，说明QPS被限定在3，随着时间推移，成功比例越来越高。</p> <p>有如下接口：</p> <p><img src="/javablog/public/assets/img/1717062271101.4564bc9c.png" alt="1717062271101"></p> <p><img src="/javablog/public/assets/img/1717062334818.a6f91e1f.png" alt="1717062334818"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717062427848.c806cb40.png" alt="1717062427848"></p> <p><img src="/javablog/public/assets/img/1717062712035.229a8d0a.png" alt="1717062712035"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717062596036.5d341240.png" alt="1717062596036"></p> <p><img src="/javablog/public/assets/img/1717062842425.77d1ce89.png" alt="1717062842425"></p> <p><img src="/javablog/public/assets/img/1717062901312.36b313cd.png" alt="1717062901312"></p> <h3 id="_10-热点参数限流"><a href="#_10-热点参数限流" class="header-anchor">#</a> 10, 热点参数限流</h3> <p><strong>什么是热点：</strong></p> <p>热点即经常访问的数据。</p> <p><img src="/javablog/public/assets/img/1717062957599.a46266ab.png" alt="1717062957599"></p> <p><strong>例子：</strong></p> <ul><li><p>手机热点： 华为手机、苹果手机等</p></li> <li><p>化妆品热点： 迪奥口红、香奈儿香水等</p></li></ul> <p><strong>热点参数限流</strong>，给/findById这个资源添加热点参数限流，规则如下：</p> <ul><li>默认的热点参数规则是每1秒请求量不超过2</li> <li>给102这个参数设置例外：每1秒请求量不超过4</li> <li>给103这个参数设置例外：每1秒请求量不超过10</li></ul> <p>热点参数限流对默认的SpringMVC资源无效，需要利用@SentinelResource注解标记资源。</p> <p>再写一个接口：</p> <p><img src="/javablog/public/assets/img/1717063426243.d4626c41.png" alt="1717063426243"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/goods&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GoodsController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span><span class="token string">&quot;hot&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/getGoods&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">goods</span><span class="token punctuation">(</span><span class="token class-name">String</span> goodsName<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> goodsName<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>打包，上线，部署，如下：</p> <p><img src="/javablog/public/assets/img/1717063688044.f877ff6f.png" alt="1717063688044"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717063679706.a28f801c.png" alt="1717063679706"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717063826155.1ec2fcd4.png" alt="1717063826155"></p> <p><img src="/javablog/public/assets/img/1717063901679.830f3004.png" alt="1717063901679"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717063999199.c02334e6.png" alt="1717063999199"></p> <p><img src="/javablog/public/assets/img/1717064032226.61c96f7d.png" alt="1717064032226"></p> <h3 id="_11-线程隔离"><a href="#_11-线程隔离" class="header-anchor">#</a> 11, 线程隔离</h3> <p>限流是一种预防措施，虽然限流可以尽量避免因高并发而引起的服务故障，但服务还会因为其它原因而故障。而要将这些故障控制在一定范围，避免雪崩，就要靠<strong>线程隔离</strong>（舱壁模式）和<strong>熔断降级</strong>手段了。</p> <p><strong>线程隔离（舱壁模式）：</strong></p> <ul><li>线程池隔离</li> <li>信号量隔离（Sentinel默认采用）</li></ul> <p><img src="/javablog/public/assets/img/1717064174868.7c503c6d.png" alt="1717064174868"></p> <ul><li><strong>线程池隔离</strong>：给每个服务调用业务分配一个线程池，利用线程池本身实现隔离效果</li> <li><strong>信号量隔离</strong>：不创建线程池，而是计数器模式，记录业务使用的线程数量，达到信号量上限时，禁止新的请求。</li></ul> <p>在添加限流规则时，可以选择两种阈值类型：</p> <p><img src="/javablog/public/assets/img/1717064260574.c928d0df.png" alt="1717064260574"></p> <ul><li>QPS：每秒的请求数</li> <li>线程数：该资源能使用用的Tomcat线程数的最大值。也就是通过限制线程数量，实现线程隔离（舱壁模式）。</li></ul> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717064427361.4b7582a9.png" alt="1717064427361"></p> <p><img src="/javablog/public/assets/img/1717064436847.ba973a31.png" alt="1717064436847"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717064683724.258f3293.png" alt="1717064683724"></p> <h3 id="_12-熔断降级"><a href="#_12-熔断降级" class="header-anchor">#</a> 12, 熔断降级</h3> <p><img src="/javablog/public/assets/img/1717064751365.aac4d378.png" alt="1717064751365"></p> <p>熔断降级是解决雪崩问题的重要手段。其思路是由断路器统计服务调用的异常比例、慢请求比例，如果超出阈值则会熔断该服务。即拦截访问该服务的一切请求；而当服务恢复时，断路器会放行访问该服务的请求。</p> <p><strong>断路器控制熔断和放行是通过状态机来完成的：</strong></p> <p><img src="/javablog/public/assets/img/1717064722556.6764e133.png" alt="1717064722556"></p> <p><strong>状态机包括三个状态：</strong></p> <ul><li>closed：关闭状态，断路器放行所有请求，并开始统计异常比例、慢请求比例。超过阈值则切换到open状态</li> <li>open：打开状态，服务调用被熔断，访问被熔断服务的请求会被拒绝，快速失败，直接走降级逻辑。Open状态5秒后会进入half-open状态</li> <li>half-open：半开状态，放行一次请求，根据执行结果来判断接下来的操作。 请求成功：则切换到closed状态 请求失败：则切换到open状态</li></ul> <p><strong>熔断降级策略：</strong></p> <ul><li><p>慢调用：业务的响应时长（RT）大于指定时长的请求认定为慢调用请求。在指定时间内，如果请求数量超过设定的最小数量，慢调用比例大于设定的阈值，则触发熔断。</p></li> <li><p>异常比例、异常数：统计指定时间内的调用，如果调用次数超过指定请求数，并且出现异常的比例达到设定的比例阈值（或超过指定异常数），则触发熔断。</p></li></ul> <p><img src="/javablog/public/assets/img/1717064926252.704b50c1.png" alt="1717064926252"></p> <h3 id="_13-熔断降级之慢调用"><a href="#_13-熔断降级之慢调用" class="header-anchor">#</a> 13, 熔断降级之慢调用</h3> <p>平均响应时间当1s内持续进入5个请求，对应时刻的平均响应时间(秒级)均超过阈值，那么在接下的时间窗口之内，对这个方法的调用都会自动地熔断(抛出DegradeException )。</p> <p>新接口：</p> <p><img src="/javablog/public/assets/img/1717065070849.531edd82.png" alt="1717065070849"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testC&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testC</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">2000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------------testC&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>打包，上传，部署，测试：</p> <p><img src="/javablog/public/assets/img/1717065227797.593b7169.png" alt="1717065227797"></p> <p><img src="/javablog/public/assets/img/1717065285633.ef401673.png" alt="1717065285633"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717065488309.1878f842.png" alt="1717065488309"></p> <p>超过50ms的请求都会被认为是慢请求，当异常比例达到百分之40，断路器打开(保险丝跳闸)微服务不可用，保险丝跳闸断电了。过5秒钟由断路器又打开状态变为半开状态放一部分请求进来。</p> <p><img src="/javablog/public/assets/img/1717065496048.144269dc.png" alt="1717065496048"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717065631511.8287b495.png" alt="1717065631511"></p> <p><img src="/javablog/public/assets/img/1717065660711.61e62f9b.png" alt="1717065660711"></p> <h3 id="_14-熔断降级之异常比例"><a href="#_14-熔断降级之异常比例" class="header-anchor">#</a> 14, 熔断降级之异常比例</h3> <p>当资源每秒异常总数占通过量的比值超过阈值之后，资源进入降级状态。异常比率的阈值范围是 [0.0,1.0]。</p> <p>新建一个接口：</p> <p><img src="/javablog/public/assets/img/1717065788305.34037353.png" alt="1717065788305"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testD&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testD</span><span class="token punctuation">(</span><span class="token class-name">Integer</span> id<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;故意抛出异常，触发异常比例熔断&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------------testD&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>打包，部署：</p> <p><img src="/javablog/public/assets/img/1717065922921.c8ff6489.png" alt="1717065922921"></p> <p>测试：</p> <p><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAABDAAAAD2CAYAAAAganesAAAgAElEQVR4nO3df3BU5d338c9CYoKNDBkEA+qUMEgCo0PQMi3Og410KgkOt4poAugtN6FEB58KBE2cUqe9C/ckSiS22IKTWKpg4Kbyo5bsttY0bWY0ikDUCoHaJGMtYcJDExRMhJB9/tg9m/29+bWbS/J+zezI7jnnOt9d+ed8uK7vZevo6HAKw5rT6Qz4b6g/e/8XAAAAAIBYiRvqAjC0woUW3q+RI0cqISFBI0eO1IgRI2Sz2WSz2YaydAAAAADAMEKAMYyFCyycTqdsNpsSEhJ01VVXacSIEUNcLQAAAABgOCPAGKbCzbjo7u5WQkKCEhISCC4AAAAAAEYgwBiGvHtYeIcWTqdTcXFxSkpKIrgAAAAAABiFAGOYCTbrwju8+MY3vjHEFQIAAAAAEIgAYxgJF14kJCQoMTFxiCsEAAAAACA41gkMM8GadcbFxRFeAAAAAACMRoAxTHj3vbDeO51OjRgxgmUjAAAAAADjsYQkyj799FM1Nzdr9OjRmjJlipKSkgLO6ezs1Oeff67x48dHtZZgu42MHj06qvcEAAAAAGAwGDEDo6GhQatWrRrqMgbNP/7xD61atUo33nij0tLSNG/ePM2ePVvjxo3TrFmz9PTTT+uf//yn5/xf/epXys/Pj1o9wXYdsfpexHq3kcbGRj399NNav369mpqaYnrvK113d7e6u7uHugwAAAAAiIohDzAOHz6s733ve/rXv/411KUM2OXLl7V27Vrdcsst+vjjj7Vx40bV1dWpublZ586d04cffqh169bpnXfeUXp6uh577DF1dnbqwoULunDhQlRrs0IL6882m02jRo2K6j39Xbp0Sdu2bdO///1vnTlzRlu3btXly5djWgMAAAAA4OtpSJeQ/OUvf9H999+v73//+3rllVeGspQBO3funBYtWqS2tja99957uvnmmwPOuemmm3TTTTcpJydHDodDjz/+uHJycjRjxoyo1RWq90WswwtJqq6uVnt7u+d9e3u73nrrLd11110xr6U/9u3bJ0m67777BjROSUmJGhsb9dBDD2nOnDmDURoA09VXqLDyjDILipQd3dWCAAAAV6whCzCqqqqUm5urhx9+WFu2bJHNZhuqUgasu7tbS5cu1XXXXacDBw7o6quvjnhNVlaW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AQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjEeAAQAAAAAAjPf/AS8o4ephKgkWAAAAAElFTkSuQmCC" alt="1717065946258"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717066007476.6d0507b9.png" alt="1717066007476"></p> <p>在5次请求中，<strong>只要异常比例超过0.4，也就是有2次以上的异常，就会触发熔断</strong>。</p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717066068977.ec564fb2.png" alt="1717066068977"></p> <h3 id="_15-熔断降级之异常数"><a href="#_15-熔断降级之异常数" class="header-anchor">#</a> 15, 熔断降级之异常数</h3> <p>异常数：当资源近1分钟的异常数目超过阈值之后会进行熔断。</p> <p><img src="/javablog/public/assets/img/1717066176421.7bbf2447.png" alt="1717066176421"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/testF&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">int</span> age <span class="token operator">=</span> <span class="token number">10</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token string">&quot;------------testF&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>打包，部署：</p> <p><img src="/javablog/public/assets/img/1717066331524.b48f6843.png" alt="1717066331524"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717066343764.13aa4e6b.png" alt="1717066343764"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717066382665.1bc7f521.png" alt="1717066382665"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717066435412.cd68d52c.png" alt="1717066435412"></p> <h3 id="_16-授权规则"><a href="#_16-授权规则" class="header-anchor">#</a> 16, 授权规则</h3> <p>授权规则可以对调用方的来源做控制，有白名单和黑名单两种方式。</p> <ul><li>白名单：来源（origin）在白名单内的调用者允许访问</li> <li>黑名单：来源（origin）在黑名单内的调用者不允许访问</li></ul> <p>点击左侧菜单的授权，可以看到授权规则：</p> <p><img src="/javablog/public/assets/img/1717066498099.643e028a.png" alt="1717066498099"></p> <ul><li>资源名：就是受保护的资源，例如/payment/{query}</li> <li>流控应用：是来源者的名单，
<ul><li>如果是勾选白名单，则名单中的来源被许可访问。</li> <li>如果是勾选黑名单，则名单中的来源被禁止访问。</li></ul></li></ul> <p><img src="/javablog/public/assets/img/1717066529490.1d5f1f90.png" alt="1717066529490"></p> <p>我们允许请求从gateway到payment服务，不允许浏览器访问payment，那么白名单中就要填写<strong>网关的来源名称（origin）</strong>。</p> <p>打开网关：</p> <p><img src="/javablog/public/assets/img/1717066680064.8679a2c4.png" alt="1717066680064"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717066748834.806b29fb.png" alt="1717066748834"></p> <p>添加依赖：</p> <p><img src="/javablog/public/assets/img/1717066795978.6a697172.png" alt="1717066795978"></p> <p>配置：</p> <p><img src="/javablog/public/assets/img/1717066862966.e94d3155.png" alt="1717066862966"></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8787</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment">#应用名字</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> payment<span class="token punctuation">-</span>sentinel
  <span class="token key atrule">cloud</span><span class="token punctuation">:</span>
    <span class="token key atrule">nacos</span><span class="token punctuation">:</span>
      <span class="token key atrule">discovery</span><span class="token punctuation">:</span>
        <span class="token key atrule">server-addr</span><span class="token punctuation">:</span> 103.38.81.223<span class="token punctuation">:</span><span class="token number">8848</span>
    <span class="token key atrule">sentinel</span><span class="token punctuation">:</span>
      <span class="token key atrule">transport</span><span class="token punctuation">:</span>
        <span class="token comment"># Sentinel 控制台地址</span>
        <span class="token key atrule">dashboard</span><span class="token punctuation">:</span> 103.38.81.223<span class="token punctuation">:</span><span class="token number">8480</span>
      <span class="token comment"># 关闭context整合</span>
      <span class="token key atrule">web-context-unify</span><span class="token punctuation">:</span> <span class="token boolean important">false</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>添加接口：</p> <p><img src="/javablog/public/assets/img/1717066943648.23d43c8f.png" alt="1717066943648"></p> <p>根据origin来判断请求是从哪里过来的：</p> <p><img src="/javablog/public/assets/img/1717067095720.5375aed8.png" alt="1717067095720"></p> <p>从请求头中获取origin:</p> <p><img src="/javablog/public/assets/img/1717067034082.aff1f2ec.png" alt="1717067034082"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>adapter<span class="token punctuation">.</span>spring<span class="token punctuation">.</span>webmvc<span class="token punctuation">.</span>callback<span class="token punctuation">.</span></span><span class="token class-name">RequestOriginParser</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>nacos<span class="token punctuation">.</span>common<span class="token punctuation">.</span>utils<span class="token punctuation">.</span></span><span class="token class-name">StringUtils</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">jakarta<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token comment">// 从请求头中获取origin值</span>
<span class="token annotation punctuation">@Component</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">GetParseOrigin</span> <span class="token keyword">implements</span> <span class="token class-name">RequestOriginParser</span> <span class="token punctuation">{</span>


    <span class="token comment">/**
     * 从请求头中获取origin值
     * @param httpServletRequest
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">parseOrigin</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> httpServletRequest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> origin <span class="token operator">=</span> httpServletRequest<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;origin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            origin <span class="token operator">=</span> <span class="token string">&quot;blank&quot;</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> origin<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>这个方法的作用就是从request对象中，获取请求者的origin值并返回。默认情况下，sentinel不管请求者从哪里来，返回值永远是default，也就是说一切请求的来源都被认为是一样的值default。因此，我们需要自定义这个接口的实现，让不同的请求，返回不同的origin。</p> <p>项目打包，部署：</p> <p><img src="/javablog/public/assets/img/1717067340487.4fe314e8.png" alt="1717067340487"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717067358364.96842314.png" alt="1717067358364"></p> <p>添加授权规则：</p> <p><img src="/javablog/public/assets/img/1717067393121.976cd071.png" alt="1717067393121"></p> <p>再次测试：</p> <p><img src="/javablog/public/assets/img/1717067406709.2c3fe694.png" alt="1717067406709"></p> <p>打开网关：</p> <p><img src="/javablog/public/assets/img/1717067468480.9d507005.png" alt="1717067468480"></p> <p><img src="/javablog/public/assets/img/1717067495332.a47c6ad5.png" alt="1717067495332"></p> <p><img src="/javablog/public/assets/img/1717067517640.0ad66830.png" alt="1717067517640"></p> <p><img src="/javablog/public/assets/img/1717067560181.547f1cff.png" alt="1717067560181"></p> <p><img src="/javablog/public/assets/img/1717067613395.d4fa4671.png" alt="1717067613395"></p> <h3 id="_17-系统自适应限流"><a href="#_17-系统自适应限流" class="header-anchor">#</a> 17, 系统自适应限流</h3> <p><strong>引入系统自适应限流的主要的目的：</strong></p> <ul><li>保证系统不被拖垮</li> <li>在系统稳定的前提下保证系统的吞吐量。</li></ul> <p><strong>系统规则：</strong></p> <p>Sentinel的系统保护规则是从应用级别的入口流量进行控制，从单台机器的 load、CPU 使用率、平均 RT、入口 QPS 和并发线程数等几个维度监控应用指标，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p> <p><img src="/javablog/public/assets/img/1717067737709.96d39c40.png" alt="1717067737709"></p> <p>系统保护规则是应用整体维度的，而不是资源维度的，并且<strong>仅对入口流量生效</strong>。入口流量指的是进入应用的流量（<code>EntryType.IN</code>），比如 Web 服务或 Dubbo 服务端接收的请求，都属于入口流量。</p> <p><img src="/javablog/public/assets/img/1717067780089.0b937f93.png" alt="1717067780089"></p> <p><strong>系统规则支持以下的模式：</strong></p> <ul><li><strong>Load 自适应</strong>（仅对 Linux/Unix-like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统 load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 <code>maxQps * minRt</code> 估算得出。设定参考值一般是 <code>CPU cores * 2.5</code>。</li> <li><strong>CPU usage</strong>：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0-1.0），比较灵敏。</li> <li><strong>平均 RT</strong>：当单台机器上所有入口流量的平均 RT 达到阈值即触发系统保护，单位是毫秒。</li> <li><strong>并发线程数</strong>：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</li> <li><strong>入口 QPS</strong>：当单台机器上所有入口流量的 QPS 达到阈值即触发系统保护。</li></ul> <p><strong>查看cpu核数</strong></p> <blockquote><p>cat /proc/cpuinfo | grep &quot;processor&quot; | wc -l</p></blockquote> <h3 id="_18-sentinelresource注解配置详解之只配置fallback"><a href="#_18-sentinelresource注解配置详解之只配置fallback" class="header-anchor">#</a> 18, SentinelResource注解配置详解之只配置fallback</h3> <p>服务降级功能，但是只是限制后，返回不可控的结果肯定是不行的，我们还要保证调用者在调用那些被限制的服务时候，不管是不是被限制，都要让他们拿到一个合理的结果，而不是扔回去一个异常就完事了。</p> <p>Sentinel提供了这样的功能，让我们可以另外定义一个方法来代替被限制或异常服务返回数据，这就是<strong>fallback和blockHandler</strong>。</p> <ul><li>fallback：针对Java本身出现的异常进行处理的对应属性。</li> <li>blockHandler：针对违反Sentinel控制台配置规则时触发BlockException异常时对应处理的属性</li></ul> <p>@SentinelResource注解用于定义资源，并提供可选的 BlockException 异常处理（仅处理Sentinel控制台配置相关异常） 和 fallback 配置项（运行时异常以及自定义异常）。</p> <p><strong>注解属性:</strong></p> <ul><li><code>value</code>：资源名称，必需项（不能为空）</li> <li><code>entryType</code>：entry 类型，可选项（默认为 <code>EntryType.OUT</code>）</li> <li><code>blockHandler</code> / <code>blockHandlerClass</code>: <code>blockHandler</code> 对应处理 <code>BlockException</code> 的函数名称，可选项。blockHandler 函数访问范围需要是 <code>public</code>，返回类型需要与原方法相匹配，参数类型需要和原方法相匹配并且最后加一个额外的参数，类型为 <code>BlockException</code>。blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li> <li><code>fallback / fallbackClass</code> ：fallback 函数名称,可选项，通常用于通用的 fallback 逻辑（即可以用于很多服务或方法）。默认 fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。若同时配置了 fallback 和 defaultFallback，则只有 fallback 会生效。</li> <li><code>defaultFallback</code>（since 1.6.0）：默认的 fallback 函数名称</li> <li><code>exceptionsToIgnore</code>（since 1.6.0）：用于指定哪些异常被排除掉，不会计入异常统计中，也不会进入 fallback 逻辑中，而是会原样抛出。</li></ul> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717068004178.09b67f0b.png" alt="1717068004178"></p> <p><img src="/javablog/public/assets/img/1717068018324.4cd79bee.png" alt="1717068018324"></p> <p>上面的提示并不优雅。添加测试接口：</p> <p><img src="/javablog/public/assets/img/1717068359577.7b272817.png" alt="1717068359577"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testFallback&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">&quot;testFallback&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findById&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;出异常了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;支付信息&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 降级</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testFallback</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;系统异常了&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>打包，部署，测试：</p> <p><img src="/javablog/public/assets/img/1717068465441.c02fbae8.png" alt="1717068465441"></p> <p>浏览器测试：</p> <p><img src="/javablog/public/assets/img/1717068517587.d6f6eeb5.png" alt="1717068517587"></p> <p>之前显示的信息如下：</p> <p><img src="/javablog/public/assets/img/1717068534971.eaee819a.png" alt="1717068534971"></p> <p>fallback 函数位置是有要求的，必须和原方法在同一个类中，但在实际需求中，我们需要放在其他类中。@SentinelResource提供了<strong>通过fallbackClass指定对应的类的Class对象</strong>，添加一个static，否则无法解析。</p> <p><img src="/javablog/public/assets/img/1717068585479.b3bbf709.png" alt="1717068585479"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>fallback</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentFallback</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 降级方法
     * @param id
     * @param e
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;服务繁忙稍等一会~~~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>修改注解：</p> <p><img src="/javablog/public/assets/img/1717068760756.b63fcd1c.png" alt="1717068760756"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;testFallback&quot;</span><span class="token punctuation">,</span>fallbackClass <span class="token operator">=</span> <span class="token class-name">PaymentFallback</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">&quot;findById&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findById&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;出异常了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;支付信息&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_19-sentinelresource配置详解之只配置blockhandler"><a href="#_19-sentinelresource配置详解之只配置blockhandler" class="header-anchor">#</a> 19, SentinelResource配置详解之只配置blockHandler</h3> <p>超出流量限制的部分是否会进入到blockHandler的方法，要注意是超出流量限制的请求调用，会进入blockHandler方法。</p> <p>新建接口：</p> <p><img src="/javablog/public/assets/img/1717069305629.05846160.png" alt="1717069305629"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;block&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;testblockHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/block&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token string">&quot;支付信息&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">testblockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;限流降级处理，服务繁忙！&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>打包，部署，测试：</p> <p><img src="/javablog/public/assets/img/1717069401856.78f7d794.png" alt="1717069401856"></p> <p><img src="/javablog/public/assets/img/1717069445994.af6959bf.png" alt="1717069445994"></p> <p>配置熔断：</p> <p><img src="/javablog/public/assets/img/1717069490114.f14474cf.png" alt="1717069490114"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717070021161.41a83cd4.png" alt="1717070021161"></p> <p><img src="/javablog/public/assets/img/1717069954053.77729312.png" alt="1717069954053"></p> <p>外置类：</p> <p><img src="/javablog/public/assets/img/1717070112615.6dff9d25.png" alt="1717070112615"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>blockhandler</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>alibaba<span class="token punctuation">.</span>csp<span class="token punctuation">.</span>sentinel<span class="token punctuation">.</span>slots<span class="token punctuation">.</span>block<span class="token punctuation">.</span></span><span class="token class-name">BlockException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Service</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentBlockHandler</span> <span class="token punctuation">{</span>
    <span class="token comment">//处理sentinel熔断异常</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span>  <span class="token function">blockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">BlockException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;服务繁忙稍等一会~~~~&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>使用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;block&quot;</span><span class="token punctuation">,</span>blockHandlerClass <span class="token operator">=</span> <span class="token class-name">PaymentBlockHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/block&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span>  <span class="token function">block</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">&quot;block&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><strong>总结:</strong></p> <ul><li>流控的blockHandler自定义资源必须为public static 函数 @SentinelResource注解的value与@RequestMapping的value不一样</li> <li>流控规则配置的资源名与@SentinelResource注解的value保持一致，才会执行@SentinelResource注解里定义的兜底方法</li> <li>注意blockHandler 是对应处理 BlockException 的函数，而不是BlockedException</li></ul> <h3 id="_20-sentinelresource配置详解之fallback和blockhandler配置"><a href="#_20-sentinelresource配置详解之fallback和blockhandler配置" class="header-anchor">#</a> 20, SentinelResource配置详解之fallback和blockHandler配置</h3> <p>配置如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@SentinelResource</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token string">&quot;findByPaymenId&quot;</span><span class="token punctuation">,</span>fallback <span class="token operator">=</span> <span class="token string">&quot;fallbackHandler&quot;</span><span class="token punctuation">,</span>blockHandler <span class="token operator">=</span> <span class="token string">&quot;blockHandler&quot;</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;findByPaymenId&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">findByPaymenId</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>id <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token operator">/</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token string">&quot;支付记录查询成功&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理java异常</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">fallbackHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;处理java异常&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 处理sentienl 限流或者熔断</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">blockHandler</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">BlockException</span> e<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token string">&quot;处理sentienl&quot;</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p><strong>总结:</strong></p> <ul><li>fallback是针对方法出现异常了，则会进入fallback方法。</li> <li>blockhandler是针对流控设置，超出规则，则会进入blockhandler方法。</li> <li>blockHandler 和 fallback 都进行了配置，则被限流降级而抛出BlockException时只会进入 blockHandler 处理逻辑。</li> <li>若未配置 blockHandler、fallback 和 defaultFallback，则被限流降级时会将 BlockException 直接抛出。</li></ul></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">5/30/2024, 8:06:51 PM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_1-认识分布式流量防护" class="sidebar-link reco-side-_1-认识分布式流量防护" data-v-b57cc07c>1, 认识分布式流量防护</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_2-认识sentinel" class="sidebar-link reco-side-_2-认识sentinel" data-v-b57cc07c>2, 认识Sentinel</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_3-安装sentinel控制台" class="sidebar-link reco-side-_3-安装sentinel控制台" data-v-b57cc07c>3, 安装Sentinel控制台</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_4-将应用接入sentinel" class="sidebar-link reco-side-_4-将应用接入sentinel" data-v-b57cc07c>4, 将应用接入Sentinel</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_5-流量控制概述" class="sidebar-link reco-side-_5-流量控制概述" data-v-b57cc07c>5, 流量控制概述</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_6-流控模式之直接模式" class="sidebar-link reco-side-_6-流控模式之直接模式" data-v-b57cc07c>6, 流控模式之直接模式</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_7-流控模式之关联模式" class="sidebar-link reco-side-_7-流控模式之关联模式" data-v-b57cc07c>7, 流控模式之关联模式</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_8-流控模式之链路模式" class="sidebar-link reco-side-_8-流控模式之链路模式" data-v-b57cc07c>8, 流控模式之链路模式</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_9-流控效果之预热" class="sidebar-link reco-side-_9-流控效果之预热" data-v-b57cc07c>9, 流控效果之预热</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_10-热点参数限流" class="sidebar-link reco-side-_10-热点参数限流" data-v-b57cc07c>10, 热点参数限流</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_11-线程隔离" class="sidebar-link reco-side-_11-线程隔离" data-v-b57cc07c>11, 线程隔离</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_12-熔断降级" class="sidebar-link reco-side-_12-熔断降级" data-v-b57cc07c>12, 熔断降级</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_13-熔断降级之慢调用" class="sidebar-link reco-side-_13-熔断降级之慢调用" data-v-b57cc07c>13, 熔断降级之慢调用</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_14-熔断降级之异常比例" class="sidebar-link reco-side-_14-熔断降级之异常比例" data-v-b57cc07c>14, 熔断降级之异常比例</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_15-熔断降级之异常数" class="sidebar-link reco-side-_15-熔断降级之异常数" data-v-b57cc07c>15, 熔断降级之异常数</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_16-授权规则" class="sidebar-link reco-side-_16-授权规则" data-v-b57cc07c>16, 授权规则</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_17-系统自适应限流" class="sidebar-link reco-side-_17-系统自适应限流" data-v-b57cc07c>17, 系统自适应限流</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_18-sentinelresource注解配置详解之只配置fallback" class="sidebar-link reco-side-_18-sentinelresource注解配置详解之只配置fallback" data-v-b57cc07c>18, SentinelResource注解配置详解之只配置fallback</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_19-sentinelresource配置详解之只配置blockhandler" class="sidebar-link reco-side-_19-sentinelresource配置详解之只配置blockhandler" data-v-b57cc07c>19, SentinelResource配置详解之只配置blockHandler</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/springcloudalibaba/sentinel/sentinel.html#_20-sentinelresource配置详解之fallback和blockhandler配置" class="sidebar-link reco-side-_20-sentinelresource配置详解之fallback和blockhandler配置" data-v-b57cc07c>20, SentinelResource配置详解之fallback和blockHandler配置</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/javablog/public/assets/js/app.9fb012c5.js" defer></script><script src="/javablog/public/assets/js/70.472f0f06.js" defer></script><script src="/javablog/public/assets/js/1.3c422ec2.js" defer></script><script src="/javablog/public/assets/js/30.768b62af.js" defer></script>
  </body>
</html>
