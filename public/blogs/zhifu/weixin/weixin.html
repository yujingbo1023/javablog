<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>01-微信支付 | 码路全栈开发</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/javablog/public/favicon.ico">
    <meta name="description" content="快来玩java全栈呀">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/javablog/public/assets/css/0.styles.0bd56f36.css" as="style"><link rel="preload" href="/javablog/public/assets/js/app.e7970ae7.js" as="script"><link rel="preload" href="/javablog/public/assets/js/91.b7a84495.js" as="script"><link rel="preload" href="/javablog/public/assets/js/1.8cfd729d.js" as="script"><link rel="preload" href="/javablog/public/assets/js/16.dece7035.js" as="script"><link rel="prefetch" href="/javablog/public/assets/js/10.6bf09733.js"><link rel="prefetch" href="/javablog/public/assets/js/100.d72b93e5.js"><link rel="prefetch" href="/javablog/public/assets/js/101.bfcf98f4.js"><link rel="prefetch" href="/javablog/public/assets/js/102.5e96e7f3.js"><link rel="prefetch" href="/javablog/public/assets/js/103.1cd72481.js"><link rel="prefetch" href="/javablog/public/assets/js/104.c442255f.js"><link rel="prefetch" href="/javablog/public/assets/js/105.97c2f27d.js"><link rel="prefetch" href="/javablog/public/assets/js/106.5a53bc8c.js"><link rel="prefetch" href="/javablog/public/assets/js/107.f0c8fdd5.js"><link rel="prefetch" href="/javablog/public/assets/js/108.af90ee78.js"><link rel="prefetch" href="/javablog/public/assets/js/109.0f853f05.js"><link rel="prefetch" href="/javablog/public/assets/js/11.8a02f8bd.js"><link rel="prefetch" href="/javablog/public/assets/js/110.acc3d3b8.js"><link rel="prefetch" href="/javablog/public/assets/js/111.017368fd.js"><link rel="prefetch" href="/javablog/public/assets/js/112.b6791e4f.js"><link rel="prefetch" href="/javablog/public/assets/js/113.4e76b6c3.js"><link rel="prefetch" href="/javablog/public/assets/js/114.d3d3a9d8.js"><link rel="prefetch" href="/javablog/public/assets/js/115.550ffa33.js"><link rel="prefetch" href="/javablog/public/assets/js/116.a5dd78f5.js"><link rel="prefetch" href="/javablog/public/assets/js/117.c30e0a09.js"><link rel="prefetch" href="/javablog/public/assets/js/118.263eedf6.js"><link rel="prefetch" href="/javablog/public/assets/js/119.9a9f7fb5.js"><link rel="prefetch" href="/javablog/public/assets/js/12.cb27b9e2.js"><link rel="prefetch" href="/javablog/public/assets/js/120.79cc19b3.js"><link rel="prefetch" href="/javablog/public/assets/js/121.070d9e2a.js"><link rel="prefetch" href="/javablog/public/assets/js/122.596d374e.js"><link rel="prefetch" href="/javablog/public/assets/js/123.79fd23ee.js"><link rel="prefetch" href="/javablog/public/assets/js/124.0d11e0cd.js"><link rel="prefetch" href="/javablog/public/assets/js/125.04190ce7.js"><link rel="prefetch" href="/javablog/public/assets/js/126.2c208815.js"><link rel="prefetch" href="/javablog/public/assets/js/127.9a513caf.js"><link rel="prefetch" href="/javablog/public/assets/js/128.ea88757d.js"><link rel="prefetch" href="/javablog/public/assets/js/129.b647cdd0.js"><link rel="prefetch" href="/javablog/public/assets/js/13.b6ecc47e.js"><link rel="prefetch" href="/javablog/public/assets/js/130.da252088.js"><link rel="prefetch" href="/javablog/public/assets/js/131.ebc33e1d.js"><link rel="prefetch" href="/javablog/public/assets/js/132.e20990cd.js"><link rel="prefetch" href="/javablog/public/assets/js/133.3cd27609.js"><link rel="prefetch" href="/javablog/public/assets/js/134.1b266470.js"><link rel="prefetch" href="/javablog/public/assets/js/135.f1433ba0.js"><link rel="prefetch" href="/javablog/public/assets/js/136.f6c3b6ee.js"><link rel="prefetch" href="/javablog/public/assets/js/137.5bdc390e.js"><link rel="prefetch" href="/javablog/public/assets/js/138.2e253eab.js"><link rel="prefetch" href="/javablog/public/assets/js/139.f880188d.js"><link rel="prefetch" href="/javablog/public/assets/js/14.6aace181.js"><link rel="prefetch" href="/javablog/public/assets/js/140.435c0842.js"><link rel="prefetch" href="/javablog/public/assets/js/141.9d1bc96f.js"><link rel="prefetch" href="/javablog/public/assets/js/142.06470f8b.js"><link rel="prefetch" href="/javablog/public/assets/js/143.52cb8544.js"><link rel="prefetch" href="/javablog/public/assets/js/144.a2c92327.js"><link rel="prefetch" href="/javablog/public/assets/js/145.71f4ff26.js"><link rel="prefetch" href="/javablog/public/assets/js/146.6431fbc3.js"><link rel="prefetch" href="/javablog/public/assets/js/147.5d57fd89.js"><link rel="prefetch" href="/javablog/public/assets/js/148.80b9c111.js"><link rel="prefetch" href="/javablog/public/assets/js/149.013f1f55.js"><link rel="prefetch" href="/javablog/public/assets/js/15.0a32ef1c.js"><link rel="prefetch" href="/javablog/public/assets/js/150.a7bf6f11.js"><link rel="prefetch" href="/javablog/public/assets/js/151.97060f0a.js"><link rel="prefetch" href="/javablog/public/assets/js/152.9e3c6525.js"><link rel="prefetch" href="/javablog/public/assets/js/153.40d7b3e1.js"><link rel="prefetch" href="/javablog/public/assets/js/154.9aacdcab.js"><link rel="prefetch" href="/javablog/public/assets/js/155.ae0c2574.js"><link rel="prefetch" href="/javablog/public/assets/js/156.8717b494.js"><link rel="prefetch" href="/javablog/public/assets/js/157.1f00499c.js"><link rel="prefetch" href="/javablog/public/assets/js/158.7b52a3f1.js"><link rel="prefetch" href="/javablog/public/assets/js/159.1500e75a.js"><link rel="prefetch" href="/javablog/public/assets/js/160.32b9db8e.js"><link rel="prefetch" href="/javablog/public/assets/js/161.68f2d5f7.js"><link rel="prefetch" href="/javablog/public/assets/js/162.847501fb.js"><link rel="prefetch" href="/javablog/public/assets/js/163.ae44fe53.js"><link rel="prefetch" href="/javablog/public/assets/js/164.0f5077f0.js"><link rel="prefetch" href="/javablog/public/assets/js/165.18b9d4b0.js"><link rel="prefetch" href="/javablog/public/assets/js/166.3dd24fef.js"><link rel="prefetch" href="/javablog/public/assets/js/167.a2338bd6.js"><link rel="prefetch" href="/javablog/public/assets/js/168.4ad84db4.js"><link rel="prefetch" href="/javablog/public/assets/js/169.af424d2e.js"><link rel="prefetch" href="/javablog/public/assets/js/17.efdf1fb7.js"><link rel="prefetch" href="/javablog/public/assets/js/170.a56e8e4b.js"><link rel="prefetch" href="/javablog/public/assets/js/171.efc9119f.js"><link rel="prefetch" href="/javablog/public/assets/js/172.19cb6470.js"><link rel="prefetch" href="/javablog/public/assets/js/173.52603538.js"><link rel="prefetch" href="/javablog/public/assets/js/174.54dc826b.js"><link rel="prefetch" href="/javablog/public/assets/js/175.c9a500c6.js"><link rel="prefetch" href="/javablog/public/assets/js/176.aa57fba3.js"><link rel="prefetch" href="/javablog/public/assets/js/177.8f753609.js"><link rel="prefetch" href="/javablog/public/assets/js/18.8b6f8577.js"><link rel="prefetch" href="/javablog/public/assets/js/19.06aa8af0.js"><link rel="prefetch" href="/javablog/public/assets/js/20.b627ebf8.js"><link rel="prefetch" href="/javablog/public/assets/js/21.f64adcfc.js"><link rel="prefetch" href="/javablog/public/assets/js/22.29813aa6.js"><link rel="prefetch" href="/javablog/public/assets/js/23.3bd978d1.js"><link rel="prefetch" href="/javablog/public/assets/js/24.0777630a.js"><link rel="prefetch" href="/javablog/public/assets/js/25.e0249943.js"><link rel="prefetch" href="/javablog/public/assets/js/26.a3ab0578.js"><link rel="prefetch" href="/javablog/public/assets/js/27.c44ead5f.js"><link rel="prefetch" href="/javablog/public/assets/js/28.f6849bdc.js"><link rel="prefetch" href="/javablog/public/assets/js/29.db67f27a.js"><link rel="prefetch" href="/javablog/public/assets/js/3.8b779750.js"><link rel="prefetch" href="/javablog/public/assets/js/30.3a2c6eaa.js"><link rel="prefetch" href="/javablog/public/assets/js/31.176af05c.js"><link rel="prefetch" href="/javablog/public/assets/js/32.85f570b7.js"><link rel="prefetch" href="/javablog/public/assets/js/33.acf6303a.js"><link rel="prefetch" href="/javablog/public/assets/js/34.6c5e0a44.js"><link rel="prefetch" href="/javablog/public/assets/js/35.ee1c273e.js"><link rel="prefetch" href="/javablog/public/assets/js/36.a8e0cabd.js"><link rel="prefetch" href="/javablog/public/assets/js/37.25b8b93d.js"><link rel="prefetch" href="/javablog/public/assets/js/38.c56bd786.js"><link rel="prefetch" href="/javablog/public/assets/js/39.69f9d5ba.js"><link rel="prefetch" href="/javablog/public/assets/js/4.65c6fe12.js"><link rel="prefetch" href="/javablog/public/assets/js/40.aeeb0f16.js"><link rel="prefetch" href="/javablog/public/assets/js/41.66892695.js"><link rel="prefetch" href="/javablog/public/assets/js/42.3f23360c.js"><link rel="prefetch" href="/javablog/public/assets/js/43.db56edef.js"><link rel="prefetch" href="/javablog/public/assets/js/44.5133ca2a.js"><link rel="prefetch" href="/javablog/public/assets/js/45.9e01bafa.js"><link rel="prefetch" href="/javablog/public/assets/js/46.33bd736b.js"><link rel="prefetch" href="/javablog/public/assets/js/47.e8f56a8d.js"><link rel="prefetch" href="/javablog/public/assets/js/48.f9ac661b.js"><link rel="prefetch" href="/javablog/public/assets/js/49.0b79000b.js"><link rel="prefetch" href="/javablog/public/assets/js/5.95e5fdc8.js"><link rel="prefetch" href="/javablog/public/assets/js/50.d589eee0.js"><link rel="prefetch" href="/javablog/public/assets/js/51.2671d790.js"><link rel="prefetch" href="/javablog/public/assets/js/52.18a34b53.js"><link rel="prefetch" href="/javablog/public/assets/js/53.08eaaca8.js"><link rel="prefetch" href="/javablog/public/assets/js/54.07c319e7.js"><link rel="prefetch" href="/javablog/public/assets/js/55.1bf06790.js"><link rel="prefetch" href="/javablog/public/assets/js/56.8f219348.js"><link rel="prefetch" href="/javablog/public/assets/js/57.fb2ace21.js"><link rel="prefetch" href="/javablog/public/assets/js/58.a0ead3d2.js"><link rel="prefetch" href="/javablog/public/assets/js/59.3b98afc2.js"><link rel="prefetch" href="/javablog/public/assets/js/6.8fa998f6.js"><link rel="prefetch" href="/javablog/public/assets/js/60.fcc9d1a5.js"><link rel="prefetch" href="/javablog/public/assets/js/61.73eb43b4.js"><link rel="prefetch" href="/javablog/public/assets/js/62.79efaea7.js"><link rel="prefetch" href="/javablog/public/assets/js/63.d06ea46f.js"><link rel="prefetch" href="/javablog/public/assets/js/64.b9da3e0c.js"><link rel="prefetch" href="/javablog/public/assets/js/65.5aa9584c.js"><link rel="prefetch" href="/javablog/public/assets/js/66.d37dcd18.js"><link rel="prefetch" href="/javablog/public/assets/js/67.02cea56c.js"><link rel="prefetch" href="/javablog/public/assets/js/68.1b36888e.js"><link rel="prefetch" href="/javablog/public/assets/js/69.ee80b98b.js"><link rel="prefetch" href="/javablog/public/assets/js/7.d780c1cc.js"><link rel="prefetch" href="/javablog/public/assets/js/70.17fa67db.js"><link rel="prefetch" href="/javablog/public/assets/js/71.ea9b3fbb.js"><link rel="prefetch" href="/javablog/public/assets/js/72.310fc765.js"><link rel="prefetch" href="/javablog/public/assets/js/73.81db4691.js"><link rel="prefetch" href="/javablog/public/assets/js/74.4d50c2c3.js"><link rel="prefetch" href="/javablog/public/assets/js/75.51ee9d6b.js"><link rel="prefetch" href="/javablog/public/assets/js/76.608c20cd.js"><link rel="prefetch" href="/javablog/public/assets/js/77.5b3a1780.js"><link rel="prefetch" href="/javablog/public/assets/js/78.2b4bd2e6.js"><link rel="prefetch" href="/javablog/public/assets/js/79.ee3fe3a7.js"><link rel="prefetch" href="/javablog/public/assets/js/8.b4f2cb64.js"><link rel="prefetch" href="/javablog/public/assets/js/80.72c9f136.js"><link rel="prefetch" href="/javablog/public/assets/js/81.761f8dfb.js"><link rel="prefetch" href="/javablog/public/assets/js/82.f0c87c00.js"><link rel="prefetch" href="/javablog/public/assets/js/83.945e6197.js"><link rel="prefetch" href="/javablog/public/assets/js/84.e250c71d.js"><link rel="prefetch" href="/javablog/public/assets/js/85.0612371e.js"><link rel="prefetch" href="/javablog/public/assets/js/86.86374dfc.js"><link rel="prefetch" href="/javablog/public/assets/js/87.e69e1f60.js"><link rel="prefetch" href="/javablog/public/assets/js/88.b04c770b.js"><link rel="prefetch" href="/javablog/public/assets/js/89.588493e8.js"><link rel="prefetch" href="/javablog/public/assets/js/9.8fa54418.js"><link rel="prefetch" href="/javablog/public/assets/js/90.a6e72912.js"><link rel="prefetch" href="/javablog/public/assets/js/92.6a4985f5.js"><link rel="prefetch" href="/javablog/public/assets/js/93.4d9ebb2c.js"><link rel="prefetch" href="/javablog/public/assets/js/94.697f9c92.js"><link rel="prefetch" href="/javablog/public/assets/js/95.b79da481.js"><link rel="prefetch" href="/javablog/public/assets/js/96.9b8c9415.js"><link rel="prefetch" href="/javablog/public/assets/js/97.d545cae3.js"><link rel="prefetch" href="/javablog/public/assets/js/98.336720c2.js"><link rel="prefetch" href="/javablog/public/assets/js/99.b83d3155.js">
    <link rel="stylesheet" href="/javablog/public/assets/css/0.styles.0bd56f36.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>码路全栈开发</h3> <p class="description" data-v-59e6cb88>快来玩java全栈呀</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>码路</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/javablog/public/" class="home-link router-link-active"><img src="/javablog/public/logo.png" alt="码路全栈开发" class="logo"> <span class="site-name">码路全栈开发</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/javablog/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      全栈开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/javablog/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/javablog/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/javablog/public/avatar.png" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    码路
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>165</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>43</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/javablog/public/" class="nav-link"><i class="iconfont reco-home"></i>
  Home
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      全栈开发
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/categories/HarmonyOS/" class="nav-link"><i class="undefined"></i>
  HarmonyOS
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/base/" class="nav-link"><i class="undefined"></i>
  base
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/data analysis/" class="nav-link"><i class="undefined"></i>
  data analysis
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/devops/" class="nav-link"><i class="undefined"></i>
  devops
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/每日一题/" class="nav-link"><i class="undefined"></i>
  每日一题
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javabase/" class="nav-link"><i class="undefined"></i>
  javabase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/javaweb/" class="nav-link"><i class="undefined"></i>
  javaweb
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/linux/" class="nav-link"><i class="undefined"></i>
  linux
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/node/" class="nav-link"><i class="undefined"></i>
  node
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/pybase/" class="nav-link"><i class="undefined"></i>
  pybase
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/python/" class="nav-link"><i class="undefined"></i>
  python
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/spider/" class="nav-link"><i class="undefined"></i>
  spider
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/springcloud/" class="nav-link"><i class="undefined"></i>
  springcloud
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/springcloudalibaba/" class="nav-link"><i class="undefined"></i>
  springcloudalibaba
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/ssm/" class="nav-link"><i class="undefined"></i>
  ssm
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/storage/" class="nav-link"><i class="undefined"></i>
  storage
</a></li><li class="dropdown-item"><!----> <a href="/javablog/public/categories/zhifu/" class="nav-link"><i class="undefined"></i>
  zhifu
</a></li></ul></div></div><div class="nav-item"><a href="/javablog/public/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div><div class="nav-item"><a href="/javablog/public/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  TimeLine
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Docs
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/javablog/public/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>01-微信支付</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>码路</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">01-微信支付</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>码路</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>12/15/2028</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>支付</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="一-支付介绍与准备工作"><a href="#一-支付介绍与准备工作" class="header-anchor">#</a> 一，支付介绍与准备工作</h2> <h3 id="_1-产品介绍"><a href="#_1-产品介绍" class="header-anchor">#</a> 1, 产品介绍</h3> <p><img src="/javablog/public/assets/img/1717475039750.dbb5ba4e.png" alt="1717475039750"></p> <p><strong>微信支付介绍：</strong></p> <p>微信支付（<a href="https://pay.weixin.qq.com/" target="_blank" rel="noopener noreferrer">https://pay.weixin.qq.com<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）是腾讯集团旗下中国领先的第三方支付平台，一直致力于为用户和企业提供安全、便捷、专业的在线支付服务。</p> <p><strong>付款码支付：</strong></p> <p>付款码支付是指用户展示微信钱包内的“付款码”给商户系统扫描后直接完成支付，适用于线下场所面对面收银的场景，例如商超、便利店、餐饮、医院、学校、电影院和旅游景区等具有明确经营地址的实体场所。</p> <p><img src="/javablog/public/assets/img/1717475085523.bd3907f1.png" alt="1717475085523"></p> <p><strong>JSAPI支付：</strong></p> <p>JSAPI支付是指商户通过调用微信支付提供的JSAPI接口，在支付场景中调起微信支付模块完成收款。</p> <p><img src="/javablog/public/assets/img/1717475142862.dc3c4036.png" alt="1717475142862"></p> <p><strong>小程序支付：</strong></p> <p>小程序支付是指商户通过调用微信支付小程序支付接口，在微信小程序平台内实现支付功能；用户打开商家助手小程序下单，输入支付密码并完成支付后，返回商家小程序。</p> <p><img src="/javablog/public/assets/img/1717475176629.a54c4499.png" alt="1717475176629"></p> <p>**Native支付：**金额不能自定义</p> <p>Native支付是指商户系统按微信支付协议生成支付二维码，用户再用微信“扫一扫”完成支付的模式。该模式适用于PC网站、实体店单品或订单、媒体广告支付等场景。</p> <p><img src="/javablog/public/assets/img/1717475222598.9b3e7d2a.png" alt="1717475222598"></p> <p><strong>APP支付：</strong></p> <p>APP支付是指商户通过在移动端应用APP中集成开放SDK调起微信支付模块来完成支付。适用于在移动端APP中集成微信支付功能的场景。</p> <p><img src="/javablog/public/assets/img/1717475267585.eeeb830c.png" alt="1717475267585"></p> <p><strong>刷脸支付：</strong></p> <p>刷脸支付是指用户在刷脸设备前通过摄像头刷脸、识别身份后进行的一种支付方式，安全便捷。适用于线下实体场所的收银场景，如商超、餐饮、便利店、医院、学校等。</p> <p><img src="/javablog/public/assets/img/1717475300817.073464c8.png" alt="1717475300817"></p> <h3 id="_2-前期准备工作之获取商户号"><a href="#_2-前期准备工作之获取商户号" class="header-anchor">#</a> 2, 前期准备工作之获取商户号</h3> <p><strong>获取商户号：</strong></p> <p>微信商户平台：<a href="https://pay.weixin.qq.com/" target="_blank" rel="noopener noreferrer">https://pay.weixin.qq.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>场景：Native支付</p> <p><img src="/javablog/public/assets/img/1717475400554.74c5405d.png" alt="1717475400554"></p> <p>以我有PC网站为例：</p> <p><img src="/javablog/public/assets/img/1717475431051.4797aac8.png" alt="1717475431051"></p> <p>准备材料：</p> <p><img src="/javablog/public/assets/img/1717475467428.acda3827.png" alt="1717475467428"></p> <p><img src="/javablog/public/assets/img/1717475493260.571989b5.png" alt="1717475493260"></p> <p>获取商户号：</p> <p><img src="/javablog/public/assets/img/1717475705209.42ea1424.png" alt="1717475705209"></p> <h3 id="_3-前期准备工作之获取微信公众appid"><a href="#_3-前期准备工作之获取微信公众appid" class="header-anchor">#</a> 3, 前期准备工作之获取微信公众APPID</h3> <p><img src="/javablog/public/assets/img/1717475808595.7766550a.png" alt="1717475808595"></p> <p>登录公众号：</p> <p><img src="/javablog/public/assets/img/1717475877616.4ec23eda.png" alt="1717475877616"></p> <p>APPID：微信公众号 =》 开发管理 =》 开发设置 =》 获取AppID</p> <p><img src="/javablog/public/assets/img/1717475956527.7be08d6e.png" alt="1717475956527"></p> <p><img src="/javablog/public/assets/img/1717475993403.1c86f750.png" alt="1717475993403"></p> <h3 id="_4-前期准备工作之设置证书和密钥"><a href="#_4-前期准备工作之设置证书和密钥" class="header-anchor">#</a> 4, 前期准备工作之设置证书和密钥</h3> <p><img src="/javablog/public/assets/img/1717476343867.c761399f.png" alt="1717476343867"></p> <p>步骤一：</p> <p><img src="/javablog/public/assets/img/1717476440787.126a7563.png" alt="1717476440787"></p> <p>步骤二：</p> <p><img src="/javablog/public/assets/img/1717476605636.84f9965a.png" alt="1717476605636"></p> <p>步骤三：</p> <p><img src="/javablog/public/assets/img/1717476729423.271bbe4e.png" alt="1717476729423"></p> <p><img src="/javablog/public/assets/img/1717476748182.da48a21c.png" alt="1717476748182"></p> <p><img src="/javablog/public/assets/img/1717476777517.e8764a5a.png" alt="1717476777517"></p> <p><strong>注意：</strong></p> <ul><li>aplclient_cert.p12：包含了私钥信息得证书文件。</li> <li>apiclient_cert.pem：从apiclient_cert.p12中导出证书部分的文件，为pem格式，请妥善保管。</li> <li>apiclient_key.pem：部分开发语言和环境不能使用p12文件，需要使用pem文件为了方便，直接提供。</li></ul> <p><img src="/javablog/public/assets/img/1717476830225.10743b2a.png" alt="1717476830225"></p> <p><strong>获取API秘钥：</strong></p> <ul><li><p>APIv2版本的接口需要此秘钥</p></li> <li><p>步骤：登录商户平台 =&gt; 选择 账户中心 =&gt; 安全中心 =&gt; API安全 =&gt; 设置API密钥</p></li> <li><p>生成随机密码<a href="https://suijimimashengcheng.bmcx.com/" target="_blank" rel="noopener noreferrer">https://suijimimashengcheng.bmcx.com/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <p>步骤一：</p> <p><img src="/javablog/public/assets/img/1717476928833.5fcc4d9c.png" alt="1717476928833"></p> <p>步骤二：</p> <p><img src="/javablog/public/assets/img/1717476949665.40b4c7bb.png" alt="1717476949665"></p> <p>步骤三：</p> <p><img src="/javablog/public/assets/img/1717477002918.1188e778.png" alt="1717477002918"></p> <p><img src="/javablog/public/assets/img/1717476992734.e8581dec.png" alt="1717476992734"></p> <p><img src="/javablog/public/assets/img/1717477039593.36a52ba9.png" alt="1717477039593"></p> <p><img src="/javablog/public/assets/img/1717477064737.7c72c020.png" alt="1717477064737"></p> <p>商户号：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>1609462435
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>APIV3密钥：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>g38hhY10sXTuxy3lvBmCxIrJn3u1tc8r
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>证书ID：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>16753799746EDFD6916E0C7AADEB7114695F4BC5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>AppID:</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>wxa791a4ea3b1bb0a5
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><strong>注意：</strong></p> <p>以上所有API秘钥和证书需妥善保管防止泄露。</p> <h2 id="二-支付安全"><a href="#二-支付安全" class="header-anchor">#</a> 二，支付安全</h2> <h3 id="_1-信息安全的基础"><a href="#_1-信息安全的基础" class="header-anchor">#</a> 1, 信息安全的基础</h3> <p><strong>密码学基本概念:</strong></p> <p>密码学是网络安全、信息安全、区块链等产品的基础，常见的非对称加密、对称加密、散列函数等，都属于密码学范畴。</p> <p><strong>中国古代加密:</strong></p> <p>公元683年，唐中宗即位。随后，武则天废唐中宗，立第四子李旦为皇帝，但朝政大事均由她自己专断。裴炎、徐敬业和骆宾王等人对此非常不满。徐敬业聚兵十万，在江苏扬州起兵。裴炎做内应，欲以拆字手段为其传递秘密信息。后因有人告密，裴炎被捕，未发出的密信落到武则天手中。这封密信上只有“青鹅”二字，群臣对此大惑不解。</p> <p><img src="/javablog/public/assets/img/1717477213160.53bc43ec.png" alt="1717477213160"></p> <p><strong>破解：</strong></p> <p>武则天破解了“青鹅”的秘密：“青”字拆开来就是“十二月”，而“鹅”字拆开来就是“我自与”。密信的意思是让徐敬业、骆宾王等率兵于十二月进发，裴炎在内部接应。“青鹅”破译后，裴炎被杀。接着，武则天派兵击败了徐敬业和骆宾王。</p> <p>**明文：**加密前的消息叫“明文”（plain text）。</p> <p><img src="/javablog/public/assets/img/1717477247202.0af019a2.png" alt="1717477247202"></p> <p>**密文：**加密后的文本叫“密文”（cipher text）。</p> <p><img src="/javablog/public/assets/img/1717477279724.b2a53542.png" alt="1717477279724"></p> <p><strong>密钥：</strong></p> <p>只有掌握特殊“钥匙”的人，才能对加密的文本进行解密，这里的“钥匙”就叫做“密钥”（key）。</p> <p><img src="/javablog/public/assets/img/1717477298517.50eef1c8.png" alt="1717477298517"></p> <p><strong>加密算法：</strong></p> <ul><li>MD5信息摘要算法</li> <li>DES是对称性加密算法</li> <li>RSA是一种非对称加密算法</li></ul> <h3 id="_2-消息摘要"><a href="#_2-消息摘要" class="header-anchor">#</a> 2, 消息摘要</h3> <p>摘要算法就是我们常说的散列函数、哈希函数（Hash Function），它能够把任意长度的数据“压缩”成固定长度、而且独一无二的“摘要”字符串，就好像是给这段数据生成了一个数字“指纹”。</p> <p>百度搜索 <code>MySQL</code> ，进入官网下载 ，会经常发现有 <code>sha1</code>，<code>sha512</code> , 这些都是数字摘要。</p> <p><img src="/javablog/public/assets/img/1717477401567.c42385cd.png" alt="1717477401567"></p> <p><img src="/javablog/public/assets/img/1717477429495.877b1bef.png" alt="1717477429495"></p> <p><strong>作用</strong>：保证信息的完整性</p> <p><strong>特点：</strong></p> <ul><li>不可逆：只有算法，没有秘钥，只能加密，不能解密</li> <li>难题友好性：想要破解，只能暴力枚举</li> <li>发散性：只要对原文进行一点点改动，摘要就会发生剧烈变化抗</li> <li>碰撞性：原文不同，计算后的摘要也要不同</li></ul> <p><strong>常见算法：</strong></p> <ul><li>MD5</li> <li>SHA1</li> <li>SHA256</li> <li>SHA512</li></ul> <p>代码演示(jdk1.8)：</p> <p><img src="/javablog/public/assets/img/1717478473605.3382c521.png" alt="1717478473605"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">BASE64Encoder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">MessageDigest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * Hello world!
 *
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">App</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 原文  原文一样，摘要出来的摘要都是一样的</span>
        <span class="token class-name">String</span> input <span class="token operator">=</span> <span class="token string">&quot;ityls&quot;</span><span class="token punctuation">;</span>  <span class="token comment">// WBU8Kco4+y+KOKD0yjb0Kg==</span>
        <span class="token comment">// 算法</span>
        <span class="token class-name">String</span> algorithm <span class="token operator">=</span> <span class="token string">&quot;MD5&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取数字摘要对象</span>
        <span class="token class-name">MessageDigest</span> messageDigest <span class="token operator">=</span> <span class="token class-name">MessageDigest</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取消息数字摘要的字节数组</span>
        <span class="token comment">// degest打印乱码，加密后编码表找不到对应字符, 出现乱码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> digest <span class="token operator">=</span> messageDigest<span class="token punctuation">.</span><span class="token function">digest</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BASE64Encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>digest<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><h3 id="_3-对称加密"><a href="#_3-对称加密" class="header-anchor">#</a> 3, 对称加密</h3> <p><strong>对称加密：</strong></p> <p>对称加密指的就是加密和解密使用同一个秘钥，所以叫做对称加密。对称加密只有一个秘钥，作为私钥。</p> <p><strong>对称加密算法：</strong></p> <ul><li>DES（DES加密算法规定，密钥key必须是8个字节，key=&quot;12345678&quot;）</li> <li>AES</li> <li>3DES</li></ul> <p><strong>特点</strong></p> <ul><li>加密速度快, 可以加密大文件</li> <li>密文可逆, 一旦密钥文件泄漏, 就会导致数据暴露</li> <li>加密后编码表找不到对应字符, 出现乱码</li> <li>一般结合Base64使用</li></ul> <p>代码演示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>itbaizhan</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">BASE64Decoder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">sun<span class="token punctuation">.</span>misc<span class="token punctuation">.</span></span><span class="token class-name">BASE64Encoder</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">BadPaddingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Cipher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">IllegalBlockSizeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">NoSuchPaddingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">SecretKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeyException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">NoSuchAlgorithmException</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 对称加密 des
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DESdemo</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalBlockSizeException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">//原文</span>
        <span class="token class-name">String</span> input <span class="token operator">=</span> <span class="token string">&quot;ityls&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 私钥 秘钥</span>
        <span class="token class-name">String</span> key <span class="token operator">=</span> <span class="token string">&quot;12345678&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 算法</span>
        <span class="token class-name">String</span> algorithhm <span class="token operator">=</span> <span class="token string">&quot;DES&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">// 加密</span>
       <span class="token comment">// String s = encrypetDES(input, key, algorithhm);</span>
        <span class="token comment">// 密文：    JXHPxM7Xw6o=</span>
       <span class="token comment">// System.out.println(s);</span>

       <span class="token class-name">String</span> mi <span class="token operator">=</span> <span class="token string">&quot;JXHPxM7Xw6o=&quot;</span><span class="token punctuation">;</span>

        <span class="token comment">//解密</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token function">decryptDES</span><span class="token punctuation">(</span>mi<span class="token punctuation">,</span> key<span class="token punctuation">,</span> algorithhm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>

    <span class="token comment">// 加密</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span>  <span class="token function">encrypetDES</span><span class="token punctuation">(</span><span class="token class-name">String</span> input <span class="token punctuation">,</span><span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token class-name">String</span> algorithhm<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 获取对称加密对象</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithhm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建加密规则</span>
        <span class="token class-name">SecretKeySpec</span> sks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> algorithhm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化加密模式和算法</span>
        <span class="token comment">// ENCRYPT_MODE 加密模式</span>
        <span class="token comment">// DECRYPT_MODE 解密模式</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">ENCRYPT_MODE</span><span class="token punctuation">,</span>sks<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">BASE64Encoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BASE64Encoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> encoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>



    <span class="token comment">// 解密</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">String</span>  <span class="token function">decryptDES</span><span class="token punctuation">(</span><span class="token class-name">String</span> input <span class="token punctuation">,</span><span class="token class-name">String</span> key<span class="token punctuation">,</span><span class="token class-name">String</span> algorithhm<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 获取对称加密对象</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithhm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 创建加密规则</span>
        <span class="token class-name">SecretKeySpec</span> sks <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SecretKeySpec</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> algorithhm<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 初始化加密模式和算法</span>
        <span class="token comment">// ENCRYPT_MODE 加密模式</span>
        <span class="token comment">// DECRYPT_MODE 解密模式</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span>sks<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 加密</span>
        <span class="token comment">// 解码</span>
        <span class="token class-name">BASE64Decoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BASE64Decoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>encoder<span class="token punctuation">.</span><span class="token function">decodeBuffer</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 明文</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br></div></div><h3 id="_4-非对称加密之公钥加密和私钥解密"><a href="#_4-非对称加密之公钥加密和私钥解密" class="header-anchor">#</a> 4, 非对称加密之公钥加密和私钥解密</h3> <p><strong>非对称加密:</strong></p> <p>非对称加密指的是：加密和解密使用不同的秘钥，一把作为公开的公钥，另一把作为私钥。公钥加密的信息，只有私钥才能解密。私钥加密的信息，只有公钥才能解密。</p> <p><strong>非对称加密算法:</strong></p> <ul><li>RSA</li> <li>ECC</li></ul> <p><strong>特点:</strong></p> <ul><li>加密和解密使用不同的密钥</li> <li>如果使用私钥加密, 只能使用公钥解密</li> <li>如果使用公钥加密, 只能使用私钥解密</li> <li>处理数据的速度较慢, 因为安全级别高</li></ul> <p>依赖：</p> <p><img src="/javablog/public/assets/img/1717481794146.6ea94c8b.png" alt="1717481794146"></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>commons-io<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.6<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
 <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>代码演示：</p> <p><img src="/javablog/public/assets/img/1717482206301.2a9fc3d5.png" alt="1717482206301"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>sun<span class="token punctuation">.</span>org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>xerces<span class="token punctuation">.</span>internal<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>dv<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Base64</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>commons<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileUtils</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">BadPaddingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">Cipher</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">IllegalBlockSizeException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span></span><span class="token class-name">NoSuchPaddingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">File</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">Charset</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token operator">*</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">InvalidKeySpecException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">PKCS8EncodedKeySpec</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span>spec<span class="token punctuation">.</span></span><span class="token class-name">X509EncodedKeySpec</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 非对称加密  公钥  私钥
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RSAdemo</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeySpecException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchPaddingException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 原文</span>
        <span class="token class-name">String</span> input <span class="token operator">=</span> <span class="token string">&quot;ityls&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 加密算法</span>
        <span class="token class-name">String</span>  algorithm <span class="token operator">=</span> <span class="token string">&quot;RSA&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 生成密钥文件</span>
       <span class="token comment">// generateKey(algorithm,&quot;a.pub&quot;,&quot;a.pri&quot;);</span>
        <span class="token comment">// 公钥加密  -》  私钥解密</span>
        <span class="token comment">// 4. 获取公钥</span>
       <span class="token comment">// PublicKey publicKey = getPublicKey(&quot;a.pub&quot;, algorithm);</span>
       <span class="token comment">//  5. 加密</span>
       <span class="token comment">// String s = encryptRSA(input, publicKey, algorithm);</span>
       <span class="token comment">//  JANBpE4KAXcOmGjnVfMulnD4Q06PubPM269amF+vlBkPLvps6Kf1fYx6+S0Q8GBCdRubYw9X0PcVqJL7sZFJxvC699phwghayi+FK3UWFwu5vwD1GFa15eLyh/mugNfUXVyInONJHTt/8yaqUwhnPCk+6IAZJxNXH9NwnYU1zGs=</span>
       <span class="token comment">// System.out.println(s);</span>


        <span class="token comment">// 密文</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token string">&quot;JANBpE4KAXcOmGjnVfMulnD4Q06PubPM269amF+vlBkPLvps6Kf1fYx6+S0Q8GBCdRubYw9X0PcVqJL7sZFJxvC699phwghayi+FK3UWFwu5vwD1GFa15eLyh/mugNfUXVyInONJHTt/8yaqUwhnPCk+6IAZJxNXH9NwnYU1zGs=&quot;</span><span class="token punctuation">;</span>
        <span class="token comment">// 读取私钥</span>
        <span class="token class-name">PrivateKey</span> privatKey <span class="token operator">=</span> <span class="token function">getPrivatKey</span><span class="token punctuation">(</span><span class="token string">&quot;a.pri&quot;</span><span class="token punctuation">,</span> algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 解密</span>
        <span class="token class-name">String</span> s1 <span class="token operator">=</span> <span class="token function">decryptRSA</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> privatKey<span class="token punctuation">,</span> algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>s1<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 生成秘钥
     * @param algorithm 算法
     * @param pubPath 公钥保存路径
     * @param priPath 私钥保存路径
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span>  <span class="token keyword">void</span> <span class="token function">generateKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> algorithm<span class="token punctuation">,</span><span class="token class-name">String</span> pubPath<span class="token punctuation">,</span><span class="token class-name">String</span> priPath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取密钥生成器</span>
        <span class="token class-name">KeyPairGenerator</span> keyPairGenerator <span class="token operator">=</span> <span class="token class-name">KeyPairGenerator</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取密钥对</span>
        <span class="token class-name">KeyPair</span> keyPair <span class="token operator">=</span> keyPairGenerator<span class="token punctuation">.</span><span class="token function">generateKeyPair</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取公钥</span>
        <span class="token class-name">PublicKey</span> publicKey <span class="token operator">=</span> keyPair<span class="token punctuation">.</span><span class="token function">getPublic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 获取私钥</span>
        <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> keyPair<span class="token punctuation">.</span><span class="token function">getPrivate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 获取byte数组</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> publicKeyEncoded <span class="token operator">=</span> publicKey<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> privateKeyEncoded <span class="token operator">=</span> privateKey<span class="token punctuation">.</span><span class="token function">getEncoded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 编码BASE64编码</span>
        <span class="token class-name">String</span> publicKeyString <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>publicKeyEncoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> privateKeyString <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>privateKeyEncoded<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7. 保存文件</span>
        <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">writeStringToFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>pubPath<span class="token punctuation">)</span><span class="token punctuation">,</span>publicKeyString<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">writeStringToFile</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>priPath<span class="token punctuation">)</span><span class="token punctuation">,</span>privateKeyString<span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 读取公钥文件
     * @param publicPath
     * @param algorithm
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PublicKey</span> <span class="token function">getPublicKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> publicPath<span class="token punctuation">,</span><span class="token class-name">String</span> algorithm<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeySpecException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 读取文件</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">readFileToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>publicPath<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取密钥工厂</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 构建秘钥规范</span>
        <span class="token class-name">X509EncodedKeySpec</span> x509EncodedKeySpec <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">X509EncodedKeySpec</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePublic</span><span class="token punctuation">(</span>x509EncodedKeySpec<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 读取私钥文件
     * @param PrivatPath 私钥路径
     * @param algorithm 算法
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PrivateKey</span> <span class="token function">getPrivatKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> <span class="token class-name">PrivatPath</span><span class="token punctuation">,</span><span class="token class-name">String</span> algorithm<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeySpecException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 读取文件</span>
        <span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">readFileToString</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token class-name">PrivatPath</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Charset</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span><span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取密钥工厂</span>
        <span class="token class-name">KeyFactory</span> keyFactory <span class="token operator">=</span> <span class="token class-name">KeyFactory</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 构建秘钥规范</span>
        <span class="token class-name">PKCS8EncodedKeySpec</span> pes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PKCS8EncodedKeySpec</span><span class="token punctuation">(</span><span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> keyFactory<span class="token punctuation">.</span><span class="token function">generatePrivate</span><span class="token punctuation">(</span>pes<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 加密
     * @param input 原文
     * @param key 密钥
     * @param algorithm 算法
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">encryptRSA</span><span class="token punctuation">(</span><span class="token class-name">String</span> input<span class="token punctuation">,</span><span class="token class-name">Key</span> key<span class="token punctuation">,</span><span class="token class-name">String</span> algorithm<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建加密对象</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 初始化加密</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">ENCRYPT_MODE</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 公钥加密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>input<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 解密
     * @param input 原文
     * @param key 密钥
     * @param algorithm 算法
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">decryptRSA</span><span class="token punctuation">(</span><span class="token class-name">String</span> input<span class="token punctuation">,</span><span class="token class-name">Key</span> key<span class="token punctuation">,</span><span class="token class-name">String</span> algorithm<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">NoSuchPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">NoSuchAlgorithmException</span><span class="token punctuation">,</span> <span class="token class-name">InvalidKeyException</span><span class="token punctuation">,</span> <span class="token class-name">BadPaddingException</span><span class="token punctuation">,</span> <span class="token class-name">IllegalBlockSizeException</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 创建加密对象</span>
        <span class="token class-name">Cipher</span> cipher <span class="token operator">=</span> <span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 初始化加密</span>
        cipher<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">Cipher</span><span class="token punctuation">.</span><span class="token constant">DECRYPT_MODE</span><span class="token punctuation">,</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 由于密文base64编码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> decode <span class="token operator">=</span> <span class="token class-name">Base64</span><span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 对密文解密</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> cipher<span class="token punctuation">.</span><span class="token function">doFinal</span><span class="token punctuation">(</span>decode<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br></div></div><h3 id="_6-数字签名"><a href="#_6-数字签名" class="header-anchor">#</a> 6, 数字签名</h3> <p><img src="/javablog/public/assets/img/1717482289157.ad34c2f2.png" alt="1717482289157"></p> <p><strong>数字签名是什么：</strong></p> <p>数字签名（又称公钥数字签名）是只有信息的发送者才能产生的别人无法伪造的一段数字串，这段数字串同时也是对信息的发送者发送信息真实性的一个有效证明。数字签名是非对称密钥加密技术与数字摘要技术的应用。</p> <p><strong>生活中的数据签名：</strong></p> <p>相信我们都写过信，在写信的时候落款处总是要留下自己的名字，用来表示写信的人是谁。我们签的这个字就是生活中的签名。</p> <p><img src="/javablog/public/assets/img/1717482331808.b46ea4e3.png" alt="1717482331808"></p> <p><strong>注意:</strong></p> <p>在网络中传输数据时候，给数据添加一个数字签名，表示是谁发的数据，而且还能证明数据没有被篡改。OK，数字签名的主要作用就是保证了数据的有效性（验证是谁发的）和完整性（证明信息没有被篡改）。</p> <p><strong>基本原理：</strong></p> <p><img src="/javablog/public/assets/img/1717482378015.5f75e560.png" alt="1717482378015"></p> <p>张三有两把钥匙，一把是公钥，另一把是私钥。张三把公钥送给他的朋友们----铁蛋、幺妹、李四----每人一把。</p> <p><img src="/javablog/public/assets/img/1717482398511.d8394cb3.png" alt="1717482398511"></p> <p>幺妹要给张三写一封保密的信。她写完后用张三的公钥加密，就可以达到保密的效果。</p> <p><img src="/javablog/public/assets/img/1717482422216.341016d4.png" alt="1717482422216"></p> <p>张三收信后，用私钥解密，就看到了信件内容。这里要强调的是，只要张三的私钥不泄露，这封信就是安全的，即使落在别人手里，也无法解密。</p> <p><img src="/javablog/public/assets/img/1717482479627.b8e4ce59.png" alt="1717482479627"></p> <p>张三给幺妹回信，决定采用&quot;数字签名&quot;。他写完后先用Hash函数，生成信件的摘要（digest）。</p> <p><img src="/javablog/public/assets/img/1717482584985.de9f52ac.png" alt="1717482584985"></p> <p>张三使用私钥，对这个摘要加密，生成&quot;数字签名&quot;（signature）。幺妹收信后，取下数字签名，用张三的公钥解密，得到信件的摘要。由此证明，这封信确实是张三发出的。幺妹再对信件本身使用Hash函数，将得到的结果，与上一步得到的摘要进行对比。如果两者一致，就证明这封信未被修改过。</p> <p><img src="/javablog/public/assets/img/1717482717763.8734a138.png" alt="1717482717763"></p> <h3 id="_7-数字证书"><a href="#_7-数字证书" class="header-anchor">#</a> 7, 数字证书</h3> <p><strong>数字证书解决公钥不信任问题</strong></p> <p><strong>为什么需要数字证书：</strong></p> <p>复杂的情况出现了。李四想欺骗幺妹，他偷偷使用了幺妹的电脑，用自己的公钥换走了张三的公钥。此时，幺妹实际拥有的是李四的公钥，但是还以为这是张三的公钥。因此，李四就可以冒充张三，用自己的私钥做成&quot;数字签名&quot;，写信给幺妹，让幺妹用假的张三公钥进行解密。</p> <p><img src="/javablog/public/assets/img/1717482830197.3c247c00.png" alt="1717482830197"></p> <p>后来，幺妹感觉不对劲，发现自己无法确定公钥是否真的属于张三。她想到了一个办法，要求张三去找&quot;证书中心&quot;（certificate authority，简称CA），为公钥做认证。证书中心用自己的私钥，对张三的公钥和一些相关信息一起加密，生成&quot;数字证书&quot;（Digital Certificate）。</p> <p><img src="/javablog/public/assets/img/1717482856524.a1db3af8.png" alt="1717482856524"></p> <p><strong>理解数据证书：</strong></p> <p>比如说我们的毕业证书，任何公司都会承认。为什么会承认？因为那是国家发得，大家都信任国家。也就是说只要是国家的认证机构，我们都信任它是合法的。</p> <p><strong>原理：</strong></p> <p>为了解决公钥的信任问题，张三和幺妹找一家认证公司（CA <em>Ca</em>tificate Authority），把公钥进行认证，证书中心用自己的私钥，对A的公钥和一些相关信息一起加密，生成“<strong>数字证书</strong>”（Digital Certificate）</p> <p><img src="/javablog/public/assets/img/1717482898508.4f9e5bfe.png" alt="1717482898508"></p> <p>幺妹如果获取到证书，证书可以用CA的公钥（认证中心信用背书）进行解密，会得到发公钥人的信息，以及他的公钥，此时这个A的公钥是可信的。</p> <p><img src="/javablog/public/assets/img/1717482922502.2e498a39.png" alt="1717482922502"></p> <p>所以张三给幺妹发送信息的时候，就会带上签名，和证书一并发送给到互联网上，幺妹接收到消息的时候，先用CA发布的公钥解密数字证书，得到张三的公钥，用张三的公钥解密签名，得到摘要，幺妹在用hash算法得到消息的摘要，对两个摘要对比，如果相等，说明消息在网络上没有被不法分子修改。</p> <p><img src="/javablog/public/assets/img/1717482941525.8beac447.png" alt="1717482941525"></p> <h2 id="三-支付工程准备"><a href="#三-支付工程准备" class="header-anchor">#</a> 三，支付工程准备</h2> <h3 id="_1-创建支付工程"><a href="#_1-创建支付工程" class="header-anchor">#</a> 1, 创建支付工程</h3> <p>创建项目(JDK1.8)：</p> <p><img src="/javablog/public/assets/img/1717483676954.55af3712.png" alt="1717483676954"></p> <p>依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-web<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.projectlombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>lombok<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>test<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>springboot版本：</p> <p><img src="/javablog/public/assets/img/1717484334961.17d2fd17.png" alt="1717484334961"></p> <p>字符编码：</p> <p><img src="/javablog/public/assets/img/1717483756441.34da7e78.png" alt="1717483756441"></p> <p>Java编译版本选择：</p> <p><img src="/javablog/public/assets/img/1717483809430.73764dcb.png" alt="1717483809430"></p> <p>配置application.yml文件：</p> <p><img src="/javablog/public/assets/img/1717483852306.c0842828.png" alt="1717483852306"></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token comment"># 端口号</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment">#应用名</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> payment

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
    <span class="token key atrule">console</span><span class="token punctuation">:</span> logging.pattern.console=%d<span class="token punctuation">{</span>MM/dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss.SSS<span class="token punctuation">}</span> %clr(%<span class="token punctuation">-</span>5level) <span class="token punctuation">---</span> <span class="token punctuation">[</span>%<span class="token punctuation">-</span>15thread<span class="token punctuation">]</span> %cyan(%<span class="token punctuation">-</span>50logger<span class="token punctuation">{</span><span class="token number">50</span><span class="token punctuation">}</span>)<span class="token punctuation">:</span>%msg%n
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>不同功能的类放在不同功能的包里面。</p> <ul><li>config：所有的配置 用于存放Spring Boot相关的配置类，包括启动类。</li> <li>controller：所有请求入口，前端访问后端的入口。</li> <li>sevice：逻辑层，负责所有的业务逻辑。</li> <li>mapper：或者叫Dao,持久层，负责java和数据库交互。包括interface和XML两类文件。</li> <li>entity(Po)：表映射实体，用一个java类来映射数据库表，类名就相当于表名，类的属性就相当于表字段。</li> <li>dto：数据传输对象（Data Transfer Object），用于前后端数据交互。</li></ul> <p>Domain和Dto区别：</p> <ul><li>从用法上来说：Domain用于java数据和数据库表记录映射，删除增加修改数据库的数据，用在service层和Mapper层。</li> <li>Dto用在前后端数据传输：用在controller层和Service层Service层介于Controller和Mapper之间，也是Domain和Dto的转换层。</li></ul> <p><img src="/javablog/public/assets/img/1717484283914.9c747f14.png" alt="1717484283914"></p> <h3 id="_2-创建数据库表"><a href="#_2-创建数据库表" class="header-anchor">#</a> 2, 创建数据库表</h3> <p>数据库：</p> <p><img src="/javablog/public/assets/img/1717484555263.69be3895.png" alt="1717484555263"></p> <p>分析：</p> <p><img src="/javablog/public/assets/img/1717484647436.e2124eab.png" alt="1717484647436"></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">/*
 Navicat Premium Data Transfer

 Source Server         : 本地数据库
 Source Server Type    : MySQL
 Source Server Version : 50734
 Source Host           : localhost:3306
 Source Schema         : payment

 Target Server Type    : MySQL
 Target Server Version : 50734
 File Encoding         : 65001

 Date: 06/05/2022 11:27:03
*/</span>

<span class="token keyword">SET</span> NAMES utf8mb4<span class="token punctuation">;</span>
<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for order_info</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>order_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>order_info<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>title<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单标题'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商户订单编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>user_id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'用户id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>total_fee<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单金额(分)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>code_url<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单二维码连接'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_status<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'订单状态'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">1516240544441835604</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> DYNAMIC<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of order_info</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>order_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1516240544441835602</span><span class="token punctuation">,</span> <span class="token string">'红米'</span><span class="token punctuation">,</span> <span class="token string">'1651804709115'</span><span class="token punctuation">,</span> <span class="token number">123456</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'weixin://wxpay/bizpayurl?pr=IkR9W0bzz'</span><span class="token punctuation">,</span> <span class="token string">'已退款'</span><span class="token punctuation">,</span> <span class="token string">'2022-05-06 10:38:29'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>order_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1516240544441835603</span><span class="token punctuation">,</span> <span class="token string">'电话卡'</span><span class="token punctuation">,</span> <span class="token string">'1651805855691'</span><span class="token punctuation">,</span> <span class="token number">123456</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'未支付'</span><span class="token punctuation">,</span> <span class="token string">'2022-05-06 10:57:36'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for payment_info</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>payment_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>payment_info<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付记录id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商户订单编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>transaction_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付系统交易编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>payment_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付类型'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>trade_type<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'交易类型'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>trade_state<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'交易状态'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>payer_total<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付金额(分)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'通知参数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">62</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> DYNAMIC<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of payment_info</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>payment_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">61</span><span class="token punctuation">,</span> <span class="token string">'1651804709115'</span><span class="token punctuation">,</span> <span class="token string">'4200001430202205062085785618'</span><span class="token punctuation">,</span> <span class="token string">'微信'</span><span class="token punctuation">,</span> <span class="token string">'NATIVE'</span><span class="token punctuation">,</span> <span class="token string">'SUCCESS'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'{\&quot;transaction_id\&quot;:\&quot;4200001430202205062085785618\&quot;,\&quot;amount\&quot;:{\&quot;payer_total\&quot;:10,\&quot;total\&quot;:10,\&quot;currency\&quot;:\&quot;CNY\&quot;,\&quot;payer_currency\&quot;:\&quot;CNY\&quot;},\&quot;mchid\&quot;:\&quot;1532379511\&quot;,\&quot;out_trade_no\&quot;:\&quot;1651804709115\&quot;,\&quot;trade_state\&quot;:\&quot;SUCCESS\&quot;,\&quot;bank_type\&quot;:\&quot;CCB_DEBIT\&quot;,\&quot;appid\&quot;:\&quot;wx0ec7c1c17dac84f2\&quot;,\&quot;trade_state_desc\&quot;:\&quot;支付成功\&quot;,\&quot;trade_type\&quot;:\&quot;NATIVE\&quot;,\&quot;attach\&quot;:\&quot;\&quot;,\&quot;success_time\&quot;:\&quot;2022-05-06T10:38:53+08:00\&quot;,\&quot;payer\&quot;:{\&quot;openid\&quot;:\&quot;oeWpG46efXwDqNXvI-V3FrDu16Hs\&quot;}}'</span><span class="token punctuation">,</span> <span class="token string">'2022-05-06 10:38:53'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Table structure for refund_info</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">DROP</span> <span class="token keyword">TABLE</span> <span class="token keyword">IF</span> <span class="token keyword">EXISTS</span> <span class="token identifier"><span class="token punctuation">`</span>refund_info<span class="token punctuation">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token identifier"><span class="token punctuation">`</span>refund_info<span class="token punctuation">`</span></span>  <span class="token punctuation">(</span>
  <span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span> <span class="token keyword">bigint</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">UNSIGNED</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款单id'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>order_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商户订单编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refund_no<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'商户退款单编号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refund_id<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'支付系统退款单号'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>total_fee<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'原订单金额(分)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refund<span class="token punctuation">`</span></span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款金额(分)'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>reason<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">50</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款原因'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>refund_status<span class="token punctuation">`</span></span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款状态'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content_return<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'申请退款返回参数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>content_notify<span class="token punctuation">`</span></span> <span class="token keyword">text</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> utf8mb4 <span class="token keyword">COLLATE</span> utf8mb4_general_ci <span class="token boolean">NULL</span> <span class="token keyword">COMMENT</span> <span class="token string">'退款结果通知参数'</span><span class="token punctuation">,</span>
  <span class="token identifier"><span class="token punctuation">`</span>create_time<span class="token punctuation">`</span></span> <span class="token keyword">datetime</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CURRENT_TIMESTAMP</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">COMMENT</span> <span class="token string">'创建时间'</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token identifier"><span class="token punctuation">`</span>id<span class="token punctuation">`</span></span><span class="token punctuation">)</span> <span class="token keyword">USING</span> <span class="token keyword">BTREE</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span> <span class="token operator">=</span> <span class="token keyword">InnoDB</span> <span class="token keyword">AUTO_INCREMENT</span> <span class="token operator">=</span> <span class="token number">42</span> <span class="token keyword">CHARACTER</span> <span class="token keyword">SET</span> <span class="token operator">=</span> utf8mb4 <span class="token keyword">COLLATE</span> <span class="token operator">=</span> utf8mb4_general_ci ROW_FORMAT <span class="token operator">=</span> DYNAMIC<span class="token punctuation">;</span>

<span class="token comment">-- ----------------------------</span>
<span class="token comment">-- Records of refund_info</span>
<span class="token comment">-- ----------------------------</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> <span class="token identifier"><span class="token punctuation">`</span>refund_info<span class="token punctuation">`</span></span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">41</span><span class="token punctuation">,</span> <span class="token string">'1651804709115'</span><span class="token punctuation">,</span> <span class="token string">'1651804742316'</span><span class="token punctuation">,</span> <span class="token string">'50300201612022050620133572818'</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token string">'不喜欢'</span><span class="token punctuation">,</span> <span class="token string">'SUCCESS'</span><span class="token punctuation">,</span> <span class="token string">'{\&quot;amount\&quot;:{\&quot;currency\&quot;:\&quot;CNY\&quot;,\&quot;discount_refund\&quot;:0,\&quot;from\&quot;:[],\&quot;payer_refund\&quot;:10,\&quot;payer_total\&quot;:10,\&quot;refund\&quot;:10,\&quot;settlement_refund\&quot;:10,\&quot;settlement_total\&quot;:10,\&quot;total\&quot;:10},\&quot;channel\&quot;:\&quot;ORIGINAL\&quot;,\&quot;create_time\&quot;:\&quot;2022-05-06T10:39:03+08:00\&quot;,\&quot;funds_account\&quot;:\&quot;AVAILABLE\&quot;,\&quot;out_refund_no\&quot;:\&quot;1651804742316\&quot;,\&quot;out_trade_no\&quot;:\&quot;1651804709115\&quot;,\&quot;promotion_detail\&quot;:[],\&quot;refund_id\&quot;:\&quot;50300201612022050620133572818\&quot;,\&quot;status\&quot;:\&quot;PROCESSING\&quot;,\&quot;transaction_id\&quot;:\&quot;4200001430202205062085785618\&quot;,\&quot;user_received_account\&quot;:\&quot;建设银行借记卡0812\&quot;}'</span><span class="token punctuation">,</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span> <span class="token string">'2022-05-06 10:39:02'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">SET</span> FOREIGN_KEY_CHECKS <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br></div></div><h3 id="_3-集成mybatis-plus"><a href="#_3-集成mybatis-plus" class="header-anchor">#</a> 3, 集成MyBatis-Plus</h3> <p>依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-boot-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.1<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>5.1.49<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>配置：</p> <p><img src="/javablog/public/assets/img/1717484882394.c3478b44.png" alt="1717484882394"></p> <div class="language-yml line-numbers-mode"><pre class="language-yml"><code><span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token comment"># 端口号</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">9090</span>
<span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token comment">#应用名</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> payment
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.jdbc.Driver
    <span class="token key atrule">url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>///payment<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=UTF-8&amp;serverTimezone=Asia/Shanghai&amp;useSSL=false</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> root

<span class="token key atrule">logging</span><span class="token punctuation">:</span>
  <span class="token key atrule">pattern</span><span class="token punctuation">:</span>
    <span class="token key atrule">console</span><span class="token punctuation">:</span> logging.pattern.console=%d<span class="token punctuation">{</span>MM/dd HH<span class="token punctuation">:</span>mm<span class="token punctuation">:</span>ss.SSS<span class="token punctuation">}</span> %clr(%<span class="token punctuation">-</span>5level) <span class="token punctuation">---</span> <span class="token punctuation">[</span>%<span class="token punctuation">-</span>15thread<span class="token punctuation">]</span> %cyan(%<span class="token punctuation">-</span>50logger<span class="token punctuation">{</span><span class="token number">50</span><span class="token punctuation">}</span>)<span class="token punctuation">:</span>%msg%n
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>生成mapper的位置：</p> <p><img src="/javablog/public/assets/img/1717484946084.2c641bbd.png" alt="1717484946084"></p> <h3 id="_4-mybatis-plus代码生成器"><a href="#_4-mybatis-plus代码生成器" class="header-anchor">#</a> 4, MyBatis-Plus代码生成器</h3> <p>依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.baomidou<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mybatis-plus-generator<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.5.2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token comment">&lt;!-- 模板引擎 --&gt;</span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.velocity<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>velocity-engine-core<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>快速生成:</p> <p><img src="/javablog/public/assets/img/1717485210249.86c6425d.png" alt="1717485210249"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>generator<span class="token punctuation">.</span></span><span class="token class-name">FastAutoGenerator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>baomidou<span class="token punctuation">.</span>mybatisplus<span class="token punctuation">.</span>generator<span class="token punctuation">.</span>config<span class="token punctuation">.</span>rules<span class="token punctuation">.</span></span><span class="token class-name">NamingStrategy</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Arrays</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>


<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CodeGenerator</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">FastAutoGenerator</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token string">&quot;jdbc:mysql://localhost:3306/payment&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;root&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">globalConfig</span><span class="token punctuation">(</span>builder <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">author</span><span class="token punctuation">(</span><span class="token string">&quot;ityls&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 设置作者</span>
                            <span class="token punctuation">.</span><span class="token function">commentDate</span><span class="token punctuation">(</span><span class="token string">&quot;MM-dd&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 注释日期格式 C:\Users\wangc\IdeaProjects\payment-demo2\src\main\java</span>
                            <span class="token punctuation">.</span><span class="token function">outputDir</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span><span class="token string">&quot;user.dir&quot;</span><span class="token punctuation">)</span><span class="token operator">+</span> <span class="token string">&quot;/src/main/java/&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 指定输出目录</span>
                            <span class="token punctuation">.</span><span class="token function">fileOverride</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//覆盖文件</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token comment">// 包配置</span>
                <span class="token punctuation">.</span><span class="token function">packageConfig</span><span class="token punctuation">(</span>builder <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    builder<span class="token punctuation">.</span><span class="token function">parent</span><span class="token punctuation">(</span><span class="token string">&quot;com.ityls&quot;</span><span class="token punctuation">)</span> <span class="token comment">// 包名前缀</span>
                            <span class="token punctuation">.</span><span class="token function">entity</span><span class="token punctuation">(</span><span class="token string">&quot;entity&quot;</span><span class="token punctuation">)</span> <span class="token comment">//实体类包名</span>
                            <span class="token punctuation">.</span><span class="token function">mapper</span><span class="token punctuation">(</span><span class="token string">&quot;mapper&quot;</span><span class="token punctuation">)</span> <span class="token comment">//mapper接口包名</span>
                            <span class="token punctuation">.</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token string">&quot;service&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//service包名</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">strategyConfig</span><span class="token punctuation">(</span>builder <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
                    <span class="token comment">// 设置需要生成的表名</span>
                    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> strings <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;order_info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;payment_info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;refund_info&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    builder<span class="token punctuation">.</span><span class="token function">addInclude</span><span class="token punctuation">(</span>strings<span class="token punctuation">)</span>
                            <span class="token comment">// 开始实体类配置</span>
                            <span class="token punctuation">.</span><span class="token function">entityBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token comment">// 开启lombok模型</span>
                            <span class="token punctuation">.</span><span class="token function">enableLombok</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token comment">//表名下划线转驼峰</span>
                            <span class="token punctuation">.</span><span class="token function">naming</span><span class="token punctuation">(</span><span class="token class-name">NamingStrategy</span><span class="token punctuation">.</span>underline_to_camel<span class="token punctuation">)</span>
                            <span class="token comment">//列名下划线转驼峰</span>
                            <span class="token punctuation">.</span><span class="token function">columnNaming</span><span class="token punctuation">(</span><span class="token class-name">NamingStrategy</span><span class="token punctuation">.</span>underline_to_camel<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717485479173.39b6ceed.png" alt="1717485479173"></p> <h3 id="_5-统一结果返回封装类"><a href="#_5-统一结果返回封装类" class="header-anchor">#</a> 5, 统一结果返回封装类</h3> <p><strong>统一接口返回类的意义：</strong></p> <p>基于java的前后端分离项目中，前端获取后端controller层接口返回的JSON格式的数据，并展示出来。通常为了提高代码质量，会将后端返回的数据进行统一的格式处理。</p> <p>枚举类：</p> <p><img src="/javablog/public/assets/img/1717485617136.4facbe3b.png" alt="1717485617136"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">CodeEnum</span> <span class="token punctuation">{</span>

    <span class="token comment">// 成功</span>
    <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">,</span><span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 系统异常</span>
    <span class="token function">SYSTEM_ERROR</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;系统异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">PARAMETER_ERROR</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">,</span><span class="token string">&quot;参数缺失&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">// 支付异常</span>
    <span class="token function">ORDER_ERROR</span><span class="token punctuation">(</span><span class="token number">600</span><span class="token punctuation">,</span><span class="token string">&quot;订单不存在&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token function">PAYMENT_ERROR</span><span class="token punctuation">(</span><span class="token number">601</span><span class="token punctuation">,</span><span class="token string">&quot;支付异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">// 状态码</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>

    <span class="token comment">//响应信息</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> message<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><p>创建统一返回类:</p> <p><img src="/javablog/public/assets/img/1717485713794.b1440468.png" alt="1717485713794"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">NoArgsConstructor</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">Serializable</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 统一结果封装类
 * @param &lt;T&gt;
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token annotation punctuation">@NoArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span>  <span class="token punctuation">{</span>

    <span class="token comment">// 状态码</span>
    <span class="token keyword">private</span>  <span class="token class-name">Integer</span> code<span class="token punctuation">;</span>

    <span class="token comment">//响应信息</span>
    <span class="token keyword">private</span>  <span class="token class-name">String</span> message<span class="token punctuation">;</span>

    <span class="token comment">// 数据</span>
    <span class="token keyword">private</span> <span class="token class-name">T</span> data<span class="token punctuation">;</span>

    <span class="token comment">// 构建请求成功结果</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构建请求成功结果</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token class-name">T</span> data<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 构建请求失败结果</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span> codeEnum<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BaseResult</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>codeEnum<span class="token punctuation">.</span><span class="token function">getCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>codeEnum<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717485799825.e5b5e75b.png" alt="1717485799825"></p> <h2 id="四-实现支付"><a href="#四-实现支付" class="header-anchor">#</a> 四，实现支付</h2> <h3 id="_1-引入微信支付配置参数"><a href="#_1-引入微信支付配置参数" class="header-anchor">#</a> 1, 引入微信支付配置参数</h3> <p><strong>定义微信配置文件：</strong></p> <p>创建wxpay.properties 文件到resources目录中。这个文件定义了之前我们准备的微信支付相关的参数，例如商户号、APPID、API秘钥等等。</p> <p><img src="/javablog/public/assets/img/1717487403176.6277607b.png" alt="1717487403176"></p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token comment"># 微信支付相关参数</span>
<span class="token comment"># 商户号</span>
<span class="token key attr-name">wxpay.mch-id</span><span class="token punctuation">=</span><span class="token value attr-value">1609462435</span>
<span class="token comment"># 商户API证书序列号</span>
<span class="token key attr-name">wxpay.mch-serial-no</span><span class="token punctuation">=</span><span class="token value attr-value">16753799746EDFD6916E0C7AADEB7114695F4BC5</span>
<span class="token comment"># 商户私钥文件</span>
<span class="token key attr-name">wxpay.private-key-path</span><span class="token punctuation">=</span><span class="token value attr-value">apiclient_key.pem</span>
<span class="token comment"># APIv3密钥</span>
<span class="token key attr-name">wxpay.api-v3-key</span><span class="token punctuation">=</span><span class="token value attr-value">g38hhY10sXTuxy3lvBmCxIrJn3u1tc8r</span>
<span class="token comment"># APPID</span>
<span class="token key attr-name">wxpay.appid</span><span class="token punctuation">=</span><span class="token value attr-value">wxa791a4ea3b1bb0a5</span>
<span class="token comment"># 微信服务器地址</span>
<span class="token key attr-name">wxpay.domain</span><span class="token punctuation">=</span><span class="token value attr-value">https://api.mch.weixin.qq.com</span>
<span class="token comment"># 接收结果通知地址</span>
<span class="token key attr-name">wxpay.notify-domain</span><span class="token punctuation">=</span><span class="token value attr-value">https://7d92-115-171-63-135.ngrok.io</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>让IDEA可以识别配置文件，将配置文件的图标展示成SpringBoot的图标，同时配置文件的内容可以高亮显示：</p> <p><img src="/javablog/public/assets/img/1717487693523.83b142cc.png" alt="1717487693523"></p> <p>引入依赖(可以帮助我们生成自定义配置的元数据信息，让配置文件和Java代码之间的对应参数可以自动定位，方便开发。)：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>   <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-autoconfigure-processor<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>optional</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>optional</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>读取微信支付参数：</p> <p><img src="/javablog/public/assets/img/1717488023446.f586c1bc.png" alt="1717488023446"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertySource</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:wxpay.properties&quot;</span><span class="token punctuation">)</span> <span class="token comment">//读取配置文件</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">&quot;wxpay&quot;</span><span class="token punctuation">)</span> <span class="token comment">//读取wxpay节点</span>
<span class="token annotation punctuation">@Data</span> <span class="token comment">//使用set方法将wxpay节点中的值填充到当前类的属性中</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayConfig</span> <span class="token punctuation">{</span>


    <span class="token comment">// 商户号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchId<span class="token punctuation">;</span>


    <span class="token comment">// 商户API证书序列号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchSerialNo<span class="token punctuation">;</span>


    <span class="token comment">// 商户私钥文件</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> privateKeyPath<span class="token punctuation">;</span>


    <span class="token comment">// APIv3密钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> apiV3Key<span class="token punctuation">;</span>


    <span class="token comment">// APPID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appid<span class="token punctuation">;</span>


    <span class="token comment">// 微信服务器地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>


    <span class="token comment">// 接收结果通知地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyDomain<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717488013141.b59c86e2.png" alt="1717488013141"></p> <h3 id="_2-配置商户证书"><a href="#_2-配置商户证书" class="header-anchor">#</a> 2, 配置商户证书</h3> <p><strong>商户API私钥:</strong></p> <p>商户申请商户API证书时，会生成商户私钥，并保存在本地证书文件夹的文件<code>apiclient_key.pem</code> 中。私钥也可以通过工具从商户的p12证书中导出。请妥善保管好你的商户私钥文件。将下载的私钥文件复制到项目根目录</p> <p><img src="/javablog/public/assets/img/1717488175060.976c1090.png" alt="1717488175060"></p> <p><strong>注意：</strong></p> <p>不要把私钥文件暴露在公共场合，如上传到Github，写在客户端代码等。</p> <p><strong>引入微信SDK:</strong></p> <p><a href="https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay6_0.shtml" target="_blank" rel="noopener noreferrer">https://pay.weixin.qq.com/wiki/doc/apiv3/wechatpay/wechatpay6_0.shtml<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>我们可以使用官方提供的 SDK，帮助我们完成开发。实现了请求签名的生成和应答签名的验证。</p> <p><img src="/javablog/public/assets/img/1717488282683.fbf791f6.png" alt="1717488282683"></p> <p><img src="/javablog/public/assets/img/1717488313273.fa4e3eb5.png" alt="1717488313273"></p> <p>微信sdk:</p> <p><img src="/javablog/public/assets/img/1717488369234.cb5d19f0.png" alt="1717488369234"></p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.github.wechatpay-apiv3<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>wechatpay-apache-httpclient<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.4.4<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><strong>获取商户私钥:</strong></p> <p><img src="/javablog/public/assets/img/1717488820328.a1823e1d.png" alt="1717488820328"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 获取商户私钥文件
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">PrivateKey</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token class-name">String</span> filename<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 加载商户私钥（privateKey：私钥字符串）</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> <span class="token class-name">PemUtil</span>
                    <span class="token punctuation">.</span><span class="token function">loadPrivateKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> privateKey<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;私钥文件不存在&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717488855952.65ea9784.png" alt="1717488855952"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxPayConfig</span> wxPayConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Test</span>
    <span class="token keyword">void</span> <span class="token function">testGetPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 获取私钥名字</span>
       <span class="token class-name">String</span> privateKeyPath <span class="token operator">=</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getPrivateKeyPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取商户私钥</span>
       <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getPrivateKey</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>privateKey<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h3 id="_3-加载平台证书和获取httpclient对象"><a href="#_3-加载平台证书和获取httpclient对象" class="header-anchor">#</a> 3, 加载平台证书和获取HttpClient对象</h3> <p><strong>平台证书:</strong></p> <p>微信支付平台证书是指由微信支付负责申请的，包含微信支付平台标识、公钥信息的证书。商户可以使用平台证书中的公钥进行验签。不同的商户，对应的微信支付平台证书是不一样的平台证书会周期性更换。商户应定时通过API下载新的证书。</p> <p><strong>获取签名验证器：</strong></p> <ul><li>平台证书：平台证书封装了微信的公钥，商户可以使用平台证书中的公钥进行验签。</li> <li>签名验证器：帮助我们进行验签工作，我们单独将它定义出来，方便后面的开发。</li></ul> <p><img src="/javablog/public/assets/img/1717489065719.879dc47b.png" alt="1717489065719"></p> <p>加载证书：</p> <p><img src="/javablog/public/assets/img/1717489263199.e018a7bf.png" alt="1717489263199"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 获取商户私钥文件
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PrivateKey</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 加载商户私钥（privateKey：私钥字符串）</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> <span class="token class-name">PemUtil</span>
                    <span class="token punctuation">.</span><span class="token function">loadPrivateKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> privateKey<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;私钥文件不存在&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加载证书
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AutoUpdateCertificatesVerifier</span> <span class="token function">getVerifier</span><span class="token punctuation">(</span><span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1、私钥签名对象  第一个参数 商户API证书序列号   第二个参数  私钥</span>
        <span class="token class-name">PrivateKeySigner</span> privateKeySigner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivateKeySigner</span><span class="token punctuation">(</span>mchSerialNo<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2、身份认证</span>
        <span class="token class-name">WechatPay2Credentials</span> wechatPay2Credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WechatPay2Credentials</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> privateKeySigner<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3、加载平台证书（mchId：商户号,mchSerialNo：商户证书序列号,apiV3Key：V3密钥）</span>
        <span class="token class-name">AutoUpdateCertificatesVerifier</span> verifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoUpdateCertificatesVerifier</span><span class="token punctuation">(</span>wechatPay2Credentials<span class="token punctuation">,</span>apiV3Key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> verifier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br></div></div><p>初始化HttpClient：</p> <p><img src="/javablog/public/assets/img/1717489357905.bde73e39.png" alt="1717489357905"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 获取HTTP请求对象
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;wxPayHttpClient&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CloseableHttpClient</span> <span class="token function">getWxHttpClient</span><span class="token punctuation">(</span><span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">,</span> <span class="token class-name">AutoUpdateCertificatesVerifier</span> autoUpdateCertificatesVerifier<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 初始化httpClient</span>
        <span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClientBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withMerchant</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> mchSerialNo<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WechatPay2Validator</span><span class="token punctuation">(</span>autoUpdateCertificatesVerifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> httpClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>完整代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span></span><span class="token class-name">WechatPayHttpClientBuilder</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">AutoUpdateCertificatesVerifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">PrivateKeySigner</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">WechatPay2Credentials</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">WechatPay2Validator</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">PemUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>http<span class="token punctuation">.</span>impl<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">CloseableHttpClient</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">PropertySource</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileInputStream</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">FileNotFoundException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">UnsupportedEncodingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">PrivateKey</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@PropertySource</span><span class="token punctuation">(</span><span class="token string">&quot;classpath:wxpay.properties&quot;</span><span class="token punctuation">)</span> <span class="token comment">//读取配置文件</span>
<span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix<span class="token operator">=</span><span class="token string">&quot;wxpay&quot;</span><span class="token punctuation">)</span> <span class="token comment">//读取wxpay节点</span>
<span class="token annotation punctuation">@Data</span> <span class="token comment">//使用set方法将wxpay节点中的值填充到当前类的属性中</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayConfig</span> <span class="token punctuation">{</span>


    <span class="token comment">// 商户号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchId<span class="token punctuation">;</span>


    <span class="token comment">// 商户API证书序列号</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> mchSerialNo<span class="token punctuation">;</span>


    <span class="token comment">// 商户私钥文件</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> privateKeyPath<span class="token punctuation">;</span>


    <span class="token comment">// APIv3密钥</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> apiV3Key<span class="token punctuation">;</span>


    <span class="token comment">// APPID</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> appid<span class="token punctuation">;</span>


    <span class="token comment">// 微信服务器地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> domain<span class="token punctuation">;</span>


    <span class="token comment">// 接收结果通知地址</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> notifyDomain<span class="token punctuation">;</span>

    <span class="token comment">/**
     * 获取商户私钥文件
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">PrivateKey</span> <span class="token function">getPrivateKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 加载商户私钥（privateKey：私钥字符串）</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">PrivateKey</span> privateKey <span class="token operator">=</span> <span class="token class-name">PemUtil</span>
                    <span class="token punctuation">.</span><span class="token function">loadPrivateKey</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>privateKeyPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> privateKey<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FileNotFoundException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span><span class="token string">&quot;私钥文件不存在&quot;</span><span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 加载证书
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">AutoUpdateCertificatesVerifier</span> <span class="token function">getVerifier</span><span class="token punctuation">(</span><span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1、私钥签名对象  第一个参数 商户API证书序列号   第二个参数  私钥</span>
        <span class="token class-name">PrivateKeySigner</span> privateKeySigner <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PrivateKeySigner</span><span class="token punctuation">(</span>mchSerialNo<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2、身份认证</span>
        <span class="token class-name">WechatPay2Credentials</span> wechatPay2Credentials <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WechatPay2Credentials</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> privateKeySigner<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3、加载平台证书（mchId：商户号,mchSerialNo：商户证书序列号,apiV3Key：V3密钥）</span>
        <span class="token class-name">AutoUpdateCertificatesVerifier</span> verifier <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoUpdateCertificatesVerifier</span><span class="token punctuation">(</span>wechatPay2Credentials<span class="token punctuation">,</span>apiV3Key<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> verifier<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 获取HTTP请求对象
     * @return
     */</span>
    <span class="token annotation punctuation">@Bean</span><span class="token punctuation">(</span>name <span class="token operator">=</span> <span class="token string">&quot;wxPayHttpClient&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">CloseableHttpClient</span> <span class="token function">getWxHttpClient</span><span class="token punctuation">(</span><span class="token class-name">PrivateKey</span> privateKey<span class="token punctuation">,</span> <span class="token class-name">AutoUpdateCertificatesVerifier</span> autoUpdateCertificatesVerifier<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">// 初始化httpClient</span>
        <span class="token class-name">CloseableHttpClient</span> httpClient <span class="token operator">=</span> <span class="token class-name">WechatPayHttpClientBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withMerchant</span><span class="token punctuation">(</span>mchId<span class="token punctuation">,</span> mchSerialNo<span class="token punctuation">,</span> privateKey<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">WechatPay2Validator</span><span class="token punctuation">(</span>autoUpdateCertificatesVerifier<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> httpClient<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br></div></div><h3 id="_4-native支付api列表"><a href="#_4-native支付api列表" class="header-anchor">#</a> 4, Native支付API列表</h3> <p>微信支付官方文档：https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_7_3.shtml</p> <p><img src="/javablog/public/assets/img/1717489443513.ee545ddf.png" alt="1717489443513"></p> <p><img src="/javablog/public/assets/img/1717489522281.0cb59b85.png" alt="1717489522281"></p> <p>为了开发方便，我们预先在项目中定义一些枚举。枚举中定义的内容包括接口地址，支付状态等信息。支付接口api枚举：</p> <p><img src="/javablog/public/assets/img/1717489610959.1731e1ac.png" alt="1717489610959"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>wx</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">WxApiType</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * Native下单
     * https://api.mch.weixin.qq.com/v3/pay/transactions/native
     */</span>
    <span class="token function">NATIVE_PAY</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/pay/transactions/native&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 查询订单
     * https://api.mch.weixin.qq.com/v3/pay/transactions/id/{transaction_id}
     * https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/{out_trade_no}
     */</span>
    <span class="token function">ORDER_QUERY_BY_NO</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/pay/transactions/out-trade-no/%s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 关闭订单
     */</span>
    <span class="token function">CLOSE_ORDER_BY_NO</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/pay/transactions/out-trade-no/%s/close&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 申请退款
     */</span>
    <span class="token function">DOMESTIC_REFUNDS</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/refund/domestic/refunds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 查询单笔退款
     */</span>
    <span class="token function">DOMESTIC_REFUNDS_QUERY</span><span class="token punctuation">(</span><span class="token string">&quot;/v3/refund/domestic/refunds/%s&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token comment">/**
     * 类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br></div></div><p>支付状态枚举:</p> <p><img src="/javablog/public/assets/img/1717489713705.f116c709.png" alt="1717489713705"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>wx</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">WxTradeState</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 支付成功
     */</span>
    <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 未支付
     */</span>
    <span class="token function">NOTPAY</span><span class="token punctuation">(</span><span class="token string">&quot;NOTPAY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 已关闭
     */</span>
    <span class="token function">CLOSED</span><span class="token punctuation">(</span><span class="token string">&quot;CLOSED&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 转入退款
     */</span>
    <span class="token function">REFUND</span><span class="token punctuation">(</span><span class="token string">&quot;REFUND&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h3 id="_5-native支付流程"><a href="#_5-native支付流程" class="header-anchor">#</a> 5, Native支付流程</h3> <p>商户后台系统先调用微信支付的Native下单接口，微信后台系统返回链接参数code_url，商户后台系统将code_url值生成二维码图片，用户使用微信客户端扫码后发起支付。https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_4.shtml</p> <p>流程图：code_url有效期为2小时，过期后扫码不能再发起支付。</p> <p><img src="/javablog/public/assets/img/1717489798159.bec9a041.png" alt="1717489798159"></p> <p><strong>业务流程说明：</strong></p> <ol><li>商户后台系统根据用户选购的商品生成订单。</li> <li>用户确认支付后调用微信支付【<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_1.shtml" target="_blank" rel="noopener noreferrer">Native下单API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>】生成预支付交易；</li> <li>微信支付系统收到请求后生成预支付交易单，并返回交易会话的二维码链接code_url。</li> <li>商户后台系统根据返回的code_url生成二维码。</li> <li>用户打开微信“扫一扫”扫描二维码，微信客户端将扫码内容发送到微信支付系统。</li> <li>微信支付系统收到客户端请求，验证链接有效性后发起用户支付，要求用户授权。</li> <li>用户在微信客户端输入密码，确认支付后，微信客户端提交授权。</li> <li>微信支付系统根据用户授权完成支付交易。</li> <li>微信支付系统完成支付交易后给微信客户端返回交易结果，并将交易结果通过短信、微信消息提示用户。微信客户端展示支付交易结果页面。</li> <li>微信支付系统通过发送异步消息通知商户后台系统支付结果。商户后台系统需回复接收情况，通知微信后台系统不再发送该单的支付通知。</li> <li>未收到支付通知的情况，商户后台系统调用【<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_2.shtml" target="_blank" rel="noopener noreferrer">查询订单API<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>】。</li> <li>商户确认订单已支付后给用户发货。</li></ol> <p><strong>生成二维码规则：</strong></p> <p>对应链接格式：weixin：//weixin://pay.weixin.qq.com/bizpayurl/up?pr=NwY5Mz9&amp;groupid=00。请商户调用第三方库将code_url生成二维码图片。该模式链接较短，生成的二维码打印到结账小票上的识别率较高。</p> <p><img src="/javablog/public/assets/img/1717490003682.5f61fdc5.png" alt="1717490003682"></p> <p><strong>参考文献：</strong></p> <p>商品二维码标准： <a href="http://c.gb688.cn/bzgk/gb/showGb?type=online&amp;hcno=F5AD425C27157698599E7B19DF7128E6" target="_blank" rel="noopener noreferrer">国家商品二维码标准<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>名片二维码： <a href="http://c.gb688.cn/bzgk/gb/showGb?type=online&amp;hcno=CA759A0DC00BF44159CAF4D7670CA5B2" target="_blank" rel="noopener noreferrer">名片二维码通用技术规范<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="_6-创建订单"><a href="#_6-创建订单" class="header-anchor">#</a> 6, 创建订单</h3> <p><strong>接口说明：</strong></p> <ul><li><p>请求URL：/api/order/createOrder</p></li> <li><p>请求方式：POST</p></li></ul> <p><strong>请求参数：</strong></p> <table><thead><tr><th>参数名</th> <th>变量</th> <th>必填</th></tr></thead> <tbody><tr><td>订单标题</td> <td>title</td> <td>是</td></tr> <tr><td>金额（分）</td> <td>totalFee</td> <td>是</td></tr></tbody></table> <p><strong>什么是DTO：</strong></p> <p>数据传输对象（DTO）(Data Transfer Object)，是一种设计模式之间传输数据的软件应用系统。</p> <p>创建订单DTO：</p> <p><img src="/javablog/public/assets/img/1717490181264.da356874.png" alt="1717490181264"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>controller<span class="token punctuation">.</span>dto</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderInfoDTO</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 订单标题
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 订单金额(分)
     */</span>
    <span class="token keyword">private</span> <span class="token class-name">Integer</span> totalFee<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>创建订单，接口：</p> <p><img src="/javablog/public/assets/img/1717490388776.fe227ec0.png" alt="1717490388776"></p> <p>订单状态枚举：</p> <p><img src="/javablog/public/assets/img/1717490669182.bd910668.png" alt="1717490669182"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>enums</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 订单状态
 */</span>
<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">OrderStatus</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 未支付
     */</span>
    <span class="token function">NOTPAY</span><span class="token punctuation">(</span><span class="token string">&quot;未支付&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>


    <span class="token comment">/**
     * 支付成功
     */</span>
    <span class="token function">SUCCESS</span><span class="token punctuation">(</span><span class="token string">&quot;支付成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 已关闭
     */</span>
    <span class="token function">CLOSED</span><span class="token punctuation">(</span><span class="token string">&quot;超时已关闭&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 已取消
     */</span>
    <span class="token function">CANCEL</span><span class="token punctuation">(</span><span class="token string">&quot;用户已取消&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 退款中
     */</span>
    <span class="token function">REFUND_PROCESSING</span><span class="token punctuation">(</span><span class="token string">&quot;退款中&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 已退款
     */</span>
    <span class="token function">REFUND_SUCCESS</span><span class="token punctuation">(</span><span class="token string">&quot;已退款&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>

    <span class="token comment">/**
     * 退款异常
     */</span>
    <span class="token function">REFUND_ABNORMAL</span><span class="token punctuation">(</span><span class="token string">&quot;退款异常&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717490714292.1696dd27.png" alt="1717490714292"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderInfoServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfoMapper</span><span class="token punctuation">,</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IOrderInfoService</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 实现订单
     * @param orderInfoDTO
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderInfoDTO</span> orderInfoDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************ 创建订单 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OrderInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span>orderInfoDTO<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订单编号</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 用户id</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setUserId</span><span class="token punctuation">(</span><span class="token number">123456L</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 金额 分   1 = 100</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setTotalFee</span><span class="token punctuation">(</span>orderInfoDTO<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 订单状态</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">NOTPAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 创建时间</span>
        orderInfo<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">int</span> insert <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>insert <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;*********** 订单创建成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> orderInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>controller层：</p> <p><img src="/javablog/public/assets/img/1717492565668.feac777c.png" alt="1717492565668"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/order&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OrderInfoController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IOrderInfoService</span> iOrderInfoService<span class="token punctuation">;</span><span class="token comment">// 订单接口</span>

    <span class="token comment">/**
     * 创建订单
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/createOrder&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">createOrder</span><span class="token punctuation">(</span><span class="token class-name">OrderInfoDTO</span> orderInfoDTO<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfoDTO<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> orderInfoDTO<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">PARAMETER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">OrderInfo</span> order <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">createOrder</span><span class="token punctuation">(</span>orderInfoDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>order<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717491791726.8ca0955c.png" alt="1717491791726"></p> <p><img src="/javablog/public/assets/img/1717492585453.d0127649.png" alt="1717492585453"></p> <p><img src="/javablog/public/assets/img/1717492595352.fc9df01b.png" alt="1717492595352"></p> <h3 id="_7-native下单之查询订单"><a href="#_7-native下单之查询订单" class="header-anchor">#</a> 7, Native下单之查询订单</h3> <p><strong>接口说明:</strong></p> <ul><li><p>请求URL：/api/wx-pay/native/{orderNo}</p></li> <li><p>请求方式：POST</p></li></ul> <p><strong>请求参数:</strong></p> <table><thead><tr><th>参数名</th> <th>变量</th> <th>必填</th></tr></thead> <tbody><tr><td>订单编号</td> <td>orderNo</td> <td>是</td></tr></tbody></table> <p><strong>Native支付开发指引:</strong></p> <p>商户端发起支付请求，微信端创建支付订单并生成支付二维码链接，微信端将支付二维码返回给商户端，商户端显示支付二维码，用户使用微信客户端扫码后发起支付。<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_7_2.shtml" target="_blank" rel="noopener noreferrer">Native支付开发指引<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/javablog/public/assets/img/1717492688037.5cf506b4.png" alt="1717492688037"></p> <p>根据订单的编号查订单的信息：</p> <p><img src="/javablog/public/assets/img/1717493061912.c9476b19.png" alt="1717493061912"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单编号查询订单信息
     * @param orderNo
     * @return
     */</span>
    <span class="token class-name">OrderInfo</span> <span class="token function">findByOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717493158130.9529e5ce.png" alt="1717493158130"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">OrderInfo</span> <span class="token function">findByOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span> <span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getOrderNo</span><span class="token punctuation">,</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> orderInfos <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfos <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>orderInfos<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> orderInfos<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717493318895.2b96c43c.png" alt="1717493318895"></p> <p>下单接口：</p> <p><img src="/javablog/public/assets/img/1717492942284.bddd879a.png" alt="1717492942284"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>service</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>vo<span class="token punctuation">.</span></span><span class="token class-name">BaseResult</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IWxPaymentService</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 根据订单编号进行Native下单
     * @param orderNo
     * @return code_url
     */</span>
    <span class="token class-name">BaseResult</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717493698794.60fdd74e.png" alt="1717493698794"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPaymentServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IWxPaymentService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IOrderInfoService</span> iOrderInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxPayConfig</span> wxPayConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;***********  开始 Native下单 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 根据订单编号查询订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">ORDER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. 调用统一下载API  https://api.mch.weixin.qq.com/v3/pay/transactions/native</span>
        <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>wxPayConfig<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxApiType</span><span class="token punctuation">.</span><span class="token constant">NATIVE_PAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>



        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><h3 id="_8-native下单之组装参数"><a href="#_8-native下单之组装参数" class="header-anchor">#</a> 8, Native下单之组装参数</h3> <p>定义通知回调的枚举类：</p> <p><img src="/javablog/public/assets/img/1717493922339.a035a1c5.png" alt="1717493922339"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>wx</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">WxNotifyType</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 支付通知
     * http://kalista.natapp1.cc/api/wx-pay/native/notify
     */</span>
    <span class="token function">NATIVE_NOTIFY</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wx-pay/native/notify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 退款结果通知
     */</span>
    <span class="token function">REFUND_NOTIFY</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wx-pay/refunds/notify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>依赖：</p> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.alibaba<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>fastjson<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.2.79<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>组装请求参数：</p> <p><img src="/javablog/public/assets/img/1717494234059.a3bf38e9.png" alt="1717494234059"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IOrderInfoService</span> iOrderInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxPayConfig</span> wxPayConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;***********  开始 Native下单 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 根据订单编号查询订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">ORDER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. 调用统一下载API  https://api.mch.weixin.qq.com/v3/pay/transactions/native</span>
        <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>wxPayConfig<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxApiType</span><span class="token punctuation">.</span><span class="token constant">NATIVE_PAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 组装请求参数</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;appid&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getAppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 应用id</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mchid&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 商户id</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 商品描述</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单编号</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxNotifyType</span><span class="token punctuation">.</span><span class="token constant">NATIVE_NOTIFY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 通知地址</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> amountMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        amountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> amountMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单金额</span>

        <span class="token comment">// 4. 将参数转换为json字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Native下单参数=======&gt;{}&quot;</span> <span class="token operator">+</span> jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h3 id="_9-native下单之返回二维码链接"><a href="#_9-native下单之返回二维码链接" class="header-anchor">#</a> 9, Native下单之返回二维码链接</h3> <p>创建payInfoVO，如下：</p> <p><img src="/javablog/public/assets/img/1717494664491.647dd715.png" alt="1717494664491"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>vo</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Data</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 支付返回结果vo
 */</span>
<span class="token annotation punctuation">@Data</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PayInfoVO</span> <span class="token punctuation">{</span>

    <span class="token comment">// 二维码连接</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> codeUrl<span class="token punctuation">;</span>
    <span class="token comment">// 订单</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>发请求，获取code_url，如下：</p> <p><img src="/javablog/public/assets/img/1717494803061.dca4f980.png" alt="1717494803061"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPaymentServiceImpl</span> <span class="token keyword">implements</span> <span class="token class-name">IWxPaymentService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IOrderInfoService</span> iOrderInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">WxPayConfig</span> wxPayConfig<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">CloseableHttpClient</span> wxPayClient<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;***********  开始 Native下单 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 根据订单编号查询订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>orderInfo <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">ORDER_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 2. 调用统一下载API  https://api.mch.weixin.qq.com/v3/pay/transactions/native</span>
        <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>wxPayConfig<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxApiType</span><span class="token punctuation">.</span><span class="token constant">NATIVE_PAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 组装请求参数</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;appid&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getAppid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 应用id</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mchid&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 商户id</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;description&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;test&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 商品描述</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单编号</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxNotifyType</span><span class="token punctuation">.</span><span class="token constant">NATIVE_NOTIFY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 通知地址</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> amountMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        amountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> orderInfo<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> amountMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单金额</span>

        <span class="token comment">// 4. 将参数转换为json字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Native下单参数=======&gt;{}&quot;</span> <span class="token operator">+</span> jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 准备消息 boby</span>
        <span class="token class-name">StringEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 准备请求头</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7.完成签名并执行请求</span>
        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> wxPayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 8. 拿出body 响应体</span>
            <span class="token class-name">String</span> bodyString <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 9. 获取响应状态码</span>
            <span class="token keyword">int</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 10 判断响应码</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>bodyString<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 11 取出code_url</span>
                <span class="token class-name">String</span> codeUrl <span class="token operator">=</span> responseMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;code_url&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 更新code_url</span>
                <span class="token class-name">PayInfoVO</span> payInfoVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PayInfoVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                payInfoVO<span class="token punctuation">.</span><span class="token function">setCodeUrl</span><span class="token punctuation">(</span>codeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
                payInfoVO<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>payInfoVO<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Native 下单失败响应码 &quot;</span> <span class="token operator">+</span> statusCode <span class="token operator">+</span> <span class="token string">&quot;返回结果&quot;</span> <span class="token operator">+</span> bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token class-name">CodeEnum</span><span class="token punctuation">.</span><span class="token constant">PAYMENT_ERROR</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br></div></div><p><strong>controller，接口说明：</strong></p> <ul><li>请求URL：/api/wx-pay/native/{orderNo}</li> <li>请求方式：POST</li></ul> <p><strong>请求参数：</strong></p> <table><thead><tr><th>参数名</th> <th>变量</th> <th>必填</th></tr></thead> <tbody><tr><td>订单编号</td> <td>orderNo</td> <td>是</td></tr></tbody></table> <p>代码：</p> <p><img src="/javablog/public/assets/img/1717495050756.797eaa00.png" alt="1717495050756"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@RestController</span>
<span class="token annotation punctuation">@RequestMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wx-pay&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPayController</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token keyword">private</span> <span class="token class-name">IWxPaymentService</span> iWxPaymentService<span class="token punctuation">;</span>

    <span class="token comment">/**
     * Native下单
     * weixin://wxpay/bizpayurl?pr=e5ta1spzz
     * @param orderNo
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/native/{orderNo}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">nativePay</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">BaseResult</span> baseResult <span class="token operator">=</span> iWxPaymentService<span class="token punctuation">.</span><span class="token function">nativePay</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> baseResult<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717498466746.d357de51.png" alt="1717498466746"></p> <h3 id="_10-二维码生成"><a href="#_10-二维码生成" class="header-anchor">#</a> 10, 二维码生成</h3> <p><strong>二维码概念：</strong></p> <p>二维码又称QR Code，QR全称Quick Response，是一个近几年来移动设备上超流行的一种编码方式。是用某种特定的几何图形按一定规律在平面（二维方向上）分布的黑白相间的图形记录数据符号信息的；在代码编制上巧妙地利用构成计算机内部逻辑基础的“0”、“1”比特流的概念。</p> <p><strong>什么是 QRCode.js：</strong></p> <p>QRCode.js 是一个用于生成二维码的 JavaScript 库。主要是通过获取 DOM 的标签,再通过 HTML5 Canvas 绘制而成,不依赖任何库。</p> <p>代码：</p> <p><img src="/javablog/public/assets/img/1717498150524.48c34676.png" alt="1717498150524"></p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>Title<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>qrcode<span class="token punctuation">&quot;</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span> 100px<span class="token punctuation">;</span><span class="token property">margin-top</span><span class="token punctuation">:</span> 15px</span><span class="token punctuation">&quot;</span></span></span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text/javascript<span class="token punctuation">&quot;</span></span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>//cdn.staticfile.org/jquery/2.1.1/jquery.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/qrcodejs/1.0.0/qrcode.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">new</span> <span class="token class-name">QRCode</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">getElementById</span><span class="token punctuation">(</span><span class="token string">&quot;qrcode&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token punctuation">{</span>
        <span class="token comment">// text:&quot;https://qr.alipay.com/bax03608rjdrnaio2koi0045&quot;,</span>
        <span class="token literal-property property">text</span><span class="token operator">:</span><span class="token string">&quot;https://www.baidu.com&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">width</span><span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        <span class="token literal-property property">height</span><span class="token operator">:</span> <span class="token number">100</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><h3 id="_11-重复支付解决"><a href="#_11-重复支付解决" class="header-anchor">#</a> 11, 重复支付解决</h3> <p><img src="/javablog/public/assets/img/1717498268934.38449495.png" alt="1717498268934"></p> <p>保存url:</p> <p><img src="/javablog/public/assets/img/1717502215465.cef59f18.png" alt="1717502215465"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     *
     * @param id 订单id
     * @param codeUrl 二维码
     */</span>
    <span class="token keyword">void</span> <span class="token function">saveCodeUrl</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span><span class="token class-name">String</span> codeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717502364891.01a44921.png" alt="1717502364891"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">saveCodeUrl</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">String</span> codeUrl<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> updateWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 设置要更新的字段 key = db属性</span>
        updateWrapper<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;code_url&quot;</span><span class="token punctuation">,</span>codeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//条件</span>
        updateWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>updateWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>微信服务器返回code_url后，把code_url保存到orderinfo中：</p> <p><img src="/javablog/public/assets/img/1717502527943.4832a417.png" alt="1717502527943"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> iOrderInfoService<span class="token punctuation">.</span><span class="token function">saveCodeUrl</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> codeUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717502661962.9d7c50cc.png" alt="1717502661962"></p> <p>添加事务和判断：</p> <p><img src="/javablog/public/assets/img/1717503076741.b6adbc3c.png" alt="1717503076741"></p> <div class="language- line-numbers-mode"><pre class="language-text"><code>        @Transactional(rollbackFor = Exception.class)
            
        if (orderInfo != null &amp;&amp; !StringUtils.isEmpty(orderInfo.getCodeUrl())) {
            // 直接返回二维码
            PayInfoVO payInfoVO = new PayInfoVO();
            payInfoVO.setCodeUrl(orderInfo.getCodeUrl());
            payInfoVO.setOrderNo(orderInfo.getOrderNo());
            return BaseResult.ok(payInfoVO);
        }
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样不可以解决重复下单的操作。</p> <h3 id="_12-内网穿透"><a href="#_12-内网穿透" class="header-anchor">#</a> 12, 内网穿透</h3> <p>为什么需要内网穿透：</p> <p><img src="/javablog/public/assets/img/1717503217615.16d37265.png" alt="1717503217615"></p> <p><strong>什么是内网穿透：</strong></p> <p>内网穿透也叫做内网映射，也叫“NAT穿透”。一句话来说就是，让外网能访问你的内网；把自己的内网（主机）当成服务器，让外网能访问。</p> <p><img src="/javablog/public/assets/img/1717503261149.409ffdca.png" alt="1717503261149"></p> <p><strong>内网穿透有哪些作用：</strong></p> <ul><li>访问内部网络</li> <li>映射成功后，你的电脑其实就变成了一台服务器，别人可以正常访问你的网站</li> <li>搭建一个临时的的服务器和网站</li></ul> <p><strong>内网穿透的工具平台：</strong></p> <ul><li>Sunny-Ngrok</li> <li>花生壳</li> <li>NATAPP</li></ul> <h3 id="_13-下载安装内网穿透"><a href="#_13-下载安装内网穿透" class="header-anchor">#</a> 13, 下载安装内网穿透</h3> <p>**下载注册ngrok：**官网<a href="https://natapp.cn/login" target="_blank" rel="noopener noreferrer">https://natapp.cn/login<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="/javablog/public/assets/img/1717503469315.40c1c256.png" alt="1717503469315"></p> <p>购买隧道（端口9090）：</p> <p><img src="/javablog/public/assets/img/1717503579244.1f9815bc.png" alt="1717503579244"></p> <p><img src="/javablog/public/assets/img/1717503642829.edda7522.png" alt="1717503642829"></p> <p>客户端下载：</p> <p><img src="/javablog/public/assets/img/1717503673498.d5062222.png" alt="1717503673498"></p> <p><img src="/javablog/public/assets/img/1717503717873.7e18de5b.png" alt="1717503717873"></p> <p>使用：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>./natapp -authtoken=f3bc977c20a65d25
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="/javablog/public/assets/img/1717504071616.8abfe5dd.png" alt="1717504071616"></p> <p>访问：</p> <p><img src="/javablog/public/assets/img/1717504062004.a35370cb.png" alt="1717504062004"></p> <p>代码中配置：</p> <p><img src="/javablog/public/assets/img/1717504126045.59ea996a.png" alt="1717504126045"></p> <h3 id="_14-接收通知"><a href="#_14-接收通知" class="header-anchor">#</a> 14, 接收通知</h3> <p>支付通知API：https://pay.weixin.qq.com/wiki/doc/apiv3/apis/chapter3_4_5.shtml</p> <p>修改wxpay.properties配置文件，重新设置回调地址：</p> <div class="language-properties line-numbers-mode"><pre class="language-properties"><code><span class="token key attr-name">wxpay.notify-domain</span><span class="token punctuation">=</span><span class="token value attr-value">http://ityls.natapp1.cc/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>代码中的支付通知：</p> <p><img src="/javablog/public/assets/img/1717504276720.9987e834.png" alt="1717504276720"></p> <p><strong>通知接口规则:</strong></p> <p>用户支付完成后，微信会把相关支付结果和用户信息发送给商户，商户需要接收处理该消息，并返回应答。对后台通知交互时，如果微信收到商户的应答不符合规范或超时，微信认为通知失败，微信会通过一定的策略定期重新发起通知，尽可能提高通知的成功率，但微信不保证通知最终能成功。</p> <p>注意：</p> <ul><li>通知频率15s/15s/30s/3m/10m/20m/30m/30m/30m/60m/3h/3h/3h/6h/6h - 总计 24h4m。</li></ul> <p><strong>通知报文：</strong></p> <p>支付结果通知是以POST 方法访问商户设置的通知url，通知的数据以JSON 格式通过请求主体（BODY）传输。通知的数据包括了加密的支付结果详情。</p> <p>注意：</p> <ul><li>由于涉及到回调加密和解密，商户必须先设置好apiv3秘钥后才能解密回调通知，apiv3秘钥设置文档指引详见<a href="https://kf.qq.com/faq/180830E36vyQ180830AZFZvu.html" target="_blank" rel="noopener noreferrer">APIv3秘钥设置指引<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）。</li></ul> <p>通知枚举：</p> <p><img src="/javablog/public/assets/img/1717504416045.3e200bb2.png" alt="1717504416045"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>enums<span class="token punctuation">.</span>wx</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span> <span class="token class-name">WxNotifyType</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 支付通知
     * 	http://ityls.natapp1.cc/api/wx-pay/native/notify
     */</span>
    <span class="token function">NATIVE_NOTIFY</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wx-pay/native/notify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">/**
     * 退款结果通知
     */</span>
    <span class="token function">REFUND_NOTIFY</span><span class="token punctuation">(</span><span class="token string">&quot;/api/wx-pay/refunds/notify&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><p>编写HttpUtils工具：</p> <p><img src="/javablog/public/assets/img/1717504704030.0586d523.png" alt="1717504704030"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">BufferedReader</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>

<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HttpUtils</span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 将通知参数转化为字符串(将httprequest转化成string)
     * @param request
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">readData</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">BufferedReader</span> br <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token class-name">StringBuilder</span> result <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            br <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getReader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">;</span> <span class="token punctuation">(</span>line <span class="token operator">=</span> br<span class="token punctuation">.</span><span class="token function">readLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span> <span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                result<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">RuntimeException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>br <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    br<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>controller:</p> <p><img src="/javablog/public/assets/img/1717505208113.fd7ce6b4.png" alt="1717505208113"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 微信支付通知
     * @param request
     * @param response
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/native/notify&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">notify</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>

        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 获取报文body</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">readData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 把json转换为map</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bodyMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;支付通知id======&gt; {}&quot;</span><span class="token punctuation">,</span> bodyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;支付通知完整数据=======&gt; {}&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 成功应答： 成功就是200 否则就是失败的应答</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>responseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717505231041.b65306f4.png" alt="1717505231041"></p> <p><img src="/javablog/public/assets/img/1717505241688.d808404f.png" alt="1717505241688"></p> <p><img src="/javablog/public/assets/img/1717505246445.c7c2aa4b.png" alt="1717505246445"></p> <p>支付后，看通知：</p> <p><img src="/javablog/public/assets/img/1717505272043.b0ccb7f7.png" alt="1717505272043"></p> <h3 id="_15-修改订单状态之验签"><a href="#_15-修改订单状态之验签" class="header-anchor">#</a> 15, 修改订单状态之验签</h3> <p><img src="/javablog/public/assets/img/1717505311288.4d276242.png" alt="1717505311288"></p> <p>必须保存上一小节中的通知地址是微信发过来的，不能是其它人发过来的，所以需要验签。工具类：</p> <p><img src="/javablog/public/assets/img/1717505713143.33ea573e.png" alt="1717505713143"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>utils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>config<span class="token punctuation">.</span></span><span class="token class-name">WxPayConfig</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>auth<span class="token punctuation">.</span></span><span class="token class-name">Verifier</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>wechat<span class="token punctuation">.</span>pay<span class="token punctuation">.</span>contrib<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>httpclient<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">AesUtil</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">javax<span class="token punctuation">.</span>servlet<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span><span class="token class-name">HttpServletRequest</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">UnsupportedEncodingException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>nio<span class="token punctuation">.</span>charset<span class="token punctuation">.</span></span><span class="token class-name">StandardCharsets</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>security<span class="token punctuation">.</span></span><span class="token class-name">GeneralSecurityException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Collectors</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>stream<span class="token punctuation">.</span></span><span class="token class-name">Stream</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 微信通知验签
 */</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxVerifierUtils</span> <span class="token punctuation">{</span>




    <span class="token comment">/**
     * 验签
     * @param request
     * @param verifier
     * @param body
     * Content-Type: application/json; charset=utf-8
     * Content-Length: 2204
     * Connection: keep-alive
     * Keep-Alive: timeout=8
     * Content-Language: zh-CN
     * Request-ID: e2762b10-b6b9-5108-a42c-16fe2422fc8a
     * Wechatpay-Nonce: c5ac7061fccab6bf3e254dcf98995b8c
     * Wechatpay-Signature: CtcbzwtQjN8rnOXItEBJ5aQFSnIXESeV28Pr2YEmf9wsDQ8Nx25ytW6FXBCAFdrr0mgqngX3AD9gNzjnNHzSGTPBSsaEkIfhPF4b8YRRTpny88tNLyprXA0GU5ID3DkZHpjFkX1hAp/D0fva2GKjGRLtvYbtUk/OLYqFuzbjt3yOBzJSKQqJsvbXILffgAmX4pKql+Ln+6UPvSCeKwznvtPaEx+9nMBmKu7Wpbqm/+2ksc0XwjD+xlvlECkCxfD/OJ4gN3IurE0fpjxIkvHDiinQmk51BI7zQD8k1znU7r/spPqB+vZjc5ep6DC5wZUpFu5vJ8MoNKjCu8wnzyCFdA==
     * Wechatpay-Timestamp: 1554209980
     * Wechatpay-Serial: 5157F09EFDC096DE15EBE81A47057A7232F1B8E1
     * Cache-Control: no-cache, must-revalidate
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">verifier</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">Verifier</span> verifier<span class="token punctuation">,</span> <span class="token class-name">String</span> body<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 随机串</span>
        <span class="token class-name">String</span> nonce <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Nonce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取微信传递过来签名</span>
        <span class="token class-name">String</span> signature <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Signature&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 证书序列号</span>
        <span class="token class-name">String</span> serial <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Serial&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 时间戳</span>
        <span class="token class-name">String</span> timestamp <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Wechatpay-Timestamp&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 构造签名串</span>
        <span class="token comment">/**
         * 应答时间戳\n
         * 应答随机串\n
         * 应答报文主体\n
         */</span>
        <span class="token class-name">String</span> signstr <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span>nonce<span class="token punctuation">,</span>body<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> verifier<span class="token punctuation">.</span><span class="token function">verify</span><span class="token punctuation">(</span>serial<span class="token punctuation">,</span>signstr<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token string">&quot;utf-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>signature<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


    <span class="token comment">/**
     * 解密
     * @param bodyMap
     * @param apiv3
     * @return
     * @throws GeneralSecurityException
     */</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">String</span> <span class="token function">decrypt</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span> <span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bodyMap<span class="token punctuation">,</span><span class="token class-name">String</span> apiv3<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 获取通知数据</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> resourceMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> bodyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;resource&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取密文</span>
        <span class="token class-name">String</span> ciphertext <span class="token operator">=</span> resourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;ciphertext&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取随机串</span>
        <span class="token class-name">String</span> nonce <span class="token operator">=</span> resourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;nonce&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 获取附加信息</span>
        <span class="token class-name">String</span> associated_data <span class="token operator">=</span> resourceMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;associated_data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;密文=&gt;{}&quot;</span><span class="token punctuation">,</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 构建aes对象</span>
        <span class="token class-name">AesUtil</span> aesUtil <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AesUtil</span><span class="token punctuation">(</span>apiv3<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6.解密 aes  apiv3</span>
        <span class="token class-name">String</span> plainTest <span class="token operator">=</span> aesUtil<span class="token punctuation">.</span><span class="token function">decryptToString</span><span class="token punctuation">(</span>associated_data<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>nonce<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">,</span>ciphertext<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;明文=&gt;{}&quot;</span><span class="token punctuation">,</span>plainTest<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> plainTest<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>


    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> collect <span class="token operator">=</span> <span class="token class-name">Stream</span><span class="token punctuation">.</span><span class="token function">of</span><span class="token punctuation">(</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">&quot;?&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;=&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;%&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>collect<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br></div></div><p>使用：</p> <p><img src="/javablog/public/assets/img/1717505839675.056a75c2.png" alt="1717505839675"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>        <span class="token comment">//TODO： 签名验证 确保是微信给我们发的消息</span>
        <span class="token keyword">boolean</span> verifier <span class="token operator">=</span> <span class="token class-name">WxVerifierUtils</span><span class="token punctuation">.</span><span class="token function">verifier</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>verifier<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FAIL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>responseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="_16-密文解密和修改订单状态"><a href="#_16-密文解密和修改订单状态" class="header-anchor">#</a> 16, 密文解密和修改订单状态</h3> <p>更新订单状态接口：</p> <p><img src="/javablog/public/assets/img/1717506096329.995c15fd.png" alt="1717506096329"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单id修改订单状态
     * @param id 订单id
     * @param orderStatus 订单状态
     */</span>
    <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span> orderStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717506158753.49b96356.png" alt="1717506158753"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">Long</span> id<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span> orderStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> lo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lo<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getId</span><span class="token punctuation">,</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lo<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getOrderStatus</span><span class="token punctuation">,</span>orderStatus<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>lo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在微信中更新订单状态：</p> <p><img src="/javablog/public/assets/img/1717506426774.09ab5821.png" alt="1717506426774"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 修改订单状态
     * @param bodyMap
     */</span>
    <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bodyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717506938624.5c23a729.png" alt="1717506938624"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bodyMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******************* 修改订单状态 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 获取明文</span>
        <span class="token class-name">String</span> plainText <span class="token operator">=</span> <span class="token class-name">WxVerifierUtils</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>bodyMap<span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getApiV3Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 字符串转为map</span>
        <span class="token class-name">HashMap</span> plainTextMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取订单编号</span>
        <span class="token class-name">String</span> orderNo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 根据订单编号获取订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 判定订单状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">NOTPAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 7. 更新订单状态</span>
        iOrderInfoService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>使用：</p> <p><img src="/javablog/public/assets/img/1717506984510.71513149.png" alt="1717506984510"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//TODO： 处理订单  未支付  已支付</span>
iWxPaymentService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>bodyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717507308130.16e89997.png" alt="1717507308130"></p> <h3 id="_17-添加交易记录"><a href="#_17-添加交易记录" class="header-anchor">#</a> 17, 添加交易记录</h3> <p>添加交易记录目的是为了解决后续的退款。有一个交易记录表：</p> <p><img src="/javablog/public/assets/img/1717507485922.55424f12.png" alt="1717507485922"></p> <p>交易类型枚举：</p> <p><img src="/javablog/public/assets/img/1717507640979.d223e81e.png" alt="1717507640979"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>enums</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">AllArgsConstructor</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span></span><span class="token class-name">Getter</span></span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Getter</span>
<span class="token annotation punctuation">@AllArgsConstructor</span>
<span class="token keyword">public</span> <span class="token keyword">enum</span>  <span class="token class-name">PayType</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 微信
     */</span>
    <span class="token function">WXPAY</span><span class="token punctuation">(</span><span class="token string">&quot;微信&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>


    <span class="token comment">/**
     * 支付宝
     */</span>
    <span class="token function">ALIPAY</span><span class="token punctuation">(</span><span class="token string">&quot;支付宝&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 类型
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span> type<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>接口：</p> <p><img src="/javablog/public/assets/img/1717507515401.756f078c.png" alt="1717507515401"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IPaymentInfoService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 添加交易记录
     * @param plainTextMap
     */</span>
    <span class="token keyword">void</span>  <span class="token function">createPaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> plainTextMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717507672751.588862c1.png" alt="1717507672751"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Slf4j</span>
<span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PaymentInfoServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">PaymentInfoMapper</span><span class="token punctuation">,</span> <span class="token class-name">PaymentInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IPaymentInfoService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">createPaymentInfo</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> plainTextMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;***********  记录交易日志 ************&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 获取订单号</span>
        <span class="token class-name">String</span>  orderNo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 微信支付页面编号</span>
        <span class="token class-name">String</span>  transactionId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;transaction_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 交易类型</span>
        <span class="token class-name">String</span>  tradeType <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_type&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 交易状态</span>
        <span class="token class-name">String</span>  tradeState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 获取用户支付金额</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span>  amount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Integer</span> payer_total <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> amount<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;payer_total&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">PaymentInfo</span> paymentInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PaymentInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setTransactionId</span><span class="token punctuation">(</span>transactionId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 微信  支付宝</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setPaymentType</span><span class="token punctuation">(</span><span class="token class-name">PayType</span><span class="token punctuation">.</span><span class="token constant">WXPAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setTradeType</span><span class="token punctuation">(</span>tradeType<span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setTradeState</span><span class="token punctuation">(</span>tradeState<span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setPayerTotal</span><span class="token punctuation">(</span>payer_total<span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setContent</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>plainTextMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paymentInfo<span class="token punctuation">.</span><span class="token function">setCreateTime</span><span class="token punctuation">(</span><span class="token class-name">LocalDateTime</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>paymentInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>使用：</p> <p><img src="/javablog/public/assets/img/1717507792744.f03ade4f.png" alt="1717507792744"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717507967512.d4b45362.png" alt="1717507967512"></p> <h3 id="_18-reentrantlock数据锁"><a href="#_18-reentrantlock数据锁" class="header-anchor">#</a> 18, ReentrantLock数据锁</h3> <p><img src="/javablog/public/assets/img/1717508000177.0d652e38.png" alt="1717508000177"></p> <p><strong>什么是ReentrantLock：</strong></p> <p>ReentrantLock基于<strong>AQS</strong>，在并发编程中可以实现<strong>公平锁</strong>和<strong>非公平锁</strong>来对资源进行同步，同时，和synchronized一样，ReentrantLock支持<strong>可重入</strong>，ReentrantLock在<strong>调度</strong>上更灵活，支持更多丰富的功能。ReentrantLock是java.util.concurrent包下提供的一套互斥锁，相比Synchronized，ReentrantLock类提供了一些高级功能。</p> <p><strong>公平锁和非公平锁：</strong></p> <p><img src="/javablog/public/assets/img/1717508078685.486e0404.png" alt="1717508078685"></p> <p>第一只兔子还没喝完水又来一只兔子。</p> <p><img src="/javablog/public/assets/img/1717508111517.6be0c67a.png" alt="1717508111517"></p> <p>第一只兔子喝水喝的有点慢，之后来了两只兔子，都被小狗安排进了队列。</p> <p><img src="/javablog/public/assets/img/1717508139389.67938c6d.png" alt="1717508139389"></p> <p><strong>非公平和公平锁的区别：</strong></p> <p><img src="/javablog/public/assets/img/1717508174765.d2c795ff.png" alt="1717508174765"></p> <p><strong>ReentrantLock和synchronized区别：</strong></p> <p><img src="/javablog/public/assets/img/1717508201815.34279f20.png" alt="1717508201815"></p> <ul><li>synchronized是独占锁，加锁和解锁的过程自动进行，易于操作，但不够灵活。ReentrantLock也是独占锁，加锁和解锁的过程需要手动进行，不易操作，但非常灵活。</li> <li>synchronized可重入，因为加锁和解锁自动进行，不必担心最后是否释放锁；ReentrantLock也可重入，但加锁和解锁需要手动进行，且次数需一样，否则其他线程无法获得锁。</li></ul> <p>代码实现：</p> <p><img src="/javablog/public/assets/img/1717508423220.7807e9f6.png" alt="1717508423220"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>	<span class="token comment">// 独占锁</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ReentrantLock</span> lock <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReentrantLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bodyMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;******************* 修改订单状态 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 获取明文</span>
        <span class="token class-name">String</span> plainText <span class="token operator">=</span> <span class="token class-name">WxVerifierUtils</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>bodyMap<span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getApiV3Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 字符串转为map</span>
        <span class="token class-name">HashMap</span> plainTextMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取订单编号</span>
        <span class="token class-name">String</span> orderNo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 尝试获得锁， 如果成功返回true  获取失败立即返回false 不必一直等待锁的释放</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
           <span class="token keyword">try</span><span class="token punctuation">{</span>
               <span class="token comment">// 4. 根据订单编号获取订单信息</span>
               <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 5. 判定订单状态</span>
               <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">NOTPAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token keyword">return</span><span class="token punctuation">;</span>
               <span class="token punctuation">}</span>
               <span class="token comment">// 7. 更新订单状态</span>
               iOrderInfoService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
               <span class="token comment">// 8. 添加一条交易记录日志</span>
               iPaymentInfoService<span class="token punctuation">.</span><span class="token function">createPaymentInfo</span><span class="token punctuation">(</span>plainTextMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token comment">// 手动释放锁</span>
               lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
           <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h3 id="_19-查询订单"><a href="#_19-查询订单" class="header-anchor">#</a> 19, 查询订单</h3> <p>商户后台未收到异步支付结果通知时，商户应该主动调用《微信支付查单接口》，同步订单状态。</p> <p><strong>接口说明:</strong></p> <ul><li><p>请求URL：/api/wx-pay/queryOrderStatus/{orderNo}</p></li> <li><p>请求方式：GET</p></li></ul> <p><strong>请求参数:</strong></p> <table><thead><tr><th>参数名</th> <th>变量</th> <th>必填</th></tr></thead> <tbody><tr><td>订单编号</td> <td>orderNo</td> <td>是</td></tr></tbody></table> <p>接口：</p> <p><img src="/javablog/public/assets/img/1717508784609.6ff94448.png" alt="1717508784609"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单编号查询订单信息
     * @param orderNo
     * @return
     */</span>
    <span class="token class-name">String</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717510801478.648ef51b.png" alt="1717510801478"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;*************  查询订单信息 *********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">// 1. 组装请求url地址 https://api.mch.weixin.qq.com/v3/pay/transactions/out-trade-no/1217752501201407033233368018?mchid=1230000109</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token class-name">WxApiType</span><span class="token punctuation">.</span><span class="token constant">ORDER_QUERY_BY_NO</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        url <span class="token operator">=</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token string">&quot;?mchid=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>wxPayConfig<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 获取httpget</span>
        <span class="token class-name">HttpGet</span> httpGet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpGet</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpGet<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 完成签名后发起请求</span>
        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> wxPayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpGet<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 4. 获取响应体body</span>
            <span class="token class-name">String</span> bodyString <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5. 获取状态码</span>
            <span class="token keyword">int</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 6. 判断状态码</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;查询成功 =&gt;{}&quot;</span><span class="token punctuation">,</span>bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 处理成功  没有body</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;查询订单接口失败&quot;</span><span class="token operator">+</span>statusCode <span class="token operator">+</span> <span class="token string">&quot;返回结果 &quot;</span> <span class="token operator">+</span> bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;request failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> bodyString<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><p>控制层：</p> <p><img src="/javablog/public/assets/img/1717511866908.db77af48.png" alt="1717511866908"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 查询订单
     *
     * @param orderNo
     * @return
     */</span>
    <span class="token annotation punctuation">@GetMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/queryOrder/{orderNo}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">queryOrder</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span>iWxPaymentService<span class="token punctuation">.</span><span class="token function">queryOrder</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717511851612.f6e8c81d.png" alt="1717511851612"></p> <h3 id="_20-集成springtask"><a href="#_20-集成springtask" class="header-anchor">#</a> 20, 集成SpringTask</h3> <p><strong>什么是Spring Task：</strong></p> <p>Spring 3.0后提供Spring Task实现任务调度。</p> <p><strong>Cron表达式：</strong></p> <table><thead><tr><th>名称</th> <th>藐视</th></tr></thead> <tbody><tr><td>Seconds (秒)</td> <td>可以用数字0－59 表示</td></tr> <tr><td>Minutes(分)</td> <td>可以用数字0－59 表示</td></tr> <tr><td>Hours(时)</td> <td>可以用数字0-23表示</td></tr> <tr><td>Day-of-Month(天)</td> <td>可以用数字1-31 中的任一一个值，但要注意一些特别的月份</td></tr> <tr><td>Month(月)</td> <td>可以用0-11</td></tr> <tr><td>Day-of-Week(每周)</td> <td>以用数字1-7表示（1 ＝ 星期日）</td></tr></tbody></table> <p><strong>参数：</strong></p> <ul><li>* ： 表示所有值；</li> <li>?： 表示未说明的值，即不关心它为何值；</li> <li>-：表示一个指定的范围；</li> <li>, ：表示附加一个可能值；</li> <li>/ ：符号前表示开始时间，符号后表示每次递增的值；</li></ul> <p>代码：</p> <p><img src="/javablog/public/assets/img/1717512308737.f4976233.png" alt="1717512308737"></p> <p><img src="/javablog/public/assets/img/1717512244012.81ccf0d3.png" alt="1717512244012"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>task</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>entity<span class="token punctuation">.</span></span><span class="token class-name">OrderInfo</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IOrderInfoService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">com<span class="token punctuation">.</span>ityls<span class="token punctuation">.</span>service<span class="token punctuation">.</span></span><span class="token class-name">IWxPaymentService</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>scheduling<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Scheduled</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype<span class="token punctuation">.</span></span><span class="token class-name">Component</span></span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>io<span class="token punctuation">.</span></span><span class="token class-name">IOException</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Duration</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>time<span class="token punctuation">.</span></span><span class="token class-name">Instant</span></span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">List</span></span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 微信任务调度
 */</span>
<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPaymentTask</span> <span class="token punctuation">{</span>

    <span class="token comment">// 秒 分 时 天 月 周</span>
   <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/3 * * * * *&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;**********  test 执行了 ******&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br></div></div><p>查看：</p> <p><img src="/javablog/public/assets/img/1717512321161.761f677b.png" alt="1717512321161"></p> <p>常用表达式：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>0 0 2 1 * ? *  表示在每月的1日的凌晨2点调整任务
0 0 10,14,16 * * ?  每天上午10点，下午2点，4点 
0 0/30 9-17 * * ?  朝九晚五工作时间内每半小时 
0 0 12 * * ?  每天中午12点触发 
0 15 10 ? * *  每天上午10:15触发 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="_21-定时查找超时订单"><a href="#_21-定时查找超时订单" class="header-anchor">#</a> 21, 定时查找超时订单</h3> <p>创建超时订单接口：</p> <p><img src="/javablog/public/assets/img/1717512552483.94f871b8.png" alt="1717512552483"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 查询超时订单
     * @param minutes 分钟
     * @return
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTimeOutOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> minutes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717512630126.27c4dddb.png" alt="1717512630126"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 超时订单
     * @param minutes 分钟
     * @return
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> <span class="token function">getTimeOutOrder</span><span class="token punctuation">(</span><span class="token keyword">int</span> minutes<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. 获取5分钟之前的时间</span>
        <span class="token class-name">Instant</span> instant <span class="token operator">=</span> <span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">minus</span><span class="token punctuation">(</span><span class="token class-name">Duration</span><span class="token punctuation">.</span><span class="token function">ofMinutes</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 查询条件构造器</span>
        <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> lambdaQueryWrapper <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaQueryWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 订单类型</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getOrderStatus</span><span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">NOTPAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 小于订单创建时间</span>
        lambdaQueryWrapper<span class="token punctuation">.</span><span class="token function">le</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getCreateTime</span><span class="token punctuation">,</span>instant<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 查询</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> orderInfos <span class="token operator">=</span> baseMapper<span class="token punctuation">.</span><span class="token function">selectList</span><span class="token punctuation">(</span>lambdaQueryWrapper<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> orderInfos<span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>定时任务：</p> <p><img src="/javablog/public/assets/img/1717512753401.9382ee43.png" alt="1717512753401"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WxPaymentTask</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">IOrderInfoService</span> iOrderInfoService<span class="token punctuation">;</span> <span class="token comment">// 订单接口</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">IWxPaymentService</span> iWxPaymentService<span class="token punctuation">;</span>


    <span class="token comment">// 秒 分 时 天 月 周</span>
   <span class="token comment">// @Scheduled(cron = &quot;0/3 * * * * *&quot;)</span>
   <span class="token comment">//  public void test(){</span>
   <span class="token comment">//      log.info(&quot;**********  test 执行了 ******&quot;);</span>
   <span class="token comment">//  }</span>
    <span class="token comment">// 从0秒开始每隔30秒执行一次，查询创建超过5分钟，并且没有支付的订单</span>
    <span class="token annotation punctuation">@Scheduled</span><span class="token punctuation">(</span>cron <span class="token operator">=</span> <span class="token string">&quot;0/3 * * * * *&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span>  <span class="token function">timeoutOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;**********  开始查询超过订单 ********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> timeOutOrder <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">getTimeOutOrder</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">:</span> timeOutOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// iWxPaymentService.checkOrderStatus(orderInfo.getOrderNo());</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717512862465.a2a3cf63.png" alt="1717512862465"></p> <h3 id="_22-核实订单状态"><a href="#_22-核实订单状态" class="header-anchor">#</a> 22, 核实订单状态</h3> <p>接口：</p> <p><img src="/javablog/public/assets/img/1717513000671.69a09ae3.png" alt="1717513000671"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 检查订单状态
     * @param orderNo 订单编号
     */</span>
    <span class="token keyword">void</span> <span class="token function">checkOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717513262597.3e8baed6.png" alt="1717513262597"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">checkOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************ 根据订单编号核实订单状态 ********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 根据订单编号查询订单信息</span>
        <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">queryOrder</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. JSON转Map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span><span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>result<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取微信订单状态</span>
        <span class="token class-name">String</span> tradeState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;trade_state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 判断订单状态</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>tradeState<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">WxTradeState</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;核实订单已支付==========&gt;{}&quot;</span><span class="token punctuation">,</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 5. 如果确认订单支付，则更新本地订单状态</span>
            iOrderInfoService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 6. 记录支付日志</span>
            iPaymentInfoService<span class="token punctuation">.</span><span class="token function">createPaymentInfo</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 8. 关单处理</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>tradeState<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">WxTradeState</span><span class="token punctuation">.</span><span class="token constant">NOTPAY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token comment">// 调用微信关单api关闭订单</span>
            <span class="token comment">// this.cancelOrder(orderNo);</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>再实现根据订单的编号修改状态：</p> <p><img src="/javablog/public/assets/img/1717513312758.e7c2232a.png" alt="1717513312758"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单编号修改订单状态
     * @param orderNo 订单编号
     * @param orderStatus 订单状态
     */</span>
    <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span>  orderNo<span class="token punctuation">,</span><span class="token class-name">OrderStatus</span> orderStatus<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717513374678.1b96355b.png" alt="1717513374678"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateOrderStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">OrderStatus</span> orderStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">OrderInfo</span><span class="token punctuation">&gt;</span></span> lo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        lo<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getOrderNo</span><span class="token punctuation">,</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        lo<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">OrderInfo</span><span class="token operator">::</span><span class="token function">getOrderStatus</span><span class="token punctuation">,</span>orderStatus<span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>lo<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>查看之前的报错：</p> <p><img src="/javablog/public/assets/img/1717513415088.c4fd3885.png" alt="1717513415088"></p> <p>如果订单状态是没有支付，那么在数据库中也修改一下状态：</p> <p><img src="/javablog/public/assets/img/1717513612225.b478d07c.png" alt="1717513612225"></p> <p>使用：</p> <p><img src="/javablog/public/assets/img/1717513454341.d15c5929.png" alt="1717513454341"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717514435264.ff4e18b5.png" alt="1717514435264"></p> <h3 id="_23-关闭订单"><a href="#_23-关闭订单" class="header-anchor">#</a> 23, 关闭订单</h3> <p><strong>接口说明：</strong></p> <ul><li><p>请求URL：/api/wx-pay/cancel/{orderNo}</p></li> <li><p>请求方式：POST</p></li></ul> <p><strong>请求参数：</strong></p> <table><thead><tr><th>参数名</th> <th>变量</th> <th>必填</th></tr></thead> <tbody><tr><td>订单编号</td> <td>orderNo</td> <td>是</td></tr></tbody></table> <p>接口：</p> <p><img src="/javablog/public/assets/img/1717514631229.bbbb26b8.png" alt="1717514631229"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单编号关闭订单
     * @param orderNo
     */</span>
    <span class="token keyword">void</span> <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717514713623.53175449.png" alt="1717514713623"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">cancelOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        iOrderInfoService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">CANCEL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>控制层：</p> <p><img src="/javablog/public/assets/img/1717514759033.c0ed224c.png" alt="1717514759033"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单编号取消订单
     * @param orderNo
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/cancel/{orderNo}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        iWxPaymentService<span class="token punctuation">.</span><span class="token function">cancelOrder</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token string">&quot;订单已取消&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717514898884.3e17d25e.png" alt="1717514898884"></p> <p><img src="/javablog/public/assets/img/1717514913338.fab887f4.png" alt="1717514913338"></p> <h3 id="_24-调用微信支付的关单接口"><a href="#_24-调用微信支付的关单接口" class="header-anchor">#</a> 24, 调用微信支付的关单接口</h3> <p><strong>以下情况需要调用关单接口：</strong></p> <ul><li>1、商户订单支付失败需要生成新单号重新发起支付，要对原订单号调用关单，避免重复支付；</li> <li>2、系统下单后，用户支付超时，系统退出不再受理，避免用户继续，请调用关单接口。</li></ul> <p><strong>注意：</strong></p> <p>关单没有时间限制，建议在订单生成后间隔几分钟（最短5分钟）再调用关单接口，避免出现订单状态同步不及时导致关单失败。</p> <p>代码：</p> <p><img src="/javablog/public/assets/img/1717515233487.bf74b215.png" alt="1717515233487"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 根据订单编号修改微信后台的订单状态
     * @param orderNo
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">void</span>  <span class="token function">closeOrder</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************  关单接口调用 **********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 组装请求url地址</span>
        <span class="token class-name">String</span> url <span class="token operator">=</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span>wxPayConfig<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxApiType</span><span class="token punctuation">.</span><span class="token constant">CLOSE_ORDER_BY_NO</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取HTTPpost</span>
        <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 组装参数</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;mchid&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getMchId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 将参数转换为json字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 准备消息 boby</span>
        <span class="token class-name">StringEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 准备请求头</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7.完成签名并执行请求</span>
        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> wxPayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 8. 获取状态码</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 处理成功</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;关单成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;关单成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;关单失败，响应码 = &quot;</span><span class="token operator">+</span> statusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;requset failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>调用：</p> <p><img src="/javablog/public/assets/img/1717515428628.38fec4e9.png" alt="1717515428628"></p> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717515481918.2bba6cb4.png" alt="1717515481918"></p> <p><img src="/javablog/public/assets/img/1717515506647.2c816632.png" alt="1717515506647"></p> <p><img src="/javablog/public/assets/img/1717515523223.ea7b08f8.png" alt="1717515523223"></p> <p><img src="/javablog/public/assets/img/1717515595757.d4b80f66.png" alt="1717515595757"></p> <p><img src="/javablog/public/assets/img/1717515608874.bc1b3bba.png" alt="1717515608874"></p> <p>超时时，也需要取消订单：</p> <p><img src="/javablog/public/assets/img/1717515796710.6fe39be7.png" alt="1717515796710"></p> <h3 id="_25-退款单"><a href="#_25-退款单" class="header-anchor">#</a> 25, 退款单</h3> <p><strong>接口说明：</strong></p> <ul><li><p>请求URL：/api/wx-pay/refunds/{orderNo}/{reason}</p></li> <li><p>请求方式：POST</p></li></ul> <p><strong>请求参数：</strong></p> <table><thead><tr><th>参数名</th> <th>变量</th> <th>必填</th></tr></thead> <tbody><tr><td>订单编号</td> <td>orderNo</td> <td>是</td></tr> <tr><td>退款理由</td> <td>reason</td> <td>是</td></tr></tbody></table> <p>接口：</p> <p><img src="/javablog/public/assets/img/1717516187792.a0ffc63e.png" alt="1717516187792"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">IRefundInfoService</span> <span class="token keyword">extends</span> <span class="token class-name">IService</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 根据订单编号创建退款单
     * @param orderNo 订单编号
     * @param reason 退款理由
     * @return
     */</span>
    <span class="token class-name">RefundInfo</span>  <span class="token function">createRefundsByOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">,</span><span class="token class-name">String</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717516264775.c0a520f8.png" alt="1717516264775"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Service</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RefundInfoServiceImpl</span> <span class="token keyword">extends</span> <span class="token class-name">ServiceImpl</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfoMapper</span><span class="token punctuation">,</span> <span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">implements</span> <span class="token class-name">IRefundInfoService</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Autowired</span>
    <span class="token class-name">IOrderInfoService</span> iOrderInfoService<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">RefundInfo</span> <span class="token function">createRefundsByOrderNo</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. 根据订单编号查询订单信息</span>
        <span class="token class-name">OrderInfo</span> orderInfo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 根据订单号生成退款单</span>
        <span class="token class-name">RefundInfo</span> refundInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RefundInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 订单编号</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setOrderNo</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 退款编号</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setRefundNo</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 原订单金额（分）</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setTotalFee</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 退款金额</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setRefund</span><span class="token punctuation">(</span>orderInfo<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 7. 退款原因</span>
        refundInfo<span class="token punctuation">.</span><span class="token function">setReason</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span>refundInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> refundInfo<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>接口：</p> <p><img src="/javablog/public/assets/img/1717516012918.5e9a2f24.png" alt="1717516012918"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 退款
     * @param orderNo 退款编号
     * @param reason 退款理由
     */</span>
    <span class="token keyword">void</span> <span class="token function">refund</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">,</span><span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717516333566.3be29ffa.png" alt="1717516333566"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 退款
     * @param orderNo 退款编号
     * @param reason 退款理由
     */</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">refund</span><span class="token punctuation">(</span><span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;*************  创建退款单 ******&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 根据订单编号创建退款单</span>
        <span class="token class-name">RefundInfo</span> refundInfo <span class="token operator">=</span> iRefundInfoService<span class="token punctuation">.</span><span class="token function">createRefundsByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>

        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************ 正在调用微信支付申请退款API ********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 调用申请退款</span>
        <span class="token class-name">HttpPost</span> httpPost <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpPost</span><span class="token punctuation">(</span>wxPayConfig<span class="token punctuation">.</span><span class="token function">getDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxApiType</span><span class="token punctuation">.</span><span class="token constant">DOMESTIC_REFUNDS</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 3. 组装请求参数</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> paramsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">,</span> refundInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 订单编号</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;out_refund_no&quot;</span><span class="token punctuation">,</span> refundInfo<span class="token punctuation">.</span><span class="token function">getRefundNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 商户退款单号</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;reason&quot;</span><span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 退款原因</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;notify_url&quot;</span><span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getNotifyDomain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token class-name">WxNotifyType</span><span class="token punctuation">.</span><span class="token constant">REFUND_NOTIFY</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 退款结果回调url</span>

        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> amountMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        amountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;refund&quot;</span><span class="token punctuation">,</span> refundInfo<span class="token punctuation">.</span><span class="token function">getRefund</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 退款金额</span>
        amountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;total&quot;</span><span class="token punctuation">,</span> refundInfo<span class="token punctuation">.</span><span class="token function">getTotalFee</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 原始订单金额</span>
        amountMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;currency&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;CNY&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 退款金额</span>
        paramsMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;amount&quot;</span><span class="token punctuation">,</span> amountMap<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 金额</span>

        <span class="token comment">// 4. 将参数转换为json字符串</span>
        <span class="token class-name">String</span> jsonString <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>paramsMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;申请退款参数=======&gt;{}&quot;</span> <span class="token operator">+</span> jsonString<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 准备消息 boby</span>
        <span class="token class-name">StringEntity</span> entity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringEntity</span><span class="token punctuation">(</span>jsonString<span class="token punctuation">,</span> <span class="token string">&quot;UTF-8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        entity<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setEntity</span><span class="token punctuation">(</span>entity<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 6. 准备请求头</span>
        httpPost<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">&quot;Accept&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;application/json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 7.完成签名并执行请求</span>
        <span class="token class-name">CloseableHttpResponse</span> response <span class="token operator">=</span> wxPayClient<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>httpPost<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 8. 获取响应体body</span>
            <span class="token class-name">String</span> bodyString <span class="token operator">=</span> <span class="token class-name">EntityUtils</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">getEntity</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 9. 获取状态码</span>
            <span class="token keyword">int</span> statusCode <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getStatusLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getStatusCode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 10. 判断状态码</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;退款成功 =&gt;{}&quot;</span><span class="token punctuation">,</span>bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>statusCode <span class="token operator">==</span> <span class="token number">204</span><span class="token punctuation">)</span><span class="token punctuation">{</span><span class="token comment">// 处理成功  没有body</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;退款成功 =&gt;{}&quot;</span><span class="token punctuation">,</span>bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;申请退款接口失败&quot;</span><span class="token operator">+</span>statusCode <span class="token operator">+</span> <span class="token string">&quot;返回结果 &quot;</span> <span class="token operator">+</span> bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">throw</span>  <span class="token keyword">new</span> <span class="token class-name">IOException</span><span class="token punctuation">(</span><span class="token string">&quot;request failed&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 11.更新订单状态  支付成功  -》   退款中</span>
            iOrderInfoService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>refundInfo<span class="token punctuation">.</span><span class="token function">getOrderNo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">REFUND_PROCESSING</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 12. 更新退款单</span>
            <span class="token comment">// iRefundInfoService.updateRefund(bodyString);</span>
        <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br></div></div><p>更新退款单接口：</p> <p><img src="/javablog/public/assets/img/1717517340178.df1abe35.png" alt="1717517340178"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 更新退款单
     * @param bodyString
     */</span>
   <span class="token keyword">void</span>  <span class="token function">updateRefund</span><span class="token punctuation">(</span><span class="token class-name">String</span> bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717517388842.40f3c2ee.png" alt="1717517388842"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 更新退款单
     * @param bodyString 微信返回的退款json数据
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateRefund</span><span class="token punctuation">(</span><span class="token class-name">String</span> bodyString<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">// 1. json转 Map</span>
        <span class="token class-name">Map</span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>bodyString<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取退款状态</span>
        <span class="token class-name">String</span>  status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取微信支付退款单号</span>
        <span class="token class-name">String</span>  refundId <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;refund_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 4. 获取商户退款单号</span>
        <span class="token class-name">String</span>  refundNo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_refund_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> refundInfoLambd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfoLambd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RefundInfo</span><span class="token operator">::</span><span class="token function">getRefundStatus</span><span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfoLambd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RefundInfo</span><span class="token operator">::</span><span class="token function">getRefundId</span><span class="token punctuation">,</span>refundId<span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfoLambd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RefundInfo</span><span class="token operator">::</span><span class="token function">getContentReturn</span><span class="token punctuation">,</span>bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfoLambd<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">RefundInfo</span><span class="token operator">::</span><span class="token function">getRefundNo</span><span class="token punctuation">,</span>refundNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>refundInfoLambd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>使用：</p> <p><img src="/javablog/public/assets/img/1717517430372.fa77fea3.png" alt="1717517430372"></p> <p>控制层：</p> <p><img src="/javablog/public/assets/img/1717517562414.b05da4df.png" alt="1717517562414"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 申请退款
     *
     * @param orderNo 订单编号
     * @param reason  退款理由
     * @return
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/refund/{orderNo}/{reason}&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">BaseResult</span> <span class="token function">refund</span><span class="token punctuation">(</span><span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> orderNo<span class="token punctuation">,</span> <span class="token annotation punctuation">@PathVariable</span> <span class="token class-name">String</span> reason<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        iWxPaymentService<span class="token punctuation">.</span><span class="token function">refund</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">,</span> reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token class-name">BaseResult</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><strong>调用微信支付退款API:</strong></p> <p>交易发生之后一年内，由于买家或者卖家的原因需要退款时，卖家可以通过退款接口将支付金额退还给买家，微信支付将在收到退款请求并且验证成功之后，将支付款按原路退还至买家账号上。</p> <p><strong>注意:</strong></p> <ol><li><p>交易时间超过一年的订单无法提交退款</p></li> <li><p>微信支付退款支持单笔交易分多次退款（不超50次），多次退款需要提交原支付订单的商户订单号和设置不同的退款单号。申请退款总金额不能超过订单金额。 一笔退款失败后重新提交，请不要更换退款单号，请使用原商户退款单号</p></li> <li><p>错误或无效请求频率限制：6qps，即每秒钟异常或错误的退款申请请求不超过6次</p></li> <li><p>每个支付订单的部分退款次数不能超过50次</p></li> <li><p>如果同一个用户有多笔退款，建议分不同批次进行退款，避免并发退款导致退款失败</p></li> <li><p>申请退款接口的返回仅代表业务的受理情况，具体退款是否成功，需要通过退款查询接口获取结果</p></li> <li><p>一个月之前的订单申请退款频率限制为：5000/min</p></li> <li><p>同一笔订单多次退款的请求需相隔1分钟</p></li></ol> <p>测试：</p> <p><img src="/javablog/public/assets/img/1717517678737.1b4d415e.png" alt="1717517678737"></p> <p><img src="/javablog/public/assets/img/1717517774154.a7ee7118.png" alt="1717517774154"></p> <p><img src="/javablog/public/assets/img/1717517874678.5a3c4608.png" alt="1717517874678"></p> <p><img src="/javablog/public/assets/img/1717517921710.f165522a.png" alt="1717517921710"></p> <h3 id="_26-退款结果通知"><a href="#_26-退款结果通知" class="header-anchor">#</a> 26, 退款结果通知</h3> <p>退款状态改变后，微信会把相关退款结果发送给商户。</p> <p><strong>注意：</strong></p> <ul><li><p>对后台通知交互时，如果微信收到应答不是成功或超时，微信认为通知失败，微信会通过一定的策略定期重新发起通知，尽可能提高通知的成功率，但微信不保证通知最终能成功。</p></li> <li><p>**特别提醒：**商户系统对于开启结果通知的内容一定要做签名验证，并校验通知的信息是否与商户侧的信息一致，防止数据泄露导致出现“假通知”，造成资金损失。</p></li></ul> <p>退款的回调：</p> <p><img src="/javablog/public/assets/img/1717518076361.4ae4d2cc.png" alt="1717518076361"></p> <p>接口：</p> <p><img src="/javablog/public/assets/img/1717518208168.7f099ad7.png" alt="1717518208168"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 处理退款
     * @param resultMap
     */</span>
    <span class="token keyword">void</span> <span class="token function">processRefunds</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717518282548.0f883d11.png" alt="1717518282548"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 处理退款单
     * @param resultMap
     */</span>
    <span class="token annotation punctuation">@Transactional</span><span class="token punctuation">(</span>rollbackFor <span class="token operator">=</span> <span class="token class-name">Exception</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">processRefunds</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> resultMap<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;************ 处理退款单 ********&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 1. 获取明文</span>
        <span class="token class-name">String</span> plainText <span class="token operator">=</span> <span class="token class-name">WxVerifierUtils</span><span class="token punctuation">.</span><span class="token function">decrypt</span><span class="token punctuation">(</span>resultMap<span class="token punctuation">,</span> wxPayConfig<span class="token punctuation">.</span><span class="token function">getApiV3Key</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 字符串转为map</span>
        <span class="token class-name">HashMap</span> plainTextMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>plainText<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取订单编号</span>
        <span class="token class-name">String</span> orderNo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> plainTextMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_trade_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                <span class="token comment">// 4. 根据订单编号查询订单信息</span>
                <span class="token class-name">OrderInfo</span> byOrderNo <span class="token operator">=</span> iOrderInfoService<span class="token punctuation">.</span><span class="token function">findByOrderNo</span><span class="token punctuation">(</span>orderNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 5. 判断是否已经更新过</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">REFUND_PROCESSING</span><span class="token punctuation">.</span><span class="token function">getType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span>byOrderNo<span class="token punctuation">.</span><span class="token function">getOrderStatus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
                    <span class="token keyword">return</span> <span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token comment">// 6. 更新订单状态</span>
                iOrderInfoService<span class="token punctuation">.</span><span class="token function">updateOrderStatus</span><span class="token punctuation">(</span>byOrderNo<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><span class="token class-name">OrderStatus</span><span class="token punctuation">.</span><span class="token constant">REFUND_SUCCESS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">// 7. 更新退款单状态</span>
                iRefundInfoService<span class="token punctuation">.</span><span class="token function">updateRefundStatus</span><span class="token punctuation">(</span>plainText<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>
                lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//主动释放锁</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><p>接口：</p> <p><img src="/javablog/public/assets/img/1717518361227.f51f2d61.png" alt="1717518361227"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 更新退款单
     * @param bodyString
     */</span>
    <span class="token keyword">void</span>  <span class="token function">updateRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> bodyString<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>实现类：</p> <p><img src="/javablog/public/assets/img/1717518396592.7a70c22a.png" alt="1717518396592"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 更新退款单状态
     * @param bodyString
     */</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">updateRefundStatus</span><span class="token punctuation">(</span><span class="token class-name">String</span> bodyString<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1. json转 Map</span>
        <span class="token class-name">Map</span> resultMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>bodyString<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 获取退款状态</span>
        <span class="token class-name">String</span>  status <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;refund_status&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 获取商户退款单号</span>
        <span class="token class-name">String</span>  refundNo <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span> resultMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;out_refund_no&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">RefundInfo</span><span class="token punctuation">&gt;</span></span> refundInfoLambd <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LambdaUpdateWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfoLambd<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token class-name">RefundInfo</span><span class="token operator">::</span><span class="token function">getRefundStatus</span><span class="token punctuation">,</span>status<span class="token punctuation">)</span><span class="token punctuation">;</span>
        refundInfoLambd<span class="token punctuation">.</span><span class="token function">eq</span><span class="token punctuation">(</span><span class="token class-name">RefundInfo</span><span class="token operator">::</span><span class="token function">getRefundNo</span><span class="token punctuation">,</span>refundNo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        baseMapper<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span>refundInfoLambd<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>控制层：</p> <p><img src="/javablog/public/assets/img/1717518574699.c87d6a48.png" alt="1717518574699"></p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>    <span class="token comment">/**
     * 退款通知
     *
     * @param request
     * @param response
     * @return
     * @throws UnsupportedEncodingException
     * @throws GeneralSecurityException
     */</span>
    <span class="token annotation punctuation">@PostMapping</span><span class="token punctuation">(</span><span class="token string">&quot;/refunds/notify&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">refunds</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span> <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">UnsupportedEncodingException</span><span class="token punctuation">,</span> <span class="token class-name">GeneralSecurityException</span> <span class="token punctuation">{</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> responseMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 1. 获取报文body</span>
        <span class="token class-name">String</span> body <span class="token operator">=</span> <span class="token class-name">HttpUtils</span><span class="token punctuation">.</span><span class="token function">readData</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 2. 把json转换为map</span>
        <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> bodyMap <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parseObject</span><span class="token punctuation">(</span>body<span class="token punctuation">,</span> <span class="token class-name">HashMap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;支付通知id======&gt; {}&quot;</span><span class="token punctuation">,</span> bodyMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;支付通知完整数据=======&gt; {}&quot;</span><span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>


        <span class="token comment">//TODO： 签名验证 确保是微信给我们发的消息</span>
        <span class="token keyword">boolean</span> verifier <span class="token operator">=</span> <span class="token class-name">WxVerifierUtils</span><span class="token punctuation">.</span><span class="token function">verifier</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>verifier<span class="token punctuation">,</span> body<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>verifier<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;FAIL&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;失败&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>responseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 处理退款单</span>
        iWxPaymentService<span class="token punctuation">.</span><span class="token function">processRefunds</span><span class="token punctuation">(</span>bodyMap<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 成功应答： 成功就是200 否则就是失败的应答</span>
        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;SUCCESS&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        responseMap<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;message&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;成功&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">toJSONString</span><span class="token punctuation">(</span>responseMap<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><p>测试：</p> <p><img src="/javablog/public/assets/img/1717518619554.8a7fe528.png" alt="1717518619554"></p> <p><img src="/javablog/public/assets/img/1717518691827.b27500fb.png" alt="1717518691827"></p> <p><img src="/javablog/public/assets/img/1717518735724.959bfb0a.png" alt="1717518735724"></p> <p><img src="/javablog/public/assets/img/1717518762377.fa5657dc.png" alt="1717518762377"></p></div></section> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">6/5/2024, 12:40:39 AM</span></div></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#一-支付介绍与准备工作" class="sidebar-link reco-side-一-支付介绍与准备工作" data-v-b57cc07c>一，支付介绍与准备工作</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_1-产品介绍" class="sidebar-link reco-side-_1-产品介绍" data-v-b57cc07c>1, 产品介绍</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_2-前期准备工作之获取商户号" class="sidebar-link reco-side-_2-前期准备工作之获取商户号" data-v-b57cc07c>2, 前期准备工作之获取商户号</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_3-前期准备工作之获取微信公众appid" class="sidebar-link reco-side-_3-前期准备工作之获取微信公众appid" data-v-b57cc07c>3, 前期准备工作之获取微信公众APPID</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_4-前期准备工作之设置证书和密钥" class="sidebar-link reco-side-_4-前期准备工作之设置证书和密钥" data-v-b57cc07c>4, 前期准备工作之设置证书和密钥</a></li><li class="level-2" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#二-支付安全" class="sidebar-link reco-side-二-支付安全" data-v-b57cc07c>二，支付安全</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_1-信息安全的基础" class="sidebar-link reco-side-_1-信息安全的基础" data-v-b57cc07c>1, 信息安全的基础</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_2-消息摘要" class="sidebar-link reco-side-_2-消息摘要" data-v-b57cc07c>2, 消息摘要</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_3-对称加密" class="sidebar-link reco-side-_3-对称加密" data-v-b57cc07c>3, 对称加密</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_4-非对称加密之公钥加密和私钥解密" class="sidebar-link reco-side-_4-非对称加密之公钥加密和私钥解密" data-v-b57cc07c>4, 非对称加密之公钥加密和私钥解密</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_6-数字签名" class="sidebar-link reco-side-_6-数字签名" data-v-b57cc07c>6, 数字签名</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_7-数字证书" class="sidebar-link reco-side-_7-数字证书" data-v-b57cc07c>7, 数字证书</a></li><li class="level-2" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#三-支付工程准备" class="sidebar-link reco-side-三-支付工程准备" data-v-b57cc07c>三，支付工程准备</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_1-创建支付工程" class="sidebar-link reco-side-_1-创建支付工程" data-v-b57cc07c>1, 创建支付工程</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_2-创建数据库表" class="sidebar-link reco-side-_2-创建数据库表" data-v-b57cc07c>2, 创建数据库表</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_3-集成mybatis-plus" class="sidebar-link reco-side-_3-集成mybatis-plus" data-v-b57cc07c>3, 集成MyBatis-Plus</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_4-mybatis-plus代码生成器" class="sidebar-link reco-side-_4-mybatis-plus代码生成器" data-v-b57cc07c>4, MyBatis-Plus代码生成器</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_5-统一结果返回封装类" class="sidebar-link reco-side-_5-统一结果返回封装类" data-v-b57cc07c>5, 统一结果返回封装类</a></li><li class="level-2" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#四-实现支付" class="sidebar-link reco-side-四-实现支付" data-v-b57cc07c>四，实现支付</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_1-引入微信支付配置参数" class="sidebar-link reco-side-_1-引入微信支付配置参数" data-v-b57cc07c>1, 引入微信支付配置参数</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_2-配置商户证书" class="sidebar-link reco-side-_2-配置商户证书" data-v-b57cc07c>2, 配置商户证书</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_3-加载平台证书和获取httpclient对象" class="sidebar-link reco-side-_3-加载平台证书和获取httpclient对象" data-v-b57cc07c>3, 加载平台证书和获取HttpClient对象</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_4-native支付api列表" class="sidebar-link reco-side-_4-native支付api列表" data-v-b57cc07c>4, Native支付API列表</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_5-native支付流程" class="sidebar-link reco-side-_5-native支付流程" data-v-b57cc07c>5, Native支付流程</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_6-创建订单" class="sidebar-link reco-side-_6-创建订单" data-v-b57cc07c>6, 创建订单</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_7-native下单之查询订单" class="sidebar-link reco-side-_7-native下单之查询订单" data-v-b57cc07c>7, Native下单之查询订单</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_8-native下单之组装参数" class="sidebar-link reco-side-_8-native下单之组装参数" data-v-b57cc07c>8, Native下单之组装参数</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_9-native下单之返回二维码链接" class="sidebar-link reco-side-_9-native下单之返回二维码链接" data-v-b57cc07c>9, Native下单之返回二维码链接</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_10-二维码生成" class="sidebar-link reco-side-_10-二维码生成" data-v-b57cc07c>10, 二维码生成</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_11-重复支付解决" class="sidebar-link reco-side-_11-重复支付解决" data-v-b57cc07c>11, 重复支付解决</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_12-内网穿透" class="sidebar-link reco-side-_12-内网穿透" data-v-b57cc07c>12, 内网穿透</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_13-下载安装内网穿透" class="sidebar-link reco-side-_13-下载安装内网穿透" data-v-b57cc07c>13, 下载安装内网穿透</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_14-接收通知" class="sidebar-link reco-side-_14-接收通知" data-v-b57cc07c>14, 接收通知</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_15-修改订单状态之验签" class="sidebar-link reco-side-_15-修改订单状态之验签" data-v-b57cc07c>15, 修改订单状态之验签</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_16-密文解密和修改订单状态" class="sidebar-link reco-side-_16-密文解密和修改订单状态" data-v-b57cc07c>16, 密文解密和修改订单状态</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_17-添加交易记录" class="sidebar-link reco-side-_17-添加交易记录" data-v-b57cc07c>17, 添加交易记录</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_18-reentrantlock数据锁" class="sidebar-link reco-side-_18-reentrantlock数据锁" data-v-b57cc07c>18, ReentrantLock数据锁</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_19-查询订单" class="sidebar-link reco-side-_19-查询订单" data-v-b57cc07c>19, 查询订单</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_20-集成springtask" class="sidebar-link reco-side-_20-集成springtask" data-v-b57cc07c>20, 集成SpringTask</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_21-定时查找超时订单" class="sidebar-link reco-side-_21-定时查找超时订单" data-v-b57cc07c>21, 定时查找超时订单</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_22-核实订单状态" class="sidebar-link reco-side-_22-核实订单状态" data-v-b57cc07c>22, 核实订单状态</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_23-关闭订单" class="sidebar-link reco-side-_23-关闭订单" data-v-b57cc07c>23, 关闭订单</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_24-调用微信支付的关单接口" class="sidebar-link reco-side-_24-调用微信支付的关单接口" data-v-b57cc07c>24, 调用微信支付的关单接口</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_25-退款单" class="sidebar-link reco-side-_25-退款单" data-v-b57cc07c>25, 退款单</a></li><li class="level-3" data-v-b57cc07c><a href="/javablog/public/blogs/zhifu/weixin/weixin.html#_26-退款结果通知" class="sidebar-link reco-side-_26-退款结果通知" data-v-b57cc07c>26, 退款结果通知</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/javablog/public/assets/js/app.e7970ae7.js" defer></script><script src="/javablog/public/assets/js/91.b7a84495.js" defer></script><script src="/javablog/public/assets/js/1.8cfd729d.js" defer></script><script src="/javablog/public/assets/js/16.dece7035.js" defer></script>
  </body>
</html>
